<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WonderPasNavi - ãƒ«ãƒ¼ãƒˆã‚’æ±ºã‚ã‚‹</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFB6C1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #5a5a5a;
            position: relative;
            min-height: 100vh;
            padding: 20px;
        }

        /* ãƒã‚§ãƒƒã‚¯æŸ„ã®èƒŒæ™¯ */
        body.checkerboard {
            background-color: #FFE4E1;
        }

        body.checkerboard::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 200%;
            height: 200%;
            background-image: 
                /* ç´°ã„æ–œã‚ã®ç·šï¼ˆè–„ã„ãƒ”ãƒ³ã‚¯ã¨ãƒ‘ãƒ¼ãƒ—ãƒ«ï¼‰- 1pxå¹… */
                repeating-linear-gradient(
                    45deg,
                    transparent 0px,
                    transparent 38px,
                    rgba(255, 182, 193, 0.15) 38px,
                    rgba(255, 182, 193, 0.15) 39px,
                    transparent 39px,
                    transparent 78px,
                    rgba(221, 160, 221, 0.15) 78px,
                    rgba(221, 160, 221, 0.15) 79px,
                    transparent 79px
                ),
                /* ç´°ã„æ–œã‚ã®ç·šï¼ˆåå¯¾æ–¹å‘ï¼‰- 1pxå¹… */
                repeating-linear-gradient(
                    -45deg,
                    transparent 0px,
                    transparent 38px,
                    rgba(255, 182, 193, 0.15) 38px,
                    rgba(255, 182, 193, 0.15) 39px,
                    transparent 39px,
                    transparent 78px,
                    rgba(221, 160, 221, 0.15) 78px,
                    rgba(221, 160, 221, 0.15) 79px,
                    transparent 79px
                ),
                /* å¤ªã„æ–œã‚ã®ãƒãƒ³ãƒ‰ï¼ˆç™½ã¨ãƒ”ãƒ³ã‚¯ï¼‰- 80pxå¹…ã§å¤ªã•ã‚’å¼·èª¿ */
                repeating-linear-gradient(
                    45deg,
                    rgba(255, 255, 255, 0.3) 0px,
                    rgba(255, 255, 255, 0.3) 80px,
                    rgba(255, 228, 225, 0.2) 80px,
                    rgba(255, 228, 225, 0.2) 160px
                ),
                /* å¤ªã„æ–œã‚ã®ãƒãƒ³ãƒ‰ï¼ˆåå¯¾æ–¹å‘ï¼‰- 80pxå¹…ã§å¤ªã•ã‚’å¼·èª¿ */
                repeating-linear-gradient(
                    -45deg,
                    rgba(255, 255, 255, 0.3) 0px,
                    rgba(255, 255, 255, 0.3) 80px,
                    rgba(255, 228, 225, 0.2) 80px,
                    rgba(255, 228, 225, 0.2) 160px
                );
            z-index: -1;
            transform: translate(-25%, -25%);
        }

        /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®èƒŒæ™¯ */
        body.gradient {
            background: linear-gradient(135deg, #FFB6C1 0%, #B0E0E6 50%, #DDA0DD 100%);
        }

        body.gradient::before {
            display: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        /* ãƒã‚§ãƒƒã‚¯æŸ„èƒŒæ™¯ã®æ™‚ã®ãƒ˜ãƒƒãƒ€ãƒ¼ */
        body.checkerboard header {
            color: #C71585;
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.8);
        }

        /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã®æ™‚ã®ãƒ˜ãƒƒãƒ€ãƒ¼ */
        body.gradient header {
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            /* ãƒ•ã‚©ãƒ³ãƒˆã®è§’ã‚’ä¸¸ãã™ã‚‹ */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-feature-settings: "rlig" 1, "calt" 1;
        }

        /* ãƒã‚§ãƒƒã‚¯æŸ„èƒŒæ™¯ã®æ™‚ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã‚¬ãƒ©ã‚¹æ„Ÿï¼‰ */
        body.checkerboard header h1 {
            color: #E91E63;
            /* ã‚¬ãƒ©ã‚¹æ„Ÿã®è£…é£¾ - æ–‡å­—ãã®ã‚‚ã®ã«é©ç”¨ï¼ˆè–„ãï¼‰ */
            background: linear-gradient(135deg, rgba(233, 30, 99, 0.7) 0%, rgba(233, 30, 99, 0.5) 50%, rgba(233, 30, 99, 0.7) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            /* æ–‡å­—ã®ãµã¡ã‚’ä¸¸ãã™ã‚‹ - è¤‡æ•°ã®text-shadowã§è§’ã‚’ä¸¸ã */
            text-shadow: 
                /* è§’ã‚’ä¸¸ãã™ã‚‹ãŸã‚ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯åŠ¹æœ */
                0.5px 0.5px 0 rgba(255, 182, 193, 0.3),
                -0.5px 0.5px 0 rgba(255, 182, 193, 0.3),
                0.5px -0.5px 0 rgba(255, 182, 193, 0.3),
                -0.5px -0.5px 0 rgba(255, 182, 193, 0.3),
                1px 1px 0 rgba(255, 182, 193, 0.2),
                -1px 1px 0 rgba(255, 182, 193, 0.2),
                1px -1px 0 rgba(255, 182, 193, 0.2),
                -1px -1px 0 rgba(255, 182, 193, 0.2),
                /* ã‚¬ãƒ©ã‚¹æ„Ÿã®å…‰æ²¢ */
                0 0 30px rgba(255, 182, 193, 0.4),
                0 2px 8px rgba(255, 255, 255, 0.6),
                0 0 60px rgba(255, 182, 193, 0.2),
                inset 0 1px 2px rgba(255, 255, 255, 0.8);
            filter: drop-shadow(0 2px 6px rgba(255, 182, 193, 0.5)) 
                    drop-shadow(0 0 20px rgba(255, 182, 193, 0.3));
            backdrop-filter: blur(10px);
        }

        /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã®æ™‚ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰ */
        body.gradient header h1 {
            color: #fff;
            text-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.2),
                0 0 20px rgba(255, 255, 255, 0.3);
            background: none;
            -webkit-text-fill-color: #fff;
        }

        /* ãƒã‚§ãƒƒã‚¯æŸ„èƒŒæ™¯ã®æ™‚ã®ã‚¿ã‚¤ãƒˆãƒ«ã®å…‰ã®åå°„ */
        body.checkerboard header h1::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.3) 100%);
            border-radius: 8px;
            filter: blur(8px);
            z-index: -1;
            opacity: 0.6;
        }

        /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã®æ™‚ã¯::beforeã‚’éè¡¨ç¤º */
        body.gradient header h1::before {
            display: none;
        }


        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* ä»Šæ—¥ã®å¾…ã¡æ™‚é–“ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .waiting-time-link {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #FF6B9D 0%, #C44569 100%);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
            transition: all 0.3s ease;
        }

        .waiting-time-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 157, 0.6);
            background: linear-gradient(135deg, #FF8FA3 0%, #D65A7A 100%);
        }

        .waiting-time-link:active {
            transform: translateY(0);
        }

        /* ãƒã‚§ãƒƒã‚¯æŸ„èƒŒæ™¯ã®æ™‚ã®ãƒªãƒ³ã‚¯ */
        body.checkerboard .waiting-time-link {
            background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%);
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.5);
        }

        body.checkerboard .waiting-time-link:hover {
            box-shadow: 0 6px 20px rgba(233, 30, 99, 0.7);
            background: linear-gradient(135deg, #F06292 0%, #D81B60 100%);
        }

        /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã®æ™‚ã®ãƒªãƒ³ã‚¯ */
        body.gradient .waiting-time-link {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.2) 100%);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        body.gradient .waiting-time-link:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.3) 100%);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* ãƒã‚§ãƒƒã‚¯æŸ„èƒŒæ™¯ã®æ™‚ã®ãƒ˜ãƒƒãƒ€ãƒ¼p */
        body.checkerboard header p {
            color: #C71585;
        }

        /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã®æ™‚ã®ãƒ˜ãƒƒãƒ€ãƒ¼p */
        body.gradient header p {
            color: #fff;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .main-content.no-map {
            grid-template-columns: 1fr;
        }

        .park-map {
            background: white;
            border-radius: 20px;
            height: 600px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.8);
            display: none;
        }

        .park-map.visible {
            display: block;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
            backdrop-filter: blur(10px);
        }

        .section {
            padding: 15px;
            background: linear-gradient(135deg, #FFFACD 0%, #F0E68C 100%);
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .section h3 {
            color: #DDA0DD;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: bold;
        }

        /* ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ */
        .attraction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            grid-auto-rows: 1fr; /* ã™ã¹ã¦ã®è¡Œã®é«˜ã•ã‚’çµ±ä¸€ */
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
        }

        .attraction-card {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.8);
            text-align: center;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            height: 100%; /* ã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ«ã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .attraction-card.theater {
            background: linear-gradient(135deg, #DDA0DD 0%, #EE82EE 100%);
        }

        .attraction-card.walking {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%);
        }

        .attraction-card.greeting {
            background: linear-gradient(135deg, #FFE4B5 0%, #FFD700 100%);
        }

        .attraction-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .attraction-card:not(.theater):not(.walking):not(.greeting):hover {
            background: linear-gradient(135deg, #FFC0CB 0%, #FFB6C1 100%);
        }

        .attraction-card.theater:hover {
            background: linear-gradient(135deg, #EE82EE 0%, #DDA0DD 100%);
        }

        .attraction-card.walking:hover {
            background: linear-gradient(135deg, #FFC0CB 0%, #FFB6C1 100%);
        }

        .attraction-card.greeting:hover {
            background: linear-gradient(135deg, #FFD700 0%, #FFE4B5 100%);
        }

        .attraction-card.selected {
            border-color: #DDA0DD;
            box-shadow: 0 4px 12px rgba(221, 160, 221, 0.4);
        }

        /* å„ªå…ˆåº¦ã«å¿œã˜ãŸæ°´è‰²ã®æ¿ƒã• */
        .attraction-card.selected.priority-high {
            background: linear-gradient(135deg, #5F9EA0 0%, #4682B4 100%); /* æ¿ƒã„æ°´è‰² */
        }

        .attraction-card.selected.priority-high .attraction-card-name {
            color: #ffffff; /* ç™½æ–‡å­—ã§è¦‹ã‚„ã™ã */
        }

        .attraction-card.selected.priority-medium {
            background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%); /* ä¸­ç¨‹åº¦ã®æ°´è‰² */
        }

        .attraction-card.selected.priority-low {
            background: linear-gradient(135deg, #E0F6FF 0%, #F0F8FF 100%); /* è–„ã„æ°´è‰² */
        }

        /* ã‚·ã‚¢ã‚¿ãƒ¼å‹ã‚‚é€šå¸¸ã®å„ªå…ˆåº¦ã«å¿œã˜ãŸæ°´è‰²ã‚’ä½¿ç”¨ */
        .attraction-card.selected.theater.priority-high {
            background: linear-gradient(135deg, #5F9EA0 0%, #4682B4 100%); /* æ¿ƒã„æ°´è‰² */
        }

        .attraction-card.selected.theater.priority-high .attraction-card-name {
            color: #ffffff; /* ç™½æ–‡å­—ã§è¦‹ã‚„ã™ã */
        }

        .attraction-card.selected.theater.priority-medium {
            background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%); /* ä¸­ç¨‹åº¦ã®æ°´è‰² */
        }

        .attraction-card.selected.theater.priority-low {
            background: linear-gradient(135deg, #E0F6FF 0%, #F0F8FF 100%); /* è–„ã„æ°´è‰² */
        }

        .attraction-card.selected.walking.priority-high {
            background: linear-gradient(135deg, #5F9EA0 0%, #4682B4 100%);
        }

        .attraction-card.selected.walking.priority-high .attraction-card-name {
            color: #ffffff; /* ç™½æ–‡å­—ã§è¦‹ã‚„ã™ã */
        }

        .attraction-card.selected.walking.priority-medium {
            background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
        }

        .attraction-card.selected.walking.priority-low {
            background: linear-gradient(135deg, #E0F6FF 0%, #F0F8FF 100%);
        }

        .attraction-card-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: #5a5a5a;
            line-height: 1.3;
            word-break: break-word;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        /* 21å­—ä»¥ä¸Šã®å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
        .attraction-card-name.long-text {
            font-size: 0.7rem;
        }

        .attraction-icon {
            font-size: 1rem;
        }

        .icon-annotation-link {
            display: block;
            margin-top: 12px;
            text-align: center;
            font-size: 0.85rem;
            color: #5a5a5a;
            text-decoration: underline;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .icon-annotation-link:hover {
            color: #C71585;
        }

        .icon-annotation-list {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            font-size: 0.85rem;
            color: #5a5a5a;
            display: none;
        }

        .icon-annotation-list.show {
            display: block;
        }

        .icon-annotation-item {
            margin-bottom: 6px;
            padding: 4px 0;
        }

        .icon-annotation-item:last-child {
            margin-bottom: 0;
        }

        .priority-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .card-order-number {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #DDA0DD;
            font-size: 0.85rem;
            font-weight: bold;
            color: #5a5a5a;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .priority-high {
            background: #FF69B4;
        }

        .priority-medium {
            background: #DDA0DD;
        }

        .priority-low {
            background: #D3D3D3;
        }

        .priority-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .priority-btn {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            font-weight: 500;
            color: #5a5a5a;
        }

        .priority-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .priority-btn.active {
            background: linear-gradient(135deg, #DDA0DD 0%, #EE82EE 100%);
            color: white;
            border-color: #DDA0DD;
        }

        .btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
        }

        .btn:last-child {
            margin-bottom: 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%);
            color: #5a5a5a;
            box-shadow: 0 4px 12px rgba(255, 182, 193, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 182, 193, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #FFB6C1 0%, #FF69B4 100%);
            color: white;
            font-size: 12px;
            padding: 8px 12px;
        }

        input[type="text"],
        input[type="time"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 10px;
            transition: border-color 0.3s;
            background: rgba(255, 255, 255, 0.8);
        }

        input[type="text"]:focus,
        input[type="time"]:focus,
        select:focus {
            outline: none;
            border-color: #DDA0DD;
            box-shadow: 0 0 0 3px rgba(221, 160, 221, 0.2);
        }

        .time-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .time-input-group label {
            font-size: 0.9rem;
            color: #5a5a5a;
            white-space: nowrap;
        }

        .time-input-group input {
            flex: 1;
            margin-bottom: 0;
        }

        .exit-option-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .exit-option-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            font-weight: 500;
            color: #5a5a5a;
            text-align: center;
        }

        .exit-option-btn:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .exit-option-btn.active {
            background: linear-gradient(135deg, #DDA0DD 0%, #EE82EE 100%);
            color: white;
            border-color: #DDA0DD;
        }

        #exitTimeInput.hidden {
            display: none;
        }

        #exitTimeInput.visible {
            display: block;
        }

        .list-container {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #FFFACD 0%, #F0E68C 100%);
            border-radius: 10px;
            border-left: 4px solid #DDA0DD;
            font-size: 13px;
        }

        .list-item-name {
            font-weight: 500;
            flex: 1;
            color: #5a5a5a;
        }

        .list-item-delete {
            background: #FFB6C1;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .list-item-delete:hover {
            background: #FF69B4;
        }

        .result-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            backdrop-filter: blur(10px);
        }

        .result-box h2 {
            color: #DDA0DD;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .route-list {
            list-style: none;
        }

        .route-list li {
            padding: 12px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #FFFACD 0%, #F0E68C 100%);
            border-left: 4px solid #DDA0DD;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: move;
            position: relative;
        }

        .route-list li.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .route-list li.break-item {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-left: 4px solid #2196F3;
            cursor: move;
        }

        .sortable-placeholder {
            background: rgba(221, 160, 221, 0.3) !important;
            border: 2px dashed #DDA0DD !important;
            border-radius: 10px;
            margin-bottom: 8px;
            height: 60px;
        }

        .route-list li.ui-sortable-helper {
            opacity: 0.8;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .drop-zone {
            height: 20px;
            margin: 4px 0;
            border: 2px dashed #DDA0DD;
            border-radius: 5px;
            background: rgba(221, 160, 221, 0.1);
            display: none;
            align-items: center;
            justify-content: center;
            color: #DDA0DD;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .drop-zone.drag-over {
            background: rgba(221, 160, 221, 0.3);
            border-color: #EE82EE;
            height: 40px;
        }

        .drop-zone.show {
            display: flex;
        }

        .break-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .break-duration-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #DDA0DD;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        .break-remove-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 4px 8px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .break-remove-btn:hover {
            background: #d32f2f;
        }

        .route-index {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%);
            color: #5a5a5a;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        /* è¨­å®šãƒ‘ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .settings-panel:not(.hidden) {
            display: flex;
        }

        .settings-panel.hidden {
            display: none !important;
        }

        .settings-content {
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            padding: 20px;
            border-bottom: 2px solid #DDA0DD;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%);
            border-radius: 20px 20px 0 0;
        }

        .settings-header h2 {
            margin: 0;
            color: #5a5a5a;
        }

        .settings-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #5a5a5a;
            line-height: 1;
        }

        .settings-body {
            padding: 20px;
        }

        .settings-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .settings-field label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .settings-field select {
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚¹ã‚¿ã‚¤ãƒ« */
        .custom-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }

        .custom-dialog.show {
            display: flex;
        }

        .custom-dialog-content {
            background: white;
            border-radius: 20px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .custom-dialog-header {
            padding: 20px;
            border-bottom: 2px solid #DDA0DD;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%);
            border-radius: 20px 20px 0 0;
        }

        .custom-dialog-header h3 {
            margin: 0;
            color: #5a5a5a;
            font-size: 1.2rem;
        }

        .custom-dialog-body {
            padding: 20px;
            color: #5a5a5a;
            white-space: pre-line;
            line-height: 1.6;
        }

        .custom-dialog-footer {
            padding: 15px 20px;
            border-top: 2px solid #f0f0f0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .custom-dialog-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }

        .custom-dialog-btn-primary {
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%);
            color: #5a5a5a;
        }

        .custom-dialog-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 182, 193, 0.4);
        }

        .custom-dialog-btn-secondary {
            background: #f0f0f0;
            color: #5a5a5a;
        }

        .custom-dialog-btn-secondary:hover {
            background: #e0e0e0;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .attraction-grid::-webkit-scrollbar,
        .list-container::-webkit-scrollbar {
            width: 8px;
        }

        .attraction-grid::-webkit-scrollbar-track,
        .list-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        .attraction-grid::-webkit-scrollbar-thumb,
        .list-container::-webkit-scrollbar-thumb {
            background: #DDA0DD;
            border-radius: 10px;
        }

        .attraction-grid::-webkit-scrollbar-thumb:hover,
        .list-container::-webkit-scrollbar-thumb:hover {
            background: #EE82EE;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .park-map {
                height: 400px;
            }

            .attraction-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
    <body class="checkerboard">
    <div class="container">
        <header>
            <div style="background: rgba(255, 193, 7, 0.2); border: 2px solid #FFC107; border-radius: 8px; padding: 8px 16px; margin-bottom: 15px; text-align: center;">
                <strong style="color: #FF6F00;" data-i18n="demo-site">âš ï¸ ãƒ‡ãƒ¢ã‚µã‚¤ãƒˆ</strong>
                <span style="color: #666; font-size: 0.9rem; margin-left: 8px;" data-i18n="demo-description">ã“ã®ã‚µã‚¤ãƒˆã¯ãƒ‡ãƒ¢ç‰ˆã§ã™</span>
            </div>
            <div id="languageLinks" style="text-align: right; margin-bottom: 10px;">
                <a href="#" onclick="event.preventDefault(); setLanguage('ja'); return false;" data-lang="ja" style="margin: 0 5px; color: #5a5a5a; text-decoration: none;">æ—¥æœ¬èª</a>
                <a href="#" onclick="event.preventDefault(); setLanguage('zh'); return false;" data-lang="zh" style="margin: 0 5px; color: #5a5a5a; text-decoration: none;">ä¸­æ–‡</a>
                <a href="#" onclick="event.preventDefault(); setLanguage('en'); return false;" data-lang="en" style="margin: 0 5px; color: #5a5a5a; text-decoration: none;">English</a>
                <a href="#" onclick="event.preventDefault(); setLanguage('ko'); return false;" data-lang="ko" style="margin: 0 5px; color: #5a5a5a; text-decoration: none;">í•œêµ­ì–´</a>
            </div>
            <h1 data-i18n="title">WonderPasNavi - ãƒ«ãƒ¼ãƒˆã‚’æ±ºã‚ã‚‹</h1>
            <p data-i18n="subtitle">ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸ã‚“ã§ã€åŠ¹ç‡çš„ã«å·¡ã‚‹ãƒ«ãƒ¼ãƒˆã‚’æ±ºã‚ã¾ã—ã‚‡ã†</p>
            <a href="waiting-dashboard.html" class="waiting-time-link" data-i18n="today-waiting-times">ğŸ“Š ä»Šæ—¥ã®å¾…ã¡æ™‚é–“</a>
        </header>

        <div class="main-content no-map">
            <div class="park-map">
                <div id="map"></div>
            </div>

            <div class="control-panel">
                <div class="section">
                    <h3 data-i18n="attraction-selection">ğŸ¢ ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³é¸æŠ</h3>
                    <div class="priority-selector">
                        <button class="priority-btn active" data-priority="high" onclick="setPriority('high')" data-i18n="priority-high">é«˜</button>
                        <button class="priority-btn" data-priority="medium" onclick="setPriority('medium')" data-i18n="priority-medium">ä¸­</button>
                        <button class="priority-btn" data-priority="low" onclick="setPriority('low')" data-i18n="priority-low">ä½</button>
                    </div>
                    <div class="attraction-grid" id="attractionGrid"></div>
                    <a href="#" class="icon-annotation-link" id="iconAnnotationLink" onclick="event.preventDefault(); toggleIconAnnotations(); return false;" data-i18n="view-annotations">æ³¨é‡ˆã‚’è¦‹ã‚‹</a>
                    <div class="icon-annotation-list" id="iconAnnotationList"></div>
                </div>

                <div class="section">
                    <h3 data-i18n="selected-attractions">ğŸ“‹ é¸æŠæ¸ˆã¿ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³</h3>
                    <div class="list-container" id="attractionList"></div>
                </div>

                <div class="section">
                    <h3 data-i18n="time-settings">â° æ™‚é–“è¨­å®š</h3>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 8px; font-size: 0.9rem; color: #5a5a5a;" data-i18n="start-time">é–‹å§‹æ™‚åˆ»:</label>
                            <input type="time" id="startTime" value="09:00" min="08:00" max="21:00" style="width: 60%; padding: 10px; border: 2px solid rgba(255, 255, 255, 0.8); border-radius: 10px; font-size: 14px; background: rgba(255, 255, 255, 0.8);" onchange="validateStartTime()">
                        </div>
                        <div style="flex: 1; margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 0.9rem; color: #5a5a5a;" data-i18n="exit-time">é€€åœ’æ™‚åˆ»:</label>
                            <div class="exit-option-group">
                                <button class="exit-option-btn active" onclick="setExitOption('until', this)" data-i18n="until-closing">é–‰åœ’ã¾ã§</button>
                                <button class="exit-option-btn" onclick="setExitOption('time', this)" data-i18n="specify-time">æ™‚åˆ»æŒ‡å®š</button>
                            </div>
                            <input type="time" id="exitTimeInput" value="21:00" min="08:00" max="21:00" class="hidden" onchange="validateExitTime()">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 data-i18n="optimize-route">ğŸ›£ï¸ ãƒ«ãƒ¼ãƒˆã‚’æ±ºã‚ã‚‹</h3>
                    <button class="btn btn-primary" onclick="optimizeRoute()" data-i18n="optimize-button">ğŸ›£ï¸ ãƒ«ãƒ¼ãƒˆã‚’æ±ºã‚ã‚‹</button>
                    <button class="btn btn-danger" onclick="clearRoute()" data-i18n="clear-button">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
                </div>

                <div class="section">
                    <h3 data-i18n="settings">âš™ï¸ è¨­å®š</h3>
                    <button class="btn btn-primary" onclick="openSettings()" style="margin-bottom: 8px;" data-i18n="display-settings">âš™ï¸ è¡¨ç¤ºè¨­å®š</button>
                    <a href="master-maintenance.html" style="display: block; text-align: center; padding: 10px; background: linear-gradient(135deg, #DDA0DD 0%, #EE82EE 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: bold; margin-bottom: 8px;" data-i18n="edit-attraction-info">ğŸ“ ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ç·¨é›†</a>
                    <p style="font-size: 0.8rem; color: #999; text-align: center; margin: 0;" data-i18n="edit-description">æ‰€è¦æ™‚é–“ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ã‚’ç·¨é›†ã§ãã¾ã™</p>
                </div>
            </div>
        </div>

        <!-- è¨­å®šãƒ‘ãƒãƒ« -->
        <div id="settingsPanel" class="settings-panel hidden">
            <div class="settings-content">
                <div class="settings-header">
                    <h2 data-i18n="display-settings">âš™ï¸ è¡¨ç¤ºè¨­å®š</h2>
                    <button class="settings-close" onclick="closeSettings()">&times;</button>
                </div>
                <div class="settings-body">
                    <div class="settings-field">
                        <label data-i18n="background-style">èƒŒæ™¯ã‚¹ã‚¿ã‚¤ãƒ«</label>
                        <select id="backgroundStyleSelect" onchange="updateBackgroundStyle()">
                            <option value="checkerboard" data-i18n="checkerboard">ãƒã‚§ãƒƒã‚¯æŸ„</option>
                            <option value="gradient" data-i18n="gradient">ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label data-i18n="result-title">çµæœã®ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <select id="resultTitleSelect" onchange="updateResultTitle()">
                            <option value="ã¾ã‚ã‚‹ã˜ã‚…ã‚“ã°ã‚“" data-i18n="title-option-1">ã¾ã‚ã‚‹ã˜ã‚…ã‚“ã°ã‚“</option>
                            <option value="ãŠã™ã™ã‚ã®ãƒ«ãƒ¼ãƒˆ" data-i18n="title-option-2">ãŠã™ã™ã‚ã®ãƒ«ãƒ¼ãƒˆ</option>
                            <option value="ã“ã‚“ãªãƒ«ãƒ¼ãƒˆã¯ã©ã†ï¼Ÿ" data-i18n="title-option-3">ã“ã‚“ãªãƒ«ãƒ¼ãƒˆã¯ã©ã†ï¼Ÿ</option>
                            <option value="ã¾ã‚ã‚‹ã˜ã‚…ã‚“" data-i18n="title-option-4">ã¾ã‚ã‚‹ã˜ã‚…ã‚“</option>
                            <option value="ãƒ«ãƒ¼ãƒˆæ¡ˆ" data-i18n="title-option-5">ãƒ«ãƒ¼ãƒˆæ¡ˆ</option>
                            <option value="ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆ" data-i18n="title-option-6">ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆ</option>
                            <option value="å›ã‚‹é †ç•ª" data-i18n="title-option-7">å›ã‚‹é †ç•ª</option>
                            <option value="ãƒ«ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³" data-i18n="title-option-8">ãƒ«ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³</option>
                        </select>
                    </div>
                    <div class="settings-field">
                        <label data-i18n="route-optimization-method">ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–æ–¹æ³•</label>
                        <select id="routeOptimizationSelect" onchange="updateRouteOptimization()">
                            <option value="distance" data-i18n="optimize-by-distance">è·é›¢æœ€çŸ­</option>
                            <option value="time" data-i18n="optimize-by-time">æ™‚é–“æœ€çŸ­</option>
                            <option value="selection-order" data-i18n="optimize-by-selection-order">é¸æŠé †</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
        <div id="customDialog" class="custom-dialog">
            <div class="custom-dialog-content">
                <div class="custom-dialog-header">
                    <h3 id="customDialogTitle">ç¢ºèª</h3>
                </div>
                <div class="custom-dialog-body" id="customDialogMessage"></div>
                <div class="custom-dialog-footer">
                    <button class="custom-dialog-btn custom-dialog-btn-secondary" id="customDialogCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="custom-dialog-btn custom-dialog-btn-secondary" id="customDialogRecreateBtn">ä½å„ªå…ˆåº¦ã®ã‚‚ã®ã‚’å‰Šé™¤ã—å†ä½œæˆ</button>
                    <button class="custom-dialog-btn custom-dialog-btn-primary" id="customDialogConfirmBtn">ãã®ã¾ã¾è¡¨ç¤º</button>
                </div>
            </div>
        </div>

        <div id="resultBox" class="result-box hidden">
            <h2 id="resultTitle">ğŸ“Š ã¾ã‚ã‚‹ã˜ã‚…ã‚“ã°ã‚“</h2>
            <div style="margin-bottom: 15px;">
                <p><strong data-i18n="total-distance">ç·ç§»å‹•è·é›¢:</strong> <span id="totalDistance">0</span> m</p>
                <p><strong data-i18n="route-points">ãƒ«ãƒ¼ãƒˆä¸Šã®ãƒã‚¤ãƒ³ãƒˆæ•°:</strong> <span id="routeLength">0</span></p>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="downloadMapAsImage()" style="flex: 1; min-width: 150px;" data-i18n="download-map">ğŸ—ºï¸ åœ°å›³ã‚’ç”»åƒã§ä¿å­˜</button>
                <button class="btn btn-primary" onclick="copyRouteToClipboard()" style="flex: 1; min-width: 150px;" data-i18n="copy-route">ğŸ“‹ ãƒ«ãƒ¼ãƒˆé †åºã‚’ã‚³ãƒ”ãƒ¼</button>
                <button class="btn btn-primary" onclick="addBreakAtEnd()" style="flex: 1; min-width: 150px;" data-i18n="add-break">â˜• ä¼‘æ†©ã‚’è¿½åŠ </button>
            </div>
            <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;" data-i18n="drag-instruction">ğŸ’¡ ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †ç•ªã‚’å¤‰æ›´ã§ãã¾ã™ã€‚ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®é–“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¼‘æ†©ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</p>
            <ul class="route-list" id="resultList"></ul>
        </div>

        <!-- Buy Me a Coffee Button -->
        <div id="supportButtonContainer" style="text-align: center; margin-top: 30px; padding: 20px;">
            <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="lira_dev" data-color="#40DCA5" data-emoji="ğŸ¦„" data-font="Bree" data-text="ã“ã“ã‹ã‚‰å¿œæ´ã™ã‚‹" data-outline-color="#000000" data-font-color="#ffffff" data-coffee-color="#FFDD00"></script>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jQuery UI for Sortable -->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/ui-lightness/jquery-ui.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        // å¤šè¨€èªå¯¾å¿œãƒ‡ãƒ¼ã‚¿
        const i18n = {
            ja: {
                'demo-site': 'âš ï¸ ãƒ‡ãƒ¢ã‚µã‚¤ãƒˆ',
                'demo-description': 'ã“ã®ã‚µã‚¤ãƒˆã¯ãƒ‡ãƒ¢ç‰ˆã§ã™',
                'title': 'WonderPasNavi - ãƒ«ãƒ¼ãƒˆã‚’æ±ºã‚ã‚‹',
                'subtitle': 'ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸ã‚“ã§ã€åŠ¹ç‡çš„ã«å·¡ã‚‹ãƒ«ãƒ¼ãƒˆã‚’æ±ºã‚ã¾ã—ã‚‡ã†',
                'today-waiting-times': 'ğŸ“Š ä»Šæ—¥ã®å¾…ã¡æ™‚é–“',
                'attraction-selection': 'ğŸ¢ ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³é¸æŠ',
                'priority-high': 'é«˜',
                'priority-medium': 'ä¸­',
                'priority-low': 'ä½',
                'view-annotations': 'æ³¨é‡ˆã‚’è¦‹ã‚‹',
                'selected-attractions': 'ğŸ“‹ é¸æŠæ¸ˆã¿ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³',
                'time-settings': 'â° æ™‚é–“è¨­å®š',
                'start-time': 'é–‹å§‹æ™‚åˆ»:',
                'exit-time': 'é€€åœ’æ™‚åˆ»:',
                'until-closing': 'é–‰åœ’ã¾ã§',
                'specify-time': 'æ™‚åˆ»æŒ‡å®š',
                'optimize-route': 'ğŸ›£ï¸ ãƒ«ãƒ¼ãƒˆã‚’æ±ºã‚ã‚‹',
                'optimize-button': 'ğŸ›£ï¸ ãƒ«ãƒ¼ãƒˆã‚’æ±ºã‚ã‚‹',
                'clear-button': 'ğŸ—‘ï¸ ã‚¯ãƒªã‚¢',
                'settings': 'âš™ï¸ è¨­å®š',
                'display-settings': 'âš™ï¸ è¡¨ç¤ºè¨­å®š',
                'edit-attraction-info': 'ğŸ“ ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ç·¨é›†',
                'edit-description': 'æ‰€è¦æ™‚é–“ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«ã‚’ç·¨é›†ã§ãã¾ã™',
                'background-style': 'èƒŒæ™¯ã‚¹ã‚¿ã‚¤ãƒ«',
                'checkerboard': 'ãƒã‚§ãƒƒã‚¯æŸ„',
                'gradient': 'ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³',
                'result-title': 'çµæœã®ã‚¿ã‚¤ãƒˆãƒ«',
                'title-option-1': 'ã¾ã‚ã‚‹ã˜ã‚…ã‚“ã°ã‚“',
                'title-option-2': 'ãŠã™ã™ã‚ã®ãƒ«ãƒ¼ãƒˆ',
                'title-option-3': 'ã“ã‚“ãªãƒ«ãƒ¼ãƒˆã¯ã©ã†ï¼Ÿ',
                'title-option-4': 'ã¾ã‚ã‚‹ã˜ã‚…ã‚“',
                'title-option-5': 'ãƒ«ãƒ¼ãƒˆæ¡ˆ',
                'title-option-6': 'ãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆ',
                'title-option-7': 'å›ã‚‹é †ç•ª',
                'title-option-8': 'ãƒ«ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³',
                'total-distance': 'ç·ç§»å‹•è·é›¢:',
                'route-points': 'ãƒ«ãƒ¼ãƒˆä¸Šã®ãƒã‚¤ãƒ³ãƒˆæ•°:',
                'select-attractions': 'ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„',
                'priority': 'å„ªå…ˆåº¦:',
                'delete': 'å‰Šé™¤',
                'travel': 'ç§»å‹•',
                'arrival': 'åˆ°ç€',
                'waiting': 'å¾…ã¡',
                'duration': 'æ‰€è¦',
                'departure': 'å‡ºç™º',
                'minutes': 'åˆ†',
                'at-time': 'æ™‚ç‚¹',
                'support-button': 'ã“ã“ã‹ã‚‰å¿œæ´ã™ã‚‹',
                'download-map': 'ğŸ—ºï¸ åœ°å›³ã‚’ç”»åƒã§ä¿å­˜',
                'copy-route': 'ğŸ“‹ ãƒ«ãƒ¼ãƒˆé †åºã‚’ã‚³ãƒ”ãƒ¼',
                'map-downloaded': 'åœ°å›³ã‚’ç”»åƒã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ',
                'route-copied': 'ãƒ«ãƒ¼ãƒˆé †åºã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ',
                'copy-failed': 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ',
                'closing-time-exceeded': 'âš ï¸ é–‰åœ’æ™‚åˆ»ï¼ˆ{time}ï¼‰ã‚’è¶…ãˆã‚‹ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™:',
                'exit-time-exceeded': 'âš ï¸ ãƒ‘ãƒ¼ã‚¯ã‚’å‡ºã‚‹æ™‚åˆ»ï¼ˆ{time}ï¼‰ã‚’è¶…ãˆã‚‹ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™:',
                'departure-scheduled': 'å‡ºç™ºäºˆå®š',
                'arrival-scheduled': 'åˆ°ç€äºˆå®š',
                'continue-display': 'ã“ã®ã¾ã¾è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚ä½å„ªå…ˆåº¦ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’é™¤å¤–ã—ã¦ãƒ«ãƒ¼ãƒˆã‚’å†ä½œæˆã—ã¾ã™ã‹ï¼Ÿ',
                'recreate-route-confirm': 'ä½å„ªå…ˆåº¦ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’é™¤å¤–ã—ã¦ãƒ«ãƒ¼ãƒˆã‚’å†ä½œæˆã—ã¾ã™ã‹ï¼Ÿ',
                'recreate-route-confirm-title': 'ç¢ºèª',
                'display-as-is': 'ãã®ã¾ã¾è¡¨ç¤º',
                'recreate-route': 'ãƒ«ãƒ¼ãƒˆå†ä½œæˆ',
                'recreate-route-low-priority': 'ä½å„ªå…ˆåº¦ã®ã‚‚ã®ã‚’å‰Šé™¤ã—å†ä½œæˆ',
                'recreate': 'å†ä½œæˆ',
                'cancel': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
                'insufficient-attractions': 'æ™‚é–“ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚é–‰åœ’æ™‚åˆ»å†…ã«å‘¨ã‚Šåˆ‡ã‚Œã‚‹ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚',
                'closing-time-exceeded-warning': 'âš ï¸ é–‰åœ’æ™‚åˆ»è¶…é',
                'route-optimization-method': 'ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–æ–¹æ³•',
                'optimize-by-distance': 'è·é›¢æœ€çŸ­',
                'optimize-by-time': 'æ™‚é–“æœ€çŸ­',
                'optimize-by-selection-order': 'é¸æŠé †',
                'add-break': 'â˜• ä¼‘æ†©ã‚’è¿½åŠ ',
                'break': 'ä¼‘æ†©',
                'drag-instruction': 'ğŸ’¡ ã‚«ãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é †ç•ªã‚’å¤‰æ›´ã§ãã¾ã™ã€‚ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¼‘æ†©ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚'
            },
            zh: {
                'demo-site': 'âš ï¸ æ¼”ç¤ºç½‘ç«™',
                'demo-description': 'æ­¤ç½‘ç«™ä¸ºæ¼”ç¤ºç‰ˆæœ¬',
                'title': 'WonderPasNavi - è·¯çº¿è§„åˆ’',
                'subtitle': 'é€‰æ‹©æ™¯ç‚¹ï¼Œè§„åˆ’é«˜æ•ˆçš„æ¸¸è§ˆè·¯çº¿',
                'today-waiting-times': 'ğŸ“Š ä»Šæ—¥ç­‰å¾…æ—¶é—´',
                'attraction-selection': 'ğŸ¢ é€‰æ‹©æ™¯ç‚¹',
                'priority-high': 'é«˜',
                'priority-medium': 'ä¸­',
                'priority-low': 'ä½',
                'view-annotations': 'æŸ¥çœ‹æ³¨é‡Š',
                'selected-attractions': 'ğŸ“‹ å·²é€‰æ™¯ç‚¹',
                'time-settings': 'â° æ—¶é—´è®¾ç½®',
                'start-time': 'å¼€å§‹æ—¶é—´:',
                'exit-time': 'ç¦»å›­æ—¶é—´:',
                'until-closing': 'é—­å›­å‰',
                'specify-time': 'æŒ‡å®šæ—¶é—´',
                'optimize-route': 'ğŸ›£ï¸ è§„åˆ’è·¯çº¿',
                'optimize-button': 'ğŸ›£ï¸ è§„åˆ’è·¯çº¿',
                'clear-button': 'ğŸ—‘ï¸ æ¸…é™¤',
                'settings': 'âš™ï¸ è®¾ç½®',
                'display-settings': 'âš™ï¸ æ˜¾ç¤ºè®¾ç½®',
                'edit-attraction-info': 'ğŸ“ ç¼–è¾‘æ™¯ç‚¹ä¿¡æ¯',
                'edit-description': 'å¯ä»¥ç¼–è¾‘æ‰€éœ€æ—¶é—´å’Œç±»å‹',
                'background-style': 'èƒŒæ™¯æ ·å¼',
                'checkerboard': 'æ ¼å­å›¾æ¡ˆ',
                'gradient': 'æ¸å˜',
                'result-title': 'ç»“æœæ ‡é¢˜',
                'title-option-1': 'æ¸¸è§ˆé¡ºåº',
                'title-option-2': 'æ¨èè·¯çº¿',
                'title-option-3': 'è¿™æ ·çš„è·¯çº¿æ€ä¹ˆæ ·ï¼Ÿ',
                'title-option-4': 'æ¸¸è§ˆé¡ºåº',
                'title-option-5': 'è·¯çº¿æ–¹æ¡ˆ',
                'title-option-6': 'æ¨èè·¯çº¿',
                'title-option-7': 'æ¸¸è§ˆé¡ºåº',
                'title-option-8': 'è·¯çº¿è®¡åˆ’',
                'total-distance': 'æ€»ç§»åŠ¨è·ç¦»:',
                'route-points': 'è·¯çº¿ä¸Šçš„æ™¯ç‚¹æ•°:',
                'select-attractions': 'è¯·é€‰æ‹©æ™¯ç‚¹',
                'priority': 'ä¼˜å…ˆçº§:',
                'delete': 'åˆ é™¤',
                'travel': 'ç§»åŠ¨',
                'arrival': 'åˆ°è¾¾',
                'waiting': 'ç­‰å¾…',
                'duration': 'æ‰€éœ€',
                'departure': 'å‡ºå‘',
                'minutes': 'åˆ†é’Ÿ',
                'at-time': 'æ—¶ç‚¹',
                'support-button': 'æ”¯æŒè¿™ä¸ªåˆ›ä½œè€…',
                'download-map': 'ğŸ—ºï¸ ä¿å­˜åœ°å›¾ä¸ºå›¾ç‰‡',
                'copy-route': 'ğŸ“‹ å¤åˆ¶è·¯çº¿é¡ºåº',
                'map-downloaded': 'åœ°å›¾å·²ä¿å­˜ä¸ºå›¾ç‰‡',
                'route-copied': 'è·¯çº¿é¡ºåºå·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
                'copy-failed': 'å¤åˆ¶å¤±è´¥',
                'closing-time-exceeded': 'âš ï¸ æœ‰è¶…è¿‡é—­å›­æ—¶é—´ï¼ˆ{time}ï¼‰çš„æ™¯ç‚¹:',
                'exit-time-exceeded': 'âš ï¸ æœ‰è¶…è¿‡å‡ºå›­æ—¶é—´ï¼ˆ{time}ï¼‰çš„æ™¯ç‚¹:',
                'departure-scheduled': 'é¢„è®¡å‡ºå‘',
                'arrival-scheduled': 'é¢„è®¡åˆ°è¾¾',
                'continue-display': 'æ˜¯å¦ç»§ç»­æ˜¾ç¤ºï¼Ÿè¿˜æ˜¯æ’é™¤ä½ä¼˜å…ˆçº§æ™¯ç‚¹é‡æ–°è§„åˆ’è·¯çº¿ï¼Ÿ',
                'recreate-route-confirm': 'æ˜¯å¦æ’é™¤ä½ä¼˜å…ˆçº§æ™¯ç‚¹é‡æ–°è§„åˆ’è·¯çº¿ï¼Ÿ',
                'recreate-route-confirm-title': 'ç¡®è®¤',
                'display-as-is': 'ç»§ç»­æ˜¾ç¤º',
                'recreate-route': 'é‡æ–°è§„åˆ’è·¯çº¿',
                'recreate-route-low-priority': 'åˆ é™¤ä½ä¼˜å…ˆçº§æ™¯ç‚¹å¹¶é‡æ–°è§„åˆ’',
                'recreate': 'é‡æ–°è§„åˆ’',
                'cancel': 'å–æ¶ˆ',
                'insufficient-attractions': 'æ—¶é—´ä¸è¶³ã€‚è¯·é€‰æ‹©èƒ½åœ¨é—­å›­æ—¶é—´å†…æ¸¸è§ˆå®Œçš„æ™¯ç‚¹ã€‚',
                'closing-time-exceeded-warning': 'âš ï¸ è¶…è¿‡é—­å›­æ—¶é—´',
                'route-optimization-method': 'è·¯çº¿ä¼˜åŒ–æ–¹æ³•',
                'optimize-by-distance': 'è·ç¦»æœ€çŸ­',
                'optimize-by-time': 'æ—¶é—´æœ€çŸ­',
                'optimize-by-selection-order': 'é€‰æ‹©é¡ºåº',
                'add-break': 'æ·»åŠ ä¼‘æ¯',
                'break': 'ä¼‘æ¯',
                'drag-instruction': 'ğŸ’¡ å¯ä»¥æ‹–åŠ¨å¡ç‰‡æ›´æ”¹é¡ºåºã€‚ä¹Ÿå¯ä»¥åŒå‡»åˆ—è¡¨é¡¹æ·»åŠ ä¼‘æ¯ã€‚'
            },
            en: {
                'demo-site': 'âš ï¸ Demo Site',
                'demo-description': 'This site is a demo version',
                'title': 'WonderPasNavi - Route Planner',
                'subtitle': 'Select attractions and plan an efficient route',
                'today-waiting-times': 'ğŸ“Š Today\'s Wait Times',
                'attraction-selection': 'ğŸ¢ Select Attractions',
                'priority-high': 'High',
                'priority-medium': 'Medium',
                'priority-low': 'Low',
                'view-annotations': 'View Annotations',
                'selected-attractions': 'ğŸ“‹ Selected Attractions',
                'time-settings': 'â° Time Settings',
                'start-time': 'Start Time:',
                'exit-time': 'Exit Time:',
                'until-closing': 'Until Closing',
                'specify-time': 'Specify Time',
                'optimize-route': 'ğŸ›£ï¸ Plan Route',
                'optimize-button': 'ğŸ›£ï¸ Plan Route',
                'clear-button': 'ğŸ—‘ï¸ Clear',
                'settings': 'âš™ï¸ Settings',
                'display-settings': 'âš™ï¸ Display Settings',
                'edit-attraction-info': 'ğŸ“ Edit Attraction Info',
                'edit-description': 'You can edit duration and genre',
                'background-style': 'Background Style',
                'checkerboard': 'Checkerboard',
                'gradient': 'Gradient',
                'result-title': 'Result Title',
                'title-option-1': 'Visit Order',
                'title-option-2': 'Recommended Route',
                'title-option-3': 'How about this route?',
                'title-option-4': 'Visit Order',
                'title-option-5': 'Route Plan',
                'title-option-6': 'Recommended Route',
                'title-option-7': 'Visit Order',
                'title-option-8': 'Route Plan',
                'total-distance': 'Total Distance:',
                'route-points': 'Points on Route:',
                'select-attractions': 'Please select attractions',
                'priority': 'Priority:',
                'delete': 'Delete',
                'travel': 'Travel',
                'arrival': 'Arrival',
                'waiting': 'Wait',
                'duration': 'Duration',
                'departure': 'Departure',
                'minutes': 'min',
                'at-time': 'at',
                'support-button': 'Buy Me a Coffee',
                'download-map': 'ğŸ—ºï¸ Save Map as Image',
                'copy-route': 'ğŸ“‹ Copy Route Order',
                'map-downloaded': 'Map saved as image',
                'route-copied': 'Route order copied to clipboard',
                'copy-failed': 'Copy failed',
                'closing-time-exceeded': 'âš ï¸ There are attractions that exceed closing time ({time}):',
                'exit-time-exceeded': 'âš ï¸ There are attractions that exceed exit time ({time}):',
                'departure-scheduled': 'Scheduled Departure',
                'arrival-scheduled': 'Scheduled Arrival',
                'continue-display': 'Do you want to continue displaying? Or recreate the route by excluding low-priority attractions?',
                'recreate-route-confirm': 'Do you want to recreate the route by excluding low-priority attractions?',
                'recreate-route-confirm-title': 'Confirm',
                'display-as-is': 'Display As Is',
                'recreate-route': 'Recreate Route',
                'recreate-route-low-priority': 'Remove Low Priority and Recreate',
                'recreate': 'Recreate',
                'cancel': 'Cancel',
                'insufficient-attractions': 'Insufficient time. Please select attractions that can be visited within closing time.',
                'closing-time-exceeded-warning': 'âš ï¸ Exceeds Closing Time',
                'route-optimization-method': 'Route Optimization Method',
                'optimize-by-distance': 'Shortest Distance',
                'optimize-by-time': 'Shortest Time',
                'optimize-by-selection-order': 'Selection Order',
                'add-break': 'Add Break',
                'break': 'Break',
                'drag-instruction': 'ğŸ’¡ You can drag cards to change the order. You can also double-click a list item to add a break.'
            },
            ko: {
                'demo-site': 'âš ï¸ ë°ëª¨ ì‚¬ì´íŠ¸',
                'demo-description': 'ì´ ì‚¬ì´íŠ¸ëŠ” ë°ëª¨ ë²„ì „ì…ë‹ˆë‹¤',
                'title': 'WonderPasNavi - ë£¨íŠ¸ ê³„íš',
                'subtitle': 'ì–´íŠ¸ë™ì…˜ì„ ì„ íƒí•˜ê³  íš¨ìœ¨ì ì¸ ë£¨íŠ¸ë¥¼ ê³„íší•˜ì„¸ìš”',
                'today-waiting-times': 'ğŸ“Š ì˜¤ëŠ˜ì˜ ëŒ€ê¸° ì‹œê°„',
                'attraction-selection': 'ğŸ¢ ì–´íŠ¸ë™ì…˜ ì„ íƒ',
                'priority-high': 'ë†’ìŒ',
                'priority-medium': 'ë³´í†µ',
                'priority-low': 'ë‚®ìŒ',
                'view-annotations': 'ì£¼ì„ ë³´ê¸°',
                'selected-attractions': 'ğŸ“‹ ì„ íƒëœ ì–´íŠ¸ë™ì…˜',
                'time-settings': 'â° ì‹œê°„ ì„¤ì •',
                'start-time': 'ì‹œì‘ ì‹œê°„:',
                'exit-time': 'í‡´ì› ì‹œê°„:',
                'until-closing': 'íì›ê¹Œì§€',
                'specify-time': 'ì‹œê°„ ì§€ì •',
                'optimize-route': 'ğŸ›£ï¸ ë£¨íŠ¸ ê³„íš',
                'optimize-button': 'ğŸ›£ï¸ ë£¨íŠ¸ ê³„íš',
                'clear-button': 'ğŸ—‘ï¸ ì§€ìš°ê¸°',
                'settings': 'âš™ï¸ ì„¤ì •',
                'display-settings': 'âš™ï¸ í‘œì‹œ ì„¤ì •',
                'edit-attraction-info': 'ğŸ“ ì–´íŠ¸ë™ì…˜ ì •ë³´ í¸ì§‘',
                'edit-description': 'ì†Œìš” ì‹œê°„ ë° ì¥ë¥´ë¥¼ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤',
                'background-style': 'ë°°ê²½ ìŠ¤íƒ€ì¼',
                'checkerboard': 'ì²´í¬ ë¬´ëŠ¬',
                'gradient': 'ê·¸ë¼ë°ì´ì…˜',
                'result-title': 'ê²°ê³¼ ì œëª©',
                'title-option-1': 'ë°©ë¬¸ ìˆœì„œ',
                'title-option-2': 'ì¶”ì²œ ë£¨íŠ¸',
                'title-option-3': 'ì´ëŸ° ë£¨íŠ¸ëŠ” ì–´ë– ì„¸ìš”?',
                'title-option-4': 'ë°©ë¬¸ ìˆœì„œ',
                'title-option-5': 'ë£¨íŠ¸ ì•ˆ',
                'title-option-6': 'ì¶”ì²œ ë£¨íŠ¸',
                'title-option-7': 'ë°©ë¬¸ ìˆœì„œ',
                'title-option-8': 'ë£¨íŠ¸ ê³„íš',
                'total-distance': 'ì´ ì´ë™ ê±°ë¦¬:',
                'route-points': 'ë£¨íŠ¸ìƒì˜ í¬ì¸íŠ¸ ìˆ˜:',
                'select-attractions': 'ì–´íŠ¸ë™ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”',
                'priority': 'ìš°ì„ ìˆœìœ„:',
                'delete': 'ì‚­ì œ',
                'travel': 'ì´ë™',
                'arrival': 'ë„ì°©',
                'waiting': 'ëŒ€ê¸°',
                'duration': 'ì†Œìš”',
                'departure': 'ì¶œë°œ',
                'minutes': 'ë¶„',
                'at-time': 'ì‹œì ',
                'support-button': 'ì´ í¬ë¦¬ì—ì´í„° í›„ì›í•˜ê¸°',
                'download-map': 'ğŸ—ºï¸ ì§€ë„ë¥¼ ì´ë¯¸ì§€ë¡œ ì €ì¥',
                'copy-route': 'ğŸ“‹ ë£¨íŠ¸ ìˆœì„œ ë³µì‚¬',
                'map-downloaded': 'ì§€ë„ë¥¼ ì´ë¯¸ì§€ë¡œ ì €ì¥í–ˆìŠµë‹ˆë‹¤',
                'route-copied': 'ë£¨íŠ¸ ìˆœì„œë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤',
                'copy-failed': 'ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤',
                'closing-time-exceeded': 'âš ï¸ íì› ì‹œê°„({time})ì„ ì´ˆê³¼í•˜ëŠ” ì–´íŠ¸ë™ì…˜ì´ ìˆìŠµë‹ˆë‹¤:',
                'exit-time-exceeded': 'âš ï¸ íŒŒí¬ë¥¼ ë‚˜ê°€ëŠ” ì‹œê°„({time})ì„ ì´ˆê³¼í•˜ëŠ” ì–´íŠ¸ë™ì…˜ì´ ìˆìŠµë‹ˆë‹¤:',
                'departure-scheduled': 'ì¶œë°œ ì˜ˆì •',
                'arrival-scheduled': 'ë„ì°© ì˜ˆì •',
                'continue-display': 'ê³„ì† í‘œì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì•„ë‹ˆë©´ ë‚®ì€ ìš°ì„ ìˆœìœ„ ì–´íŠ¸ë™ì…˜ì„ ì œì™¸í•˜ê³  ë£¨íŠ¸ë¥¼ ë‹¤ì‹œ ë§Œë“¤ê¹Œìš”?',
                'recreate-route-confirm': 'ë‚®ì€ ìš°ì„ ìˆœìœ„ ì–´íŠ¸ë™ì…˜ì„ ì œì™¸í•˜ê³  ë£¨íŠ¸ë¥¼ ë‹¤ì‹œ ë§Œë“¤ê¹Œìš”?',
                'recreate-route-confirm-title': 'í™•ì¸',
                'display-as-is': 'ê·¸ëŒ€ë¡œ í‘œì‹œ',
                'recreate-route': 'ë£¨íŠ¸ ë‹¤ì‹œ ë§Œë“¤ê¸°',
                'recreate-route-low-priority': 'ë‚®ì€ ìš°ì„ ìˆœìœ„ ì œê±° í›„ ë‹¤ì‹œ ë§Œë“¤ê¸°',
                'recreate': 'ë‹¤ì‹œ ë§Œë“¤ê¸°',
                'cancel': 'ì·¨ì†Œ',
                'insufficient-attractions': 'ì‹œê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. íì› ì‹œê°„ ë‚´ì— ëŒ ìˆ˜ ìˆëŠ” ì–´íŠ¸ë™ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.',
                'closing-time-exceeded-warning': 'âš ï¸ íì› ì‹œê°„ ì´ˆê³¼',
                'route-optimization-method': 'ë£¨íŠ¸ ìµœì í™” ë°©ë²•',
                'optimize-by-distance': 'ê±°ë¦¬ ìµœë‹¨',
                'optimize-by-time': 'ì‹œê°„ ìµœë‹¨',
                'optimize-by-selection-order': 'ì„ íƒ ìˆœì„œ',
                'add-break': 'íœ´ì‹ ì¶”ê°€',
                'break': 'íœ´ì‹',
                'drag-instruction': 'ğŸ’¡ ì¹´ë“œë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª©ë¡ í•­ëª©ì„ ë”ë¸” í´ë¦­í•˜ì—¬ íœ´ì‹ì„ ì¶”ê°€í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.'
            }
        };

        // ç¾åœ¨ã®è¨€èªã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ—¥æœ¬èªï¼‰
        let currentLanguage = localStorage.getItem('language') || 'ja';

        // è¨€èªã‚’è¨­å®šï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹ï¼‰
        window.setLanguage = function(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang;
            applyLanguage();
            updateLanguageLinks();
            // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³åã‚’ç¿»è¨³
            availableAttractions.forEach(attr => {
                attr.translatedName = translateAttractionName(attr.name, lang);
            });
            selectedAttractions.forEach(attr => {
                attr.translatedName = translateAttractionName(attr.name, lang);
            });
            // Buy Me a Coffeeãƒœã‚¿ãƒ³ã‚’æ›´æ–°
            updateSupportButton();
            // ãƒªã‚¹ãƒˆã‚„çµæœã‚‚å†æç”»
            renderAttractionCards();
            updateAttractionList();
            renderMarkers();
            if (document.getElementById('resultBox') && !document.getElementById('resultBox').classList.contains('hidden')) {
                const route = selectedAttractions; // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒˆã‚’å†è¡¨ç¤º
                displayResult(route);
            }
        };

        // Buy Me a Coffeeãƒœã‚¿ãƒ³ã‚’æ›´æ–°ï¼ˆè¨€èªå¤‰æ›´æ™‚ï¼‰
        function updateSupportButton() {
            const container = document.getElementById('supportButtonContainer');
            if (!container) return;
            
            // æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®data-textå±æ€§ã‚’æ›´æ–°
            const existingScript = container.querySelector('script[src*="buymeacoffee"]');
            if (existingScript && i18n[currentLanguage] && i18n[currentLanguage]['support-button']) {
                existingScript.setAttribute('data-text', i18n[currentLanguage]['support-button']);
                // Buy Me a Coffeeã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä¸€åº¦èª­ã¿è¾¼ã¾ã‚Œã‚‹ã¨ã€dataå±æ€§ã®å¤‰æ›´ã ã‘ã§ã¯æ›´æ–°ã•ã‚Œãªã„ãŸã‚ã€
                // ãƒœã‚¿ãƒ³è¦ç´ ã‚’å†ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚‹
                // ãŸã ã—ã€document.write()ã®å•é¡ŒãŒã‚ã‚‹ãŸã‚ã€ã“ã“ã§ã¯dataå±æ€§ã®ã¿æ›´æ–°
            }
        }

        // è¨€èªãƒªãƒ³ã‚¯ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateLanguageLinks() {
            document.querySelectorAll('[data-lang]').forEach(link => {
                if (link.dataset.lang === currentLanguage) {
                    link.style.fontWeight = 'bold';
                    link.style.color = '#C71585';
                } else {
                    link.style.fontWeight = 'normal';
                    link.style.color = '#5a5a5a';
                }
            });
        }

        // è¨€èªã‚’é©ç”¨
        function applyLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (i18n[currentLanguage] && i18n[currentLanguage][key]) {
                    if (element.tagName === 'INPUT' && element.type === 'submit') {
                        element.value = i18n[currentLanguage][key];
                    } else if (element.tagName === 'OPTION') {
                        element.textContent = i18n[currentLanguage][key];
                    } else {
                        element.textContent = i18n[currentLanguage][key];
                    }
                }
            });
            
            // è¨€èªãƒªãƒ³ã‚¯ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
            const langLinks = document.querySelectorAll('[data-lang]');
            langLinks.forEach(link => {
                const lang = link.dataset.lang;
                if (lang === 'ja') {
                    link.textContent = 'æ—¥æœ¬èª';
                } else if (lang === 'zh') {
                    link.textContent = 'ä¸­æ–‡';
                } else if (lang === 'en') {
                    link.textContent = 'English';
                } else if (lang === 'ko') {
                    link.textContent = 'í•œêµ­ì–´';
                }
            });
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let map = null;
        let attractionsMetadata = {}; // Firestoreã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆæ‰€è¦æ™‚é–“ã€ã‚¸ãƒ£ãƒ³ãƒ«ï¼‰
        let selectedAttractions = [];
        let availableAttractions = [];
        let markers = [];
        let routeLayer = null;
        let currentPriority = 'high';
        let exitOption = 'until'; // 'until' or 'time'
        let waitingTimesData = {}; // attr_id -> {waiting_minutes: number, time_series: array}
        let currentRouteData = null; // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆä¼‘æ†©ã‚’å«ã‚€ï¼‰
        let currentRouteStartTime = null; // ãƒ«ãƒ¼ãƒˆã®é–‹å§‹æ™‚åˆ»
        let currentRouteExitTime = null; // ãƒ«ãƒ¼ãƒˆã®é€€åœ’æ™‚åˆ»
        let currentWalkingSpeed = 80; // æ­©è¡Œé€Ÿåº¦ï¼ˆåˆ†é€Ÿ80mï¼‰

        // æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰ã®ä¸­å¿ƒåº§æ¨™
        const DISNEY_LAND_CENTER = [35.6329, 139.8804];

        // ã‚¸ãƒ£ãƒ³ãƒ«ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æƒ…å ±ã‚’å–å¾—
        function getGenreInfo(genreCode) {
            const genreMap = {
                'theater': { genre: 'theater', icon: 'ğŸ›ï¸', duration: 20, isSeated: true, description: 'åº§ã‚Œã‚‹ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå±‹å†…ã‚·ã‚¢ã‚¿ãƒ¼å‹ï¼‰' },
                'ride': { genre: 'ride', icon: 'ğŸ ', duration: 10, isSeated: true, description: 'ãƒ©ã‚¤ãƒ‰' },
                'indoor_ride': { genre: 'ride', icon: 'ğŸ ', duration: 10, isSeated: true, description: 'ãƒ©ã‚¤ãƒ‰' }, // å¾Œæ–¹äº’æ›æ€§
                'outdoor_ride': { genre: 'ride', icon: 'ğŸ ', duration: 10, isSeated: true, description: 'ãƒ©ã‚¤ãƒ‰' }, // å¾Œæ–¹äº’æ›æ€§
                'coaster': { genre: 'coaster', icon: 'ğŸ¢', duration: 3, isSeated: false, description: 'ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼' },
                'water_ride': { genre: 'coaster', icon: 'ğŸ¢', duration: 3, isSeated: false, description: 'ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼' }, // æ€¥æµã™ã¹ã‚Šã‚’ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼ã«çµ±åˆ
                'walking': { genre: 'walking', icon: 'ğŸ°', duration: 10, isSeated: false, description: 'æ­©ã„ã¦æ¢ç´¢ç³»' },
                'other': { genre: 'other', icon: 'ğŸ¡', duration: 5, isSeated: false, description: 'ãã®ä»–' }
            };
            return genreMap[genreCode] || genreMap['other'];
        }

        // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚¸ãƒ£ãƒ³ãƒ«åˆ¤å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        function getAttractionGenre(name) {
            // åº§ã‚Œã‚‹ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå±‹å†…ã‚·ã‚¢ã‚¿ãƒ¼å‹ï¼‰
            const theaterKeywords = ['ã‚·ã‚¢ã‚¿ãƒ¼', 'ã‚·ãƒ§ãƒ¼', 'ãƒ•ã‚£ãƒ«ãƒãƒ¼ãƒã‚¸ãƒƒã‚¯', 'ãƒ›ãƒ¼ãƒ«', 'ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼', 'ãƒã‚­ãƒ«ãƒ¼ãƒ '];
            // ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼ï¼ˆã‚¸ã‚§ãƒƒãƒˆã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼ + æ€¥æµã™ã¹ã‚Šï¼‰
            const coasterKeywords = ['ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼', 'ãƒã‚¦ãƒ³ãƒ†ãƒ³', 'ãƒ“ãƒƒã‚°ã‚µãƒ³ãƒ€ãƒ¼', 'ã‚¹ãƒšãƒ¼ã‚¹ãƒ»ãƒã‚¦ãƒ³ãƒ†ãƒ³', 'ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥', 'æ€¥æµ', 'ã™ã¹ã‚Š'];
            // ãƒ©ã‚¤ãƒ‰ï¼ˆå®¤å†…ãƒ©ã‚¤ãƒ‰ + å±‹å¤–ãƒ©ã‚¤ãƒ‰ï¼‰
            const rideKeywords = ['ãƒ›ãƒ¼ãƒ³ãƒ†ãƒƒãƒ‰ãƒãƒ³ã‚·ãƒ§ãƒ³', 'ãƒ”ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ³', 'ãƒ—ãƒ¼ã•ã‚“', 'ã‚¤ãƒƒãƒ„ãƒ»ã‚¢ãƒ»ã‚¹ãƒ¢ãƒ¼ãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰', 'ãƒ”ãƒã‚­ã‚ª', 'ç™½é›ªå§«', 'ãƒ­ã‚¸ãƒ£ãƒ¼ãƒ©ãƒ“ãƒƒãƒˆ', 'ã‚«ãƒªãƒ–ã®æµ·è³Š', 'ã‚¸ãƒ£ãƒ³ã‚°ãƒ«ã‚¯ãƒ«ãƒ¼ã‚º', 'ã‚¹ã‚¿ãƒ¼ãƒ»ãƒ„ã‚¢ãƒ¼ã‚º', 'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚ºãƒ»ã‚¤ãƒ³ã‚¯', 'ç¾å¥³ã¨é‡ç£', 'ã‚¯ãƒ«ãƒ¼ã‚º', 'é‰„é“', 'ã„ã‹ã ', 'ã‚«ãƒŒãƒ¼', 'ãƒœãƒ¼ãƒˆ', 'ã‚ªãƒ ãƒ‹ãƒã‚¹', 'è’¸æ°—èˆ¹', 'ãƒãƒ¼ã‚¯ãƒˆã‚¦ã‚§ã‚¤ãƒ³', 'ç©ºé£›ã¶ãƒ€ãƒ³ãƒœ', 'ãƒ™ã‚¤ãƒãƒƒã‚¯ã‚¹'];
            // æ­©ã„ã¦æ¢ç´¢ç³»
            const walkingKeywords = ['ãƒ•ã‚§ã‚¢ãƒªãƒ¼ãƒ†ã‚¤ãƒ«', 'å®¶', 'ãƒã‚¦ã‚¹'];
            
            // ãã®ä»–ã«åˆ†é¡ã™ã‚‹ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’å…ˆã«ãƒã‚§ãƒƒã‚¯
            if (name.includes('ã‚°ãƒ¼ãƒ•ã‚£ãƒ¼') && name.includes('ãƒšã‚¤ãƒ³ãƒˆ')) {
                return { genre: 'other', icon: 'ğŸ¡', duration: 5, isSeated: false, description: 'ãã®ä»–' };
            }
            
            // æ­©ã„ã¦æ¢ç´¢ç³»ã‚’å…ˆã«ãƒã‚§ãƒƒã‚¯ï¼ˆã€Œãƒ•ã‚§ã‚¢ãƒªãƒ¼ãƒ†ã‚¤ãƒ«ãƒ»ãƒ›ãƒ¼ãƒ«ã€ãŒã‚·ã‚¢ã‚¿ãƒ¼ã«åˆ†é¡ã•ã‚Œãªã„ã‚ˆã†ã«ï¼‰
            if (walkingKeywords.some(keyword => name.includes(keyword))) {
                return { genre: 'walking', icon: 'ğŸ°', duration: 10, isSeated: false, description: 'æ­©ã„ã¦æ¢ç´¢ç³»' };
            } else if (theaterKeywords.some(keyword => name.includes(keyword))) {
                return { genre: 'theater', icon: 'ğŸ›ï¸', duration: 20, isSeated: true, description: 'åº§ã‚Œã‚‹ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå±‹å†…ã‚·ã‚¢ã‚¿ãƒ¼å‹ï¼‰' };
            } else if (coasterKeywords.some(keyword => name.includes(keyword))) {
                return { genre: 'coaster', icon: 'ğŸ¢', duration: 3, isSeated: false, description: 'ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼' };
            } else if (rideKeywords.some(keyword => name.includes(keyword))) {
                return { genre: 'ride', icon: 'ğŸ ', duration: 10, isSeated: true, description: 'ãƒ©ã‚¤ãƒ‰' };
            }
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            return { genre: 'other', icon: 'ğŸ¡', duration: 5, isSeated: false, description: 'ãã®ä»–' };
        }

        // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ã‚³ãƒ³å–å¾—ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
        function getAttractionIcon(genreOrType) {
            if (typeof genreOrType === 'object' && genreOrType.icon) {
                return genreOrType.icon;
            }
            // æ—§å½¢å¼ã®äº’æ›æ€§
            switch(genreOrType) {
                case 'ride':
                    return 'ğŸ¢';
                case 'theater':
                    return 'ğŸ›ï¸';
                default:
                    return 'ğŸ¡';
            }
        }

        // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³åã‹ã‚‰IDéƒ¨åˆ†ã‚’å‰Šé™¤
        function cleanAttractionName(name) {
            return name.replace(/\s*\(ID:\s*\d+\)/g, '').trim();
        }

        // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³åã®å¤šè¨€èªå¯¾å¿œãƒãƒƒãƒ”ãƒ³ã‚°
        const attractionNames = {
            'ã‚ªãƒ ãƒ‹ãƒã‚¹': { en: 'Omnibus', zh: 'åŒå±‚å·´å£«', ko: 'ì˜´ë‹ˆë²„ìŠ¤' },
            'ã‚«ãƒªãƒ–ã®æµ·è³Š': { en: 'Pirates of the Caribbean', zh: 'åŠ å‹’æ¯”æµ·ç›—', ko: 'ì¹´ë¦¬ë¸Œì˜ í•´ì ' },
            'ã‚¸ãƒ£ãƒ³ã‚°ãƒ«ã‚¯ãƒ«ãƒ¼ã‚ºï¼šãƒ¯ã‚¤ãƒ«ãƒ‰ãƒ©ã‚¤ãƒ•ãƒ»ã‚¨ã‚¯ã‚¹ãƒšãƒ‡ã‚£ã‚·ãƒ§ãƒ³': { en: 'Jungle Cruise: Wildlife Expeditions', zh: 'ä¸›æ—å·¡èˆªï¼šé‡ç”ŸåŠ¨ç‰©æ¢é™©', ko: 'ì •ê¸€ í¬ë£¨ì¦ˆ: ì™€ì¼ë“œë¼ì´í”„ ìµìŠ¤í˜ë””ì…˜' },
            'ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒªãƒãƒ¼é‰„é“': { en: 'Western River Railroad', zh: 'è¥¿éƒ¨æ²¿æ²³é“è·¯', ko: 'ì›¨ìŠ¤í„´ ë¦¬ë²„ ì² ë„' },
            'ã‚¹ã‚¤ã‚¹ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ»ãƒ„ãƒªãƒ¼ãƒã‚¦ã‚¹': { en: 'Swiss Family Treehouse', zh: 'ç‘å£«å®¶åº­æ ‘å±‹', ko: 'ìŠ¤ìœ„ìŠ¤ íŒ¨ë°€ë¦¬ íŠ¸ë¦¬í•˜ìš°ìŠ¤' },
            'é­…æƒ‘ã®ãƒã‚­ãƒ«ãƒ¼ãƒ ': { en: 'Enchanted Tiki Room', zh: 'æåŸºç¥æ®¿', ko: 'ìš”ì • í‹°í‚¤ ë£¸' },
            'ã‚¦ã‚¨ã‚¹ã‚¿ãƒ³ãƒ©ãƒ³ãƒ‰ãƒ»ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚®ãƒ£ãƒ©ãƒªãƒ¼': { en: 'Westernland Shooting Gallery', zh: 'è¥¿éƒ¨ä¹å›­å°„å‡»é¦†', ko: 'ì›¨ìŠ¤í„´ëœë“œ ìŠˆíŒ… ê°¤ëŸ¬ë¦¬' },
            'ã‚«ãƒ³ãƒˆãƒªãƒ¼ãƒ™ã‚¢ãƒ»ã‚·ã‚¢ã‚¿ãƒ¼': { en: 'Country Bear Theater', zh: 'ä¹¡æ‘é¡½ç†Šå‰§åœº', ko: 'ì»¨íŠ¸ë¦¬ ë² ì–´ ì‹œì–´í„°' },
            'è’¸æ°—èˆ¹ãƒãƒ¼ã‚¯ãƒˆã‚¦ã‚§ã‚¤ãƒ³å·': { en: 'Mark Twain Riverboat', zh: 'é©¬å…‹Â·åæ¸©å·è’¸æ±½èˆ¹', ko: 'ì¦ê¸°ì„  ë§ˆí¬ íŠ¸ì›¨ì¸ í˜¸' },
            'ãƒ“ãƒƒã‚°ã‚µãƒ³ãƒ€ãƒ¼ãƒã‚¦ãƒ³ãƒ†ãƒ³': { en: 'Big Thunder Mountain', zh: 'å·¨é›·å±±', ko: 'ë¹… ì¬ë” ë§ˆìš´í‹´' },
            'ãƒˆãƒ ã‚½ãƒ¼ãƒ¤å³¶ã„ã‹ã ': { en: 'Tom Sawyer Island Rafts', zh: 'æ±¤å§†Â·ç´¢äºšå²›æœ¨ç­', ko: 'í†° ì†Œì—¬ ì„¬ ë—ëª©' },
            'ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ãƒã‚¦ãƒ³ãƒ†ãƒ³': { en: 'Splash Mountain', zh: 'é£æº…å±±', ko: 'ìŠ¤í”Œë˜ì‹œ ë§ˆìš´í‹´' },
            'ãƒ“ãƒ¼ãƒãƒ¼ãƒ–ãƒ©ã‚¶ãƒ¼ã‚ºã®ã‚«ãƒŒãƒ¼æ¢é™º': { en: 'Beaver Brothers Explorer Canoes', zh: 'æµ·ç‹¸å…„å¼Ÿç‹¬æœ¨èˆŸå†é™©', ko: 'ë¹„ë²„ ë¸Œë¼ë”ìŠ¤ ì¹´ëˆ„ íƒí—˜' },
            'ãƒ”ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒ³ç©ºã®æ—…': { en: "Peter Pan's Flight", zh: 'å°é£ä¾ å¤©ç©ºä¹‹æ—…', ko: 'í”¼í„°íŒ¬ì˜ í•˜ëŠ˜ ì—¬í–‰' },
            'ç™½é›ªå§«ã¨ä¸ƒäººã®ã“ã³ã¨': { en: 'Snow White\'s Adventures', zh: 'ç™½é›ªå…¬ä¸»å’Œä¸ƒä¸ªå°çŸ®äºº', ko: 'ë°±ì„¤ê³µì£¼ì™€ ì¼ê³± ë‚œìŸì´' },
            'ã‚·ãƒ³ãƒ‡ãƒ¬ãƒ©ã®ãƒ•ã‚§ã‚¢ãƒªãƒ¼ãƒ†ã‚¤ãƒ«ãƒ»ãƒ›ãƒ¼ãƒ«': { en: 'Cinderella\'s Fairy Tale Hall', zh: 'ä»™å±¥å¥‡ç¼˜ç«¥è¯å¤§å…', ko: 'ì‹ ë°ë ë¼ì˜ í˜ì–´ë¦¬í…Œì¼ í™€' },
            'ãƒŸãƒƒã‚­ãƒ¼ã®ãƒ•ã‚£ãƒ«ãƒãƒ¼ãƒã‚¸ãƒƒã‚¯': { en: 'Mickey\'s PhilharMagic', zh: 'ç±³å¥‡é­”æ³•éŸ³ä¹ä¸–ç•Œ', ko: 'ë¯¸í‚¤ì˜ í•„í•˜ëª¨ë‹‰' },
            'ãƒ”ãƒã‚­ã‚ªã®å†’é™ºæ—…è¡Œ': { en: 'Pinocchio\'s Daring Journey', zh: 'çš®è¯ºæ›¹çš„å‹‡æ•¢ä¹‹æ—…', ko: 'í”¼ë…¸í‚¤ì˜¤ì˜ ëª¨í—˜ ì—¬í–‰' },
            'ç©ºé£›ã¶ãƒ€ãƒ³ãƒœ': { en: 'Dumbo the Flying Elephant', zh: 'å°é£è±¡', ko: 'ë‚ ì•„ë‹¤ë‹ˆëŠ” ë¤ë³´' },
            'ã‚­ãƒ£ãƒƒã‚¹ãƒ«ã‚«ãƒ«ãƒ¼ã‚»ãƒ«': { en: 'Castle Carrousel', zh: 'åŸå ¡æ—‹è½¬æœ¨é©¬', ko: 'ìºìŠ¬ íšŒì „ëª©ë§ˆ' },
            'ãƒ›ãƒ¼ãƒ³ãƒ†ãƒƒãƒ‰ãƒãƒ³ã‚·ãƒ§ãƒ³': { en: 'Haunted Mansion', zh: 'å¹½çµå…¬é¦†', ko: 'ìœ ë ¹ì˜ ì €íƒ' },
            'ã‚¤ãƒƒãƒ„ãƒ»ã‚¢ãƒ»ã‚¹ãƒ¢ãƒ¼ãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰': { en: 'It\'s a Small World', zh: 'å°å°ä¸–ç•Œ', ko: 'ì‘ì€ ì„¸ìƒ' },
            'ãƒ—ãƒ¼ã•ã‚“ã®ãƒãƒ‹ãƒ¼ãƒãƒ³ãƒˆ': { en: 'Pooh\'s Hunny Hunt', zh: 'å°ç†Šç»´å°¼çŒèœœè®°', ko: 'ê³°ëŒì´ í‘¸ì˜ í—ˆë‹ˆ í—ŒíŠ¸' },
            'ãƒ­ã‚¸ãƒ£ãƒ¼ãƒ©ãƒ“ãƒƒãƒˆã®ã‚«ãƒ¼ãƒˆã‚¥ãƒ¼ãƒ³ã‚¹ãƒ”ãƒ³': { en: 'Roger Rabbit\'s Car Toon Spin', zh: 'ç½—æ°å…”å¡é€šæ—‹è½¬', ko: 'ë¡œì € ë˜ë¹—ì˜ ì¹´íˆ° ìŠ¤í•€' },
            'ãƒŸãƒ‹ãƒ¼ã®å®¶': { en: 'Minnie\'s House', zh: 'ç±³å¦®çš„å®¶', ko: 'ë¯¸ë‹ˆì˜ ì§‘' },
            'ãƒãƒƒãƒ—ã¨ãƒ‡ãƒ¼ãƒ«ã®ãƒ„ãƒªãƒ¼ãƒã‚¦ã‚¹': { en: 'Chip \'n Dale\'s Treehouse', zh: 'å¥‡å¥‡å’Œè’‚è’‚çš„æ ‘å±‹', ko: 'ì¹© ì•¤ ë°ì¼ì˜ íŠ¸ë¦¬í•˜ìš°ìŠ¤' },
            'ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ã‚´ãƒ¼ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼': { en: 'Gadget\'s Go Coaster', zh: 'é«˜é£ç©å…·åŸè¿‡å±±è½¦', ko: 'ê°€ì ¯ì˜ ê³  ì½”ìŠ¤í„°' },
            'ãƒ‰ãƒŠãƒ«ãƒ‰ã®ãƒœãƒ¼ãƒˆ': { en: 'Donald\'s Boat', zh: 'å”è€é¸­çš„èˆ¹', ko: 'ë„ë„ë“œì˜ ë³´íŠ¸' },
            'ã‚°ãƒ¼ãƒ•ã‚£ãƒ¼ã®ãƒšã‚¤ãƒ³ãƒˆï¼†ãƒ—ãƒ¬ã‚¤ãƒã‚¦ã‚¹': { en: 'Goofy\'s Paint \'n\' Play House', zh: 'é«˜é£æ²¹æ¼†å±‹', ko: 'êµ¬í”¼ì˜ í˜ì¸íŠ¸ ì•¤ í”Œë ˆì´ í•˜ìš°ìŠ¤' },
            'ã‚¹ã‚¿ãƒ¼ãƒ»ãƒ„ã‚¢ãƒ¼ã‚º:ã‚¶ãƒ»ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ã‚ºãƒ»ã‚³ãƒ³ãƒ†ã‚£ãƒ‹ãƒ¥ãƒ¼': { en: 'Star Tours: The Adventures Continue', zh: 'æ˜Ÿé™…æ—…è¡Œï¼šå†’é™©ç»§ç»­', ko: 'ìŠ¤íƒ€ íˆ¬ì–´ì¦ˆ: ë” ì–´ë“œë²¤ì²˜ ì»¨í‹°ë‰´' },
            'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚ºãƒ»ã‚¤ãƒ³ã‚¯"ãƒ©ã‚¤ãƒ‰&ã‚´ãƒ¼ã‚·ãƒ¼ã‚¯!"': { en: 'Monsters, Inc. Ride & Go Seek!', zh: 'æ€ªå…½ç”µåŠ›å…¬å¸"è¿·è—å·¡æ¸¸è½¦"', ko: 'ëª¬ìŠ¤í„° ì£¼ì‹íšŒì‚¬ ë¼ì´ë“œ ì•¤ ê³  ì‹œí¬!' },
            'ãƒšãƒ‹ãƒ¼ã‚¢ãƒ¼ã‚±ãƒ¼ãƒ‰': { en: 'Penny Arcade', zh: 'ä¾¿å£«è¡—æœº', ko: 'í˜ë‹ˆ ì•„ì¼€ì´ë“œ' },
            'ãƒˆã‚¥ãƒ¼ãƒ³ãƒ‘ãƒ¼ã‚¯': { en: 'Toontown Park', zh: 'å¡é€šåŸå…¬å›­', ko: 'íˆ°íƒ€ìš´ íŒŒí¬' },
            'ã‚¹ãƒ†ã‚£ãƒƒãƒãƒ»ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼': { en: 'Stitch Encounter', zh: 'å²è¿ªå¥‡è§é¢ä¼š', ko: 'ìŠ¤í‹°ì¹˜ ì¸ì¹´ìš´í„°' },
            'ãƒ™ã‚¤ãƒãƒƒã‚¯ã‚¹ã®ãƒãƒƒãƒ”ãƒ¼ãƒ©ã‚¤ãƒ‰': { en: 'Baymax\'s Happy Ride', zh: 'å¤§ç™½å¿«ä¹éª‘ä¹˜', ko: 'ë² ì´ë§¥ìŠ¤ì˜ í•´í”¼ ë¼ì´ë“œ' },
            'ç¾å¥³ã¨é‡ç£"é­”æ³•ã®ã‚‚ã®ãŒãŸã‚Š"': { en: 'Beauty and the Beast', zh: 'ç¾å¥³ä¸é‡å…½"é­”æ³•ç‰©è¯­"', ko: 'ë¯¸ë…€ì™€ ì•¼ìˆ˜ "ë§ˆë²•ì˜ ì´ì•¼ê¸°"' }
        };

        // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³åã‚’ç¿»è¨³
        function translateAttractionName(name, lang) {
            try {
                if (!name) return name;
                if (lang === 'ja') return name;
                const cleanName = cleanAttractionName(name);
                if (attractionNames && attractionNames[cleanName] && attractionNames[cleanName][lang]) {
                    return attractionNames[cleanName][lang];
                }
                return cleanName; // ç¿»è¨³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…ƒã®åå‰ã‚’è¿”ã™
            } catch (error) {
                console.error('ç¿»è¨³ã‚¨ãƒ©ãƒ¼:', error, name, lang);
                return name; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®åå‰ã‚’è¿”ã™
            }
        }

        // å–¶æ¥­æ™‚é–“ã®ç¯„å›²ï¼ˆ8:00-21:00ï¼‰
        const OPERATING_HOURS = {
            min: '08:00',
            max: '21:00'
        };

        // é–‹å§‹æ™‚åˆ»ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateStartTime() {
            const startTimeInput = document.getElementById('startTime');
            const value = startTimeInput.value;
            
            if (value < OPERATING_HOURS.min) {
                alert(`é–‹å§‹æ™‚åˆ»ã¯å–¶æ¥­æ™‚é–“å†…ï¼ˆ${OPERATING_HOURS.min}ï½${OPERATING_HOURS.max}ï¼‰ã§é¸æŠã—ã¦ãã ã•ã„ã€‚`);
                startTimeInput.value = OPERATING_HOURS.min;
            } else if (value > OPERATING_HOURS.max) {
                alert(`é–‹å§‹æ™‚åˆ»ã¯å–¶æ¥­æ™‚é–“å†…ï¼ˆ${OPERATING_HOURS.min}ï½${OPERATING_HOURS.max}ï¼‰ã§é¸æŠã—ã¦ãã ã•ã„ã€‚`);
                startTimeInput.value = OPERATING_HOURS.max;
            }
            
            // é€€åœ’æ™‚åˆ»ã‚ˆã‚Šå¾Œã«ãªã‚‰ãªã„ã‚ˆã†ã«ãƒã‚§ãƒƒã‚¯
            const exitTimeInput = document.getElementById('exitTimeInput');
            if (exitOption === 'time' && exitTimeInput.value && value >= exitTimeInput.value) {
                alert('é–‹å§‹æ™‚åˆ»ã¯é€€åœ’æ™‚åˆ»ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
                startTimeInput.value = OPERATING_HOURS.min;
            }
        }

        // é€€åœ’æ™‚åˆ»ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateExitTime() {
            const exitTimeInput = document.getElementById('exitTimeInput');
            const value = exitTimeInput.value;
            
            if (value < OPERATING_HOURS.min) {
                alert(`é€€åœ’æ™‚åˆ»ã¯å–¶æ¥­æ™‚é–“å†…ï¼ˆ${OPERATING_HOURS.min}ï½${OPERATING_HOURS.max}ï¼‰ã§é¸æŠã—ã¦ãã ã•ã„ã€‚`);
                exitTimeInput.value = OPERATING_HOURS.min;
            } else if (value > OPERATING_HOURS.max) {
                alert(`é€€åœ’æ™‚åˆ»ã¯å–¶æ¥­æ™‚é–“å†…ï¼ˆ${OPERATING_HOURS.min}ï½${OPERATING_HOURS.max}ï¼‰ã§é¸æŠã—ã¦ãã ã•ã„ã€‚`);
                exitTimeInput.value = OPERATING_HOURS.max;
            }
            
            // é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå‰ã«ãªã‚‰ãªã„ã‚ˆã†ã«ãƒã‚§ãƒƒã‚¯
            const startTimeInput = document.getElementById('startTime');
            if (startTimeInput.value && value <= startTimeInput.value) {
                alert('é€€åœ’æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
                exitTimeInput.value = OPERATING_HOURS.max;
            }
        }

        // é€€åœ’ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š
        function setExitOption(option, element) {
            exitOption = option;
            document.querySelectorAll('.exit-option-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            } else {
                document.querySelector(`.exit-option-btn[onclick*="${option}"]`).classList.add('active');
            }
            
            const exitTimeInput = document.getElementById('exitTimeInput');
            if (option === 'time') {
                exitTimeInput.classList.add('visible');
                exitTimeInput.classList.remove('hidden');
            } else {
                exitTimeInput.classList.remove('visible');
                exitTimeInput.classList.add('hidden');
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
        window.validateStartTime = validateStartTime;
        window.validateExitTime = validateExitTime;

        // åœ°å›³åˆæœŸåŒ–
        function initMap() {
            if (map) return; // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿
            
            const mapContainer = document.getElementById('map');
            map = L.map(mapContainer, {
                center: DISNEY_LAND_CENTER,
                zoom: 15,
                zoomControl: true
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        // å¾…ã¡æ™‚é–“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        async function loadWaitingTimes() {
            try {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã¦æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const response = await fetch('waiting_times.json?' + new Date().getTime(), {
                    cache: 'no-store'
                });
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    waitingTimesData = {};
                    data.forEach(item => {
                        if (item.attr_id) {
                            waitingTimesData[item.attr_id] = {
                                waiting_minutes: item.waiting_minutes || 0,
                                updated_at: item.updated_at,
                                time_series: item.time_series || []
                            };
                        }
                    });
                    const totalRecords = data.reduce((sum, item) => sum + (item.time_series?.length || 0), 0);
                    
                    // ãƒ‡ãƒãƒƒã‚°: èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã®æ—¥ä»˜ç¯„å›²ã‚’ç¢ºèª
                    let dateRange = { min: null, max: null };
                    data.forEach(item => {
                        if (item.time_series && item.time_series.length > 0) {
                            item.time_series.forEach(ts => {
                                if (ts.timestamp) {
                                    const date = new Date(ts.timestamp);
                                    if (!dateRange.min || date < dateRange.min) dateRange.min = date;
                                    if (!dateRange.max || date > dateRange.max) dateRange.max = date;
                                }
                            });
                        }
                    });
                    if (dateRange.min && dateRange.max) {
                        console.log(`èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã®æ—¥ä»˜ç¯„å›²: ${dateRange.min.toISOString().split('T')[0]} ï½ ${dateRange.max.toISOString().split('T')[0]}`);
                    }
                    
                    console.log(`${Object.keys(waitingTimesData).length}ä»¶ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã€åˆè¨ˆ${totalRecords}ä»¶ã®å¾…ã¡æ™‚é–“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                }
            } catch (error) {
                console.error('å¾…ã¡æ™‚é–“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // æŒ‡å®šæ™‚åˆ»ã«æœ€ã‚‚è¿‘ã„å¾…ã¡æ™‚é–“ã‚’å–å¾—ï¼ˆå¾…ã¡æ™‚é–“ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿”ã™ï¼‰
        // åˆ°ç€æ™‚åˆ»ã«æœ€ã‚‚è¿‘ã„æ™‚é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼ˆéå»ãƒ»æœªæ¥å•ã‚ãšï¼‰
        // targetTimeMinutes: 1æ—¥ã®åˆ†æ•°ï¼ˆ0-1439ã€ä¾‹ï¼š900 = 15æ™‚ï¼‰
        function getWaitingTimeAtTime(attrId, targetTimeMinutes) {
            const data = waitingTimesData[attrId];
            if (!data || !data.time_series || data.time_series.length === 0) {
                return {
                    waiting_minutes: data?.waiting_minutes || 0,
                    timestamp: data?.updated_at || null
                };
            }

            // ç›®æ¨™æ™‚åˆ»ï¼ˆ1æ—¥ã®åˆ†æ•°ã€0-1439ï¼‰
            const targetTimeOnly = targetTimeMinutes % (24 * 60); // å¿µã®ãŸã‚24æ™‚é–“ã§å‰²ã£ãŸä½™ã‚Šã‚’å–å¾—

            // ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€åˆ°ç€æ™‚åˆ»ã«æœ€ã‚‚è¿‘ã„ã‚‚ã®ã‚’é¸æŠ
            let closest = null;
            let minDiff = Infinity;

            data.time_series.forEach(item => {
                if (!item.timestamp) return;
                const itemDate = new Date(item.timestamp);
                const itemHours = itemDate.getHours();
                const itemMinutes = itemDate.getMinutes();
                const itemSeconds = itemDate.getSeconds();
                // ç§’ã¾ã§å«ã‚ãŸåˆ†æ•°ã«å¤‰æ›ï¼ˆã‚ˆã‚Šæ­£ç¢ºãªæ¯”è¼ƒã®ãŸã‚ï¼‰
                const itemTimeOnly = itemHours * 60 + itemMinutes + itemSeconds / 60;
                
                // æ™‚åˆ»ã®å·®ã‚’è¨ˆç®—ï¼ˆçµ¶å¯¾å€¤ã€åˆ†å˜ä½ï¼‰
                let diff = Math.abs(itemTimeOnly - targetTimeOnly);
                
                // 24æ™‚é–“ã‚’è¶…ãˆã‚‹å ´åˆã¯åå¯¾å´ã‚’è€ƒæ…®ï¼ˆä¾‹: 23:00ã¨01:00ã¯2æ™‚é–“ã®å·®ï¼‰
                if (diff > 12 * 60) {
                    diff = 24 * 60 - diff;
                }
                
                // æœ€ã‚‚è¿‘ã„æ™‚åˆ»ã®ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠ
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = item;
                }
            });

            // æœ€ã‚‚è¿‘ã„ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯ãã‚Œã‚’è¿”ã™
            if (closest) {
                return {
                    waiting_minutes: closest.waiting_minutes || 0,
                    timestamp: closest.timestamp
                };
            }

            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ€æ–°ã®å¾…ã¡æ™‚é–“ã‚’ä½¿ç”¨
            return {
                waiting_minutes: data.waiting_minutes || 0,
                timestamp: data.updated_at || null
            };
        }

        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã€ŒXXæ™‚ç‚¹ã€å½¢å¼ã«å¤‰æ›
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            try {
                const date = new Date(timestamp);
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const hours = date.getHours();
                const minutes = date.getMinutes();
                return `${month}/${day} ${hours}:${String(minutes).padStart(2, '0')}æ™‚ç‚¹`;
            } catch (e) {
                return '';
            }
        }

        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
        async function loadAttractionsFromDB() {
            try {
                // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆå„ªå…ˆï¼‰
                const response = await fetch('attractions.json');
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    availableAttractions = data
                        .filter(attr => attr.is_active && !attr.is_invalid && attr.entrance_lat && attr.entrance_lng)
                        .map(attr => {
                            const cleanName = cleanAttractionName(attr.name);
                            const officialId = parseInt(attr.official_id) || null;
                            
                            // Firestoreã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå„ªå…ˆï¼‰ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ¤å®š
                            const metadata = officialId ? attractionsMetadata[officialId] : null;
                            let genreInfo;
                            if (metadata && metadata.genre) {
                                // Firestoreã®ã‚¸ãƒ£ãƒ³ãƒ«ã‚’ä½¿ç”¨
                                genreInfo = getGenreInfo(metadata.genre);
                            } else {
                                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ¤å®š
                                genreInfo = getAttractionGenre(cleanName);
                            }
                            
                            // æ‰€è¦æ™‚é–“: Firestoreå„ªå…ˆã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                            const durationMinutes = (metadata && metadata.duration_minutes) ? metadata.duration_minutes : genreInfo.duration;
                            
                            // åˆæœŸå€¤ã¨ã—ã¦æœ€æ–°ã®å¾…ã¡æ™‚é–“ã‚’è¨­å®šï¼ˆå¾Œã§æ™‚åˆ»ã«å¿œã˜ã¦æ›´æ–°ã•ã‚Œã‚‹ï¼‰
                            const waitingData = officialId ? waitingTimesData[officialId] : null;
                            const waitingMinutes = waitingData ? waitingData.waiting_minutes : 0;
                            
                            return {
                                id: attr.id,
                                name: cleanName,
                                translatedName: translateAttractionName(cleanName, currentLanguage),
                                originalName: attr.name,
                                official_id: attr.official_id || '',
                                lat: parseFloat(attr.entrance_lat),
                                lng: parseFloat(attr.entrance_lng),
                                exit_lat: attr.exit_lat ? parseFloat(attr.exit_lat) : null,
                                exit_lng: attr.exit_lng ? parseFloat(attr.exit_lng) : null,
                                area_name: attr.area_name || '',
                                genre: genreInfo.genre,
                                icon: genreInfo.icon,
                                iconDescription: genreInfo.description || 'ãã®ä»–',
                                duration_minutes: durationMinutes,
                                is_seated: genreInfo.isSeated,
                                waiting_minutes: waitingMinutes
                            };
                        });
                    
                    console.log(`${availableAttractions.length}ä»¶ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã¾ã—ãŸ`);
                } else {
                    console.warn('ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            } catch (error) {
                console.error('ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                availableAttractions = [
                    { id: 4, name: 'ã‚ªãƒ ãƒ‹ãƒã‚¹ (ID: 151)', lat: 35.632993, lng: 139.879729, area_name: '', waiting_minutes: 0 },
                    { id: 5, name: 'ã‚«ãƒªãƒ–ã®æµ·è³Š (ID: 152)', lat: 35.634270, lng: 139.880582, area_name: '', waiting_minutes: 0 },
                    { id: 6, name: 'ã‚¸ãƒ£ãƒ³ã‚°ãƒ«ã‚¯ãƒ«ãƒ¼ã‚º (ID: 153)', lat: 35.633780, lng: 139.882328, area_name: '', waiting_minutes: 0 },
                ];
                console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã—ãŸ');
            }
            
            // ã‚°ãƒªãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ–½è¨­ã‚’è¿½åŠ 
            addGreetingAttractions();
            
            renderAttractionCards();
        }

        // ã‚°ãƒªãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ–½è¨­ã‚’è¿½åŠ ï¼ˆãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰ã®ã¿ï¼‰
        function addGreetingAttractions() {
            // ã‚°ãƒªãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ–½è¨­ã®å®šç¾©ï¼ˆãƒ©ãƒ³ãƒ‰ã®ã¿ï¼‰
            const greetingAttractionsLand = [
                { official_id: '890', name: 'ãƒŸãƒ‹ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚¹ã‚¿ã‚¸ã‚ª', lat: 35.630144, lng: 139.879011, area_name: 'ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³' },
                { official_id: '908', name: 'ãƒ¡ã‚¤ãƒ³ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ»ãƒã‚¦ã‚¹å‰ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚°ãƒªãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰', lat: 35.632993, lng: 139.879729, area_name: 'ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒã‚¶ãƒ¼ãƒ«' },
                { official_id: '909', name: 'ãƒŸãƒƒã‚­ãƒ¼ã®å®¶ã¨ãƒŸãƒ¼ãƒˆãƒ»ãƒŸãƒƒã‚­ãƒ¼', lat: 35.630144, lng: 139.879011, area_name: 'ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³' },
                { official_id: '916', name: 'ã‚¦ãƒƒãƒ‰ãƒãƒ£ãƒƒã‚¯ãƒ»ã‚°ãƒªãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒˆãƒ¬ã‚¤ãƒ«ï¼ˆãƒ‰ãƒŠãƒ«ãƒ‰ï¼‰', lat: 35.630392, lng: 139.879013, area_name: 'ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³' },
                { official_id: '917', name: 'ã‚¦ãƒƒãƒ‰ãƒãƒ£ãƒƒã‚¯ãƒ»ã‚°ãƒªãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒˆãƒ¬ã‚¤ãƒ«ï¼ˆãƒ‡ã‚¤ã‚¸ãƒ¼ï¼‰', lat: 35.630392, lng: 139.879013, area_name: 'ãƒˆã‚¥ãƒ¼ãƒ³ã‚¿ã‚¦ãƒ³' }
            ];
            
            // ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰ã®ã‚°ãƒªãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ–½è¨­ã®ã¿ã‚’ä½¿ç”¨
            const allGreetings = greetingAttractionsLand;
            
            allGreetings.forEach((greeting, index) => {
                const officialId = parseInt(greeting.official_id) || null;
                const cleanName = greeting.name;
                
                // å¾…ã¡æ™‚é–“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const waitingData = officialId ? waitingTimesData[officialId] : null;
                const waitingMinutes = waitingData ? waitingData.waiting_minutes : 0;
                
                // ã‚°ãƒªãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ–½è¨­ã®ã‚¸ãƒ£ãƒ³ãƒ«æƒ…å ±ï¼ˆã‚°ãƒªãƒ¼ãƒ†ã‚£ãƒ³ã‚°å°‚ç”¨ï¼‰
                const genreInfo = {
                    genre: 'greeting',
                    icon: 'ğŸ‘‹',
                    duration: 10, // ã‚°ãƒªãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ç´„10åˆ†ã¨ä»®å®š
                    isSeated: false,
                    description: 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚°ãƒªãƒ¼ãƒ†ã‚£ãƒ³ã‚°'
                };
                
                // æ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆofficial_idã§ï¼‰
                const existingIndex = availableAttractions.findIndex(attr => attr.official_id === greeting.official_id);
                
                if (existingIndex === -1) {
                    // æ–°ã—ã„IDã‚’ç”Ÿæˆï¼ˆæ—¢å­˜ã®æœ€å¤§ID + 1ï¼‰
                    const maxId = availableAttractions.length > 0 ? 
                        Math.max(...availableAttractions.map(a => a.id)) : 0;
                    const newId = maxId + 1 + index;
                    
                    availableAttractions.push({
                        id: newId,
                        name: cleanName,
                        translatedName: translateAttractionName(cleanName, currentLanguage),
                        originalName: cleanName,
                        official_id: greeting.official_id,
                        lat: greeting.lat,
                        lng: greeting.lng,
                        exit_lat: greeting.lat,
                        exit_lng: greeting.lng,
                        area_name: greeting.area_name || '',
                        genre: genreInfo.genre,
                        icon: genreInfo.icon,
                        iconDescription: genreInfo.description,
                        duration_minutes: genreInfo.duration,
                        is_seated: genreInfo.isSeated,
                        waiting_minutes: waitingMinutes
                    });
                }
            });
            
            console.log(`${allGreetings.length}ä»¶ã®ã‚°ãƒªãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ–½è¨­ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        // å„ªå…ˆåº¦è¨­å®š
        function setPriority(priority) {
            currentPriority = priority;
            document.querySelectorAll('.priority-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-priority="${priority}"]`).classList.add('active');
        }

        // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ã‚’æç”»
        function renderAttractionCards() {
            const grid = document.getElementById('attractionGrid');
            grid.innerHTML = '';
            
            availableAttractions.forEach(attr => {
                const card = document.createElement('div');
                card.className = 'attraction-card';
                card.dataset.id = attr.id;
                
                const isSelected = selectedAttractions.some(a => a.id === attr.id);
                const selectedAttr = isSelected ? selectedAttractions.find(a => a.id === attr.id) : null;
                const selectedIndex = isSelected ? selectedAttractions.findIndex(a => a.id === attr.id) : -1;
                
                if (isSelected) {
                    card.classList.add('selected');
                    // å„ªå…ˆåº¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                    card.classList.add('priority-' + selectedAttr.priority);
                }
                
                const priorityBadge = document.createElement('div');
                priorityBadge.className = 'priority-badge priority-' + (isSelected ? 
                    selectedAttr.priority : 'medium');
                priorityBadge.textContent = isSelected ? 
                    (selectedAttr.priority === 'high' ? 'é«˜' : 
                     selectedAttr.priority === 'medium' ? 'ä¸­' : 'ä½') : '';
                
                // ã‚«ãƒ¼ãƒ‰ã®é †ç•ªç•ªå·ã‚’è¡¨ç¤º
                if (isSelected && selectedIndex >= 0) {
                    const orderNumber = document.createElement('div');
                    orderNumber.className = 'card-order-number';
                    orderNumber.textContent = selectedIndex + 1;
                    card.appendChild(orderNumber);
                }
                
                // ã‚¸ãƒ£ãƒ³ãƒ«ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                if (attr.genre === 'theater') {
                    card.classList.add('theater');
                } else if (attr.genre === 'walking') {
                    card.classList.add('walking');
                } else if (attr.genre === 'coaster') {
                    card.classList.add('coaster');
                } else if (attr.genre === 'ride') {
                    card.classList.add('ride');
                } else if (attr.genre === 'greeting') {
                    card.classList.add('greeting');
                }
                
                const name = document.createElement('div');
                name.className = 'attraction-card-name';
                const icon = document.createElement('span');
                icon.className = 'attraction-icon';
                icon.textContent = attr.icon || 'ğŸ¡';
                name.appendChild(icon);
                const nameText = document.createElement('span');
                
                // æ–‡å­—æ•°ãŒ21å­—ä»¥ä¸Šã®å ´åˆã¯ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                const displayName = attr.translatedName || attr.name;
                if (displayName && displayName.length >= 21) {
                    name.classList.add('long-text');
                }
                nameText.textContent = attr.translatedName || attr.name;
                name.appendChild(nameText);
                
                card.appendChild(priorityBadge);
                card.appendChild(name);
                
                card.addEventListener('click', () => {
                    toggleAttraction(attr.id);
                });
                
                grid.appendChild(card);
            });
        }

        // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®é¸æŠ/è§£é™¤
        function toggleAttraction(id) {
            const attraction = availableAttractions.find(a => a.id === id);
            if (!attraction) return;
            
            const index = selectedAttractions.findIndex(a => a.id === id);
            
            if (index >= 0) {
                // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤
                selectedAttractions.splice(index, 1);
            } else {
                // é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯è¿½åŠ 
                selectedAttractions.push({
                    ...attraction,
                    priority: currentPriority
                });
            }
            
            renderAttractionCards();
            renderMarkers();
            updateAttractionList();
        }

        // ãƒãƒ¼ã‚«ãƒ¼æç”»
        function renderMarkers() {
            if (!map) return; // åœ°å›³ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            
            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // é¸æŠã•ã‚ŒãŸã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            selectedAttractions.forEach((attr, index) => {
                const markerColor = attr.priority === 'high' ? '#FF69B4' : 
                                   attr.priority === 'low' ? '#D3D3D3' : '#DDA0DD';
                
                const marker = L.circleMarker([attr.lat, attr.lng], {
                    radius: 12,
                    fillColor: markerColor,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                const displayName = attr.translatedName || attr.name;
                marker.bindPopup(`<b>${index + 1}. ${displayName}</b><br>${i18n[currentLanguage]['priority']}: ${getPriorityText(attr.priority)}`);
                markers.push(marker);
            });
        }

        // å„ªå…ˆåº¦ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
        function getPriorityText(priority) {
            const texts = {
                'high': i18n[currentLanguage]['priority-high'],
                'medium': i18n[currentLanguage]['priority-medium'],
                'low': i18n[currentLanguage]['priority-low']
            };
            return texts[priority] || i18n[currentLanguage]['priority-medium'];
        }

        // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆæ›´æ–°
        function updateAttractionList() {
            const attractionList = document.getElementById('attractionList');
            attractionList.innerHTML = '';
            
            if (selectedAttractions.length === 0) {
                attractionList.innerHTML = `<div style="text-align: center; color: #999; padding: 20px;">${i18n[currentLanguage]['select-attractions']}</div>`;
                return;
            }
            
            selectedAttractions.forEach((attr, index) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                const priorityColor = attr.priority === 'high' ? '#FF69B4' : 
                                    attr.priority === 'low' ? '#D3D3D3' : '#DDA0DD';
                item.style.borderLeftColor = priorityColor;
                const icon = attr.icon || 'ğŸ¡';
                const waitingInfo = attr.waiting_minutes > 0 ? ` <small style="color: #FF69B4;">â±ï¸ ${attr.waiting_minutes}${i18n[currentLanguage]['minutes']}</small>` : '';
                const durationInfo = attr.duration_minutes ? ` <small style="color: #666;">â³ ${attr.duration_minutes}${i18n[currentLanguage]['minutes']}</small>` : '';
                item.innerHTML = `
                    <span class="list-item-name">${index + 1}. ${icon} ${attr.translatedName || attr.name}${waitingInfo}${durationInfo} <small style="color: ${priorityColor};">(${i18n[currentLanguage]['priority']}: ${getPriorityText(attr.priority)})</small></span>
                    <button class="list-item-delete" onclick="deleteAttraction(${attr.id})">${i18n[currentLanguage]['delete']}</button>
                `;
                attractionList.appendChild(item);
            });
        }

        // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤
        function deleteAttraction(id) {
            selectedAttractions = selectedAttractions.filter(a => a.id !== id);
            renderAttractionCards();
            renderMarkers();
            updateAttractionList();
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            document.getElementById('resultBox').classList.add('hidden');
        }

        // è·é›¢è¨ˆç®—ï¼ˆHaversine formulaï¼‰
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // åœ°çƒã®åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // æœ€è¿‘å‚æ³•TSPï¼ˆè·é›¢æœ€çŸ­ï¼‰
        function nearestNeighborTSP(points) {
            if (points.length === 0) return [];
            
            const route = [];
            const visited = new Set();
            let current = points[0];
            route.push(current);
            visited.add(current.id);

            while (visited.size < points.length) {
                let nearest = null;
                let minDist = Infinity;

                for (const point of points) {
                    if (visited.has(point.id)) continue;
                    const dist = calculateDistance(
                        current.lat, current.lng,
                        point.lat, point.lng
                    );
                    if (dist < minDist) {
                        minDist = dist;
                        nearest = point;
                    }
                }

                if (nearest) {
                    route.push(nearest);
                    visited.add(nearest.id);
                    current = nearest;
                }
            }

            return route;
        }

        // æ™‚é–“æœ€çŸ­TSPï¼ˆç§»å‹•æ™‚é–“ + å¾…ã¡æ™‚é–“ + æ‰€è¦æ™‚é–“ã‚’è€ƒæ…®ï¼‰
        function shortestTimeTSP(points, startTimeMinutes, walkingSpeedMetersPerMinute = 80) {
            if (points.length === 0) return [];
            
            const route = [];
            const visited = new Set();
            let current = points[0];
            route.push(current);
            visited.add(current.id);
            let currentTimeMinutes = startTimeMinutes;

            while (visited.size < points.length) {
                let bestNext = null;
                let minTotalTime = Infinity;

                for (const point of points) {
                    if (visited.has(point.id)) continue;
                    
                    // ç§»å‹•æ™‚é–“ã‚’è¨ˆç®—
                    const distance = calculateDistance(
                        current.lat, current.lng,
                        point.lat, point.lng
                    );
                    const travelMinutes = Math.ceil(distance / walkingSpeedMetersPerMinute);
                    
                    // åˆ°ç€æ™‚åˆ»
                    const arrivalTimeMinutes = currentTimeMinutes + travelMinutes;
                    
                    // å¾…ã¡æ™‚é–“ã‚’å–å¾—
                    const officialId = parseInt(point.official_id) || null;
                    const waitingData = officialId ? getWaitingTimeAtTime(officialId, arrivalTimeMinutes) : { waiting_minutes: point.waiting_minutes || 0, timestamp: null };
                    const waitingMinutes = waitingData.waiting_minutes;
                    
                    // æ‰€è¦æ™‚é–“
                    const durationMinutes = point.duration_minutes || 5;
                    
                    // ç·æ™‚é–“ï¼ˆç§»å‹•æ™‚é–“ + å¾…ã¡æ™‚é–“ + æ‰€è¦æ™‚é–“ï¼‰
                    const totalTime = travelMinutes + waitingMinutes + durationMinutes;
                    
                    if (totalTime < minTotalTime) {
                        minTotalTime = totalTime;
                        bestNext = point;
                    }
                }

                if (bestNext) {
                    route.push(bestNext);
                    visited.add(bestNext.id);
                    
                    // æ¬¡ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®ç§»å‹•æ™‚é–“ã‚’è¨ˆç®—
                    const distance = calculateDistance(
                        current.lat, current.lng,
                        bestNext.lat, bestNext.lng
                    );
                    const travelMinutes = Math.ceil(distance / walkingSpeedMetersPerMinute);
                    
                    // åˆ°ç€æ™‚åˆ»
                    const arrivalTimeMinutes = currentTimeMinutes + travelMinutes;
                    
                    // å¾…ã¡æ™‚é–“ã‚’å–å¾—
                    const officialId = parseInt(bestNext.official_id) || null;
                    const waitingData = officialId ? getWaitingTimeAtTime(officialId, arrivalTimeMinutes) : { waiting_minutes: bestNext.waiting_minutes || 0, timestamp: null };
                    const waitingMinutes = waitingData.waiting_minutes;
                    
                    // æ‰€è¦æ™‚é–“
                    const durationMinutes = bestNext.duration_minutes || 5;
                    
                    // å‡ºç™ºæ™‚åˆ»ã‚’æ›´æ–°
                    currentTimeMinutes = arrivalTimeMinutes + waitingMinutes + durationMinutes;
                    current = bestNext;
                }
            }

            return route;
        }

        // ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–æ–¹æ³•ã‚’å–å¾—
        function getRouteOptimizationMethod() {
            return localStorage.getItem('routeOptimizationMethod') || 'distance';
        }

        // ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–æ–¹æ³•ã‚’æ›´æ–°
        function updateRouteOptimization() {
            const select = document.getElementById('routeOptimizationSelect');
            const method = select.value;
            localStorage.setItem('routeOptimizationMethod', method);
        }

        // ãƒ«ãƒ¼ãƒˆã‚’æ±ºã‚ã‚‹
        function optimizeRoute() {
            if (selectedAttractions.length < 2) {
                alert('æœ€ä½2ã¤ä»¥ä¸Šã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // åœ°å›³ã‚’è¡¨ç¤º
            const mapContainer = document.querySelector('.park-map');
            const mainContent = document.querySelector('.main-content');
            if (!mapContainer.classList.contains('visible')) {
                mapContainer.classList.add('visible');
                mainContent.classList.remove('no-map');
                initMap();
                // åœ°å›³ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒãƒ¼ã‚«ãƒ¼ã‚’æç”»
                setTimeout(() => {
                    renderMarkers();
                }, 100);
            }

            const optimizationMethod = getRouteOptimizationMethod();
            let route;

            if (optimizationMethod === 'selection-order') {
                // é¸æŠé †ã§å›ã‚‹
                route = [...selectedAttractions];
            } else if (optimizationMethod === 'time') {
                // æ™‚é–“æœ€çŸ­ã§æœ€é©åŒ–
                // å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆï¼ˆé«˜â†’ä¸­â†’ä½ï¼‰
                const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                const sortedAttractions = [...selectedAttractions].sort((a, b) => {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                });
                const startTimeStr = document.getElementById('startTime').value;
                const startTimeMinutes = timeToMinutes(startTimeStr);
                const walkingSpeedMetersPerMinute = 80;
                route = shortestTimeTSP(sortedAttractions, startTimeMinutes, walkingSpeedMetersPerMinute);
            } else {
                // è·é›¢æœ€çŸ­ã§æœ€é©åŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                // å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆï¼ˆé«˜â†’ä¸­â†’ä½ï¼‰
                const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                const sortedAttractions = [...selectedAttractions].sort((a, b) => {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                });
                route = nearestNeighborTSP(sortedAttractions);
            }

            drawRoute(route);
            displayResult(route);
        }

        // ãƒ«ãƒ¼ãƒˆæç”»
        function drawRoute(route) {
            // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒˆã‚’å‰Šé™¤
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }

            if (route.length < 2) return;

            const routePoints = route.map(attr => [attr.lat, attr.lng]);
            routeLayer = L.polyline(routePoints, {
                color: '#DDA0DD',
                weight: 4,
                opacity: 0.8,
                smoothFactor: 1
            }).addTo(map);

            // ãƒãƒƒãƒ—ã‚’ãƒ«ãƒ¼ãƒˆå…¨ä½“ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«èª¿æ•´
            const group = new L.featureGroup(route.map(attr => 
                L.marker([attr.lat, attr.lng])
            ));
            map.fitBounds(group.getBounds().pad(0.1));
        }

        // æ™‚é–“ã‚’åˆ†ã«å¤‰æ›
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // åˆ†ã‚’æ™‚é–“æ–‡å­—åˆ—ã«å¤‰æ›
        function minutesToTime(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆPromiseãƒ™ãƒ¼ã‚¹ã€3æŠå¯¾å¿œï¼‰
        function showCustomDialog(title, message, confirmText, recreateText, cancelText) {
            return new Promise((resolve) => {
                const dialog = document.getElementById('customDialog');
                const titleEl = document.getElementById('customDialogTitle');
                const messageEl = document.getElementById('customDialogMessage');
                const confirmBtn = document.getElementById('customDialogConfirmBtn');
                const recreateBtn = document.getElementById('customDialogRecreateBtn');
                const cancelBtn = document.getElementById('customDialogCancelBtn');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                confirmBtn.textContent = confirmText;
                recreateBtn.textContent = recreateText;
                cancelBtn.textContent = cancelText;
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¸€åº¦ã ã‘è¨­å®š
                const handleConfirm = () => {
                    dialog.classList.remove('show');
                    resolve('display-as-is');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    recreateBtn.removeEventListener('click', handleRecreate);
                    cancelBtn.removeEventListener('click', handleCancel);
                };
                
                const handleRecreate = () => {
                    dialog.classList.remove('show');
                    resolve('recreate');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    recreateBtn.removeEventListener('click', handleRecreate);
                    cancelBtn.removeEventListener('click', handleCancel);
                };
                
                const handleCancel = () => {
                    dialog.classList.remove('show');
                    resolve('cancel');
                    confirmBtn.removeEventListener('click', handleConfirm);
                    recreateBtn.removeEventListener('click', handleRecreate);
                    cancelBtn.removeEventListener('click', handleCancel);
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                recreateBtn.addEventListener('click', handleRecreate);
                cancelBtn.addEventListener('click', handleCancel);
                
                // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚é–‰ã˜ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼ˆèª¤æ“ä½œé˜²æ­¢ï¼‰
                dialog.addEventListener('click', (e) => {
                    if (e.target === dialog) {
                        // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ä½•ã‚‚ã—ãªã„
                    }
                });
                
                dialog.classList.add('show');
            });
        }

        // çµæœè¡¨ç¤º
        function displayResult(route) {
            let totalDistance = 0;
            for (let i = 0; i < route.length - 1; i++) {
                totalDistance += calculateDistance(
                    route[i].lat, route[i].lng,
                    route[i + 1].lat, route[i + 1].lng
                );
            }

            document.getElementById('totalDistance').textContent = totalDistance.toFixed(0);
            document.getElementById('routeLength').textContent = route.length;

            const resultList = document.getElementById('resultList');
            resultList.innerHTML = '';

            const startTimeStr = document.getElementById('startTime').value;
            const exitTimeStr = exitOption === 'time' ? document.getElementById('exitTimeInput').value : '21:00';
            let currentTimeMinutes = timeToMinutes(startTimeStr);
            const exitTimeMinutes = timeToMinutes(exitTimeStr);
            
            // ç§»å‹•æ™‚é–“ã®è¨ˆç®—ï¼ˆåˆ†é€Ÿ80mã¨ä»®å®šï¼‰
            // TODO: å°†æ¥çš„ã«ã¯æ··é›‘åº¦ã‚’è€ƒæ…®ã—ã¦æ­©ãé€Ÿã•ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            // ä¾‹: æ··é›‘åº¦ãŒé«˜ã„æ™‚é–“å¸¯ã¯åˆ†é€Ÿ60mã€ç©ºã„ã¦ã„ã‚‹æ™‚é–“å¸¯ã¯åˆ†é€Ÿ100mãªã©
            const walkingSpeedMetersPerMinute = 80;
            
            // é–‰åœ’æ™‚åˆ»ã‚’è¶…ãˆã‚‹ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨˜éŒ²
            const attractionsExceedingClosingTime = [];
            let tempCurrentTimeMinutes = currentTimeMinutes;
            
            route.forEach((point, index) => {
                // ç§»å‹•æ™‚é–“ã®è¨ˆç®—
                let travelMinutes = 0;
                if (index > 0) {
                    const prevPoint = route[index - 1];
                    const distance = calculateDistance(
                        prevPoint.lat, prevPoint.lng,
                        point.lat, point.lng
                    );
                    travelMinutes = Math.ceil(distance / walkingSpeedMetersPerMinute);
                }
                
                // åˆ°ç€æ™‚åˆ»
                const arrivalTimeMinutes = tempCurrentTimeMinutes;
                
                // å¾…ã¡æ™‚é–“ï¼ˆåˆ°ç€æ™‚åˆ»ã«æœ€ã‚‚è¿‘ã„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼‰
                const officialId = parseInt(point.official_id) || null;
                const waitingData = officialId ? getWaitingTimeAtTime(officialId, arrivalTimeMinutes) : { waiting_minutes: point.waiting_minutes || 0, timestamp: null };
                const waitingMinutes = waitingData.waiting_minutes;
                
                // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³æ‰€è¦æ™‚é–“
                const durationMinutes = point.duration_minutes || 5;
                
                // å‡ºç™ºæ™‚åˆ»ï¼ˆåˆ°ç€ + å¾…ã¡æ™‚é–“ + æ‰€è¦æ™‚é–“ï¼‰
                const departureTimeMinutes = arrivalTimeMinutes + waitingMinutes + durationMinutes;
                
                // é–‰åœ’æ™‚åˆ»ã‚’è¶…ãˆã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆåˆ°ç€æ™‚åˆ»ã§åˆ¤å®šï¼‰
                if (arrivalTimeMinutes > exitTimeMinutes) {
                    attractionsExceedingClosingTime.push({
                        index: index,
                        name: point.translatedName || point.name,
                        arrivalTime: minutesToTime(arrivalTimeMinutes),
                        priority: point.priority
                    });
                }
                
                // æ¬¡ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®ç§»å‹•æ™‚é–“ã‚’åŠ ç®—
                tempCurrentTimeMinutes = departureTimeMinutes + travelMinutes;
            });
            
            // é–‰åœ’æ™‚åˆ»ã‚’è¶…ãˆã‚‹ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç¢ºèª
            if (attractionsExceedingClosingTime.length > 0) {
                const lang = i18n[currentLanguage] || i18n['ja'];
                const exceedingNames = attractionsExceedingClosingTime.map(a => 
                    `ãƒ»${a.name} (${lang['arrival-scheduled']}: ${a.arrivalTime})`
                ).join('\n');
                
                // é€€åœ’æ™‚åˆ»ãŒæ™‚åˆ»æŒ‡å®šã®å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
                let message;
                if (exitOption === 'time') {
                    message = `${lang['exit-time-exceeded'].replace('{time}', exitTimeStr)}\n\n${exceedingNames}`;
                } else {
                    message = `${lang['closing-time-exceeded'].replace('{time}', exitTimeStr)}\n\n${exceedingNames}`;
                }
                
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ç¢ºèªï¼ˆ3æŠï¼‰
                showCustomDialog(
                    lang['closing-time-exceeded-warning'],
                    message,
                    lang['display-as-is'] || 'ãã®ã¾ã¾è¡¨ç¤º',
                    lang['recreate-route-low-priority'] || 'ä½å„ªå…ˆåº¦ã®ã‚‚ã®ã‚’å‰Šé™¤ã—å†ä½œæˆ',
                    lang['cancel'] || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
                ).then((choice) => {
                    if (choice === 'display-as-is') {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œãã®ã¾ã¾è¡¨ç¤ºã€ã‚’é¸æŠã—ãŸå ´åˆ
                        renderRouteList(route, currentTimeMinutes, exitTimeMinutes, walkingSpeedMetersPerMinute);
                    } else if (choice === 'recreate') {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œä½å„ªå…ˆåº¦ã®ã‚‚ã®ã‚’å‰Šé™¤ã—å†ä½œæˆã€ã‚’é¸æŠã—ãŸå ´åˆ
                        const filteredAttractions = selectedAttractions.filter(attr => {
                            // é–‰åœ’æ™‚åˆ»ã‚’è¶…ãˆã‚‹ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®ã†ã¡ã€ä½å„ªå…ˆåº¦ã®ã‚‚ã®ã‚’é™¤å¤–
                            const exceedingAttr = attractionsExceedingClosingTime.find(a => 
                                (attr.translatedName || attr.name) === a.name
                            );
                            if (exceedingAttr && exceedingAttr.priority === 'low') {
                                return false; // ä½å„ªå…ˆåº¦ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’é™¤å¤–
                            }
                            return true;
                        });
                        
                        if (filteredAttractions.length < 2) {
                            alert(lang['insufficient-attractions']);
                            return;
                        }
                        
                        // å„ªå…ˆåº¦é †ã«ã‚½ãƒ¼ãƒˆï¼ˆé«˜â†’ä¸­â†’ä½ï¼‰
                        const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                        const sortedAttractions = [...filteredAttractions].sort((a, b) => {
                            return priorityOrder[a.priority] - priorityOrder[b.priority];
                        });
                        
                        const newRoute = nearestNeighborTSP(sortedAttractions);
                        selectedAttractions = filteredAttractions; // é¸æŠãƒªã‚¹ãƒˆã‚‚æ›´æ–°
                        renderAttractionCards();
                        renderMarkers();
                        updateAttractionList();
                        drawRoute(newRoute);
                        // å†ä½œæˆå¾Œã¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã›ãšã«ç›´æ¥ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤º
                        renderRouteList(newRoute, currentTimeMinutes, exitTimeMinutes, walkingSpeedMetersPerMinute);
                    } else {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’é¸æŠã—ãŸå ´åˆã€ä½•ã‚‚ã—ãªã„ï¼ˆãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ãªã„ï¼‰
                        return;
                    }
                });
                return; // éåŒæœŸå‡¦ç†ã®ãŸã‚ã€ã“ã“ã§return
            }
            
            // é€šå¸¸ã®è¡¨ç¤ºå‡¦ç†
            renderRouteList(route, currentTimeMinutes, exitTimeMinutes, walkingSpeedMetersPerMinute);
        }
        
        // ãƒ«ãƒ¼ãƒˆãƒªã‚¹ãƒˆã‚’æç”»ã™ã‚‹é–¢æ•°ï¼ˆä¼‘æ†©æ©Ÿèƒ½ä»˜ãï¼‰
        function renderRouteList(route, startTimeMinutes, exitTimeMinutes, walkingSpeedMetersPerMinute) {
            // ãƒ«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            currentRouteData = route.map((point, index) => ({
                ...point,
                originalIndex: index,
                isBreak: false
            }));
            currentRouteStartTime = startTimeMinutes;
            currentRouteExitTime = exitTimeMinutes;
            currentWalkingSpeed = walkingSpeedMetersPerMinute;
            
            const resultList = document.getElementById('resultList');
            resultList.innerHTML = '';
            
            let currentTimeMinutes = startTimeMinutes;
            
            currentRouteData.forEach((point, index) => {
                const li = document.createElement('li');
                li.dataset.index = index;
                li.dataset.isBreak = point.isBreak ? 'true' : 'false';
                
                // ã‚¯ãƒªãƒƒã‚¯ã§ä¼‘æ†©ã‚’è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ï¼ˆã‚¢ã‚¤ãƒ†ãƒ ã®ä¸‹ã«è¿½åŠ ï¼‰
                li.addEventListener('dblclick', function(e) {
                    if (!point.isBreak) {
                        addBreak(index + 1);
                    }
                });
                
                if (point.isBreak) {
                    // ä¼‘æ†©ã‚¢ã‚¤ãƒ†ãƒ 
                    li.classList.add('break-item');
                    const breakDuration = point.breakDuration || 30;
                    const lang = i18n[currentLanguage] || i18n['ja'];
                    li.innerHTML = `
                        <span class="route-index">â˜•</span>
                        <div style="flex: 1;">
                            <div><strong>â˜• ${lang['break'] || 'ä¼‘æ†©'}</strong></div>
                            <div class="break-controls">
                                <label style="font-size: 0.85rem; color: #666;">${lang['duration'] || 'æ‰€è¦'}:</label>
                                <input type="number" class="break-duration-input" value="${breakDuration}" min="5" max="180" step="5" 
                                       onchange="updateBreakDuration(${index}, this.value)">
                                <span style="font-size: 0.85rem; color: #666;">${lang['minutes'] || 'åˆ†'}</span>
                                <button class="break-remove-btn" onclick="removeBreak(${index})">${lang['delete'] || 'å‰Šé™¤'}</button>
                            </div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">
                                ${lang['arrival'] || 'åˆ°ç€'}: ${minutesToTime(currentTimeMinutes)} | ${lang['departure'] || 'å‡ºç™º'}: ${minutesToTime(currentTimeMinutes + breakDuration)}
                            </div>
                        </div>
                    `;
                    currentTimeMinutes += breakDuration;
                } else {
                    // é€šå¸¸ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³
                    const priorityColor = point.priority === 'high' ? '#FF69B4' : 
                                        point.priority === 'low' ? '#D3D3D3' : '#DDA0DD';
                    const icon = point.icon || 'ğŸ¡';
                    
                    // ç§»å‹•æ™‚é–“ã®è¨ˆç®—
                    let travelMinutes = 0;
                    if (index > 0) {
                        const prevPoint = currentRouteData[index - 1];
                        if (!prevPoint.isBreak && prevPoint.lat && prevPoint.lng) {
                            const distance = calculateDistance(
                                prevPoint.lat, prevPoint.lng,
                                point.lat, point.lng
                            );
                            travelMinutes = Math.ceil(distance / walkingSpeedMetersPerMinute);
                        }
                    }
                    
                    // åˆ°ç€æ™‚åˆ»
                    const arrivalTime = minutesToTime(currentTimeMinutes);
                    
                    // å¾…ã¡æ™‚é–“ï¼ˆåˆ°ç€æ™‚åˆ»ã«æœ€ã‚‚è¿‘ã„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼‰
                    const officialId = parseInt(point.official_id) || null;
                    const waitingData = officialId ? getWaitingTimeAtTime(officialId, currentTimeMinutes) : { waiting_minutes: point.waiting_minutes || 0, timestamp: null };
                    const waitingMinutes = waitingData.waiting_minutes;
                    const waitingTimestamp = waitingData.timestamp;
                    
                    // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³æ‰€è¦æ™‚é–“
                    const durationMinutes = point.duration_minutes || 5;
                    
                    // å‡ºç™ºæ™‚åˆ»ï¼ˆåˆ°ç€ + å¾…ã¡æ™‚é–“ + æ‰€è¦æ™‚é–“ï¼‰
                    const departureTimeMinutes = currentTimeMinutes + waitingMinutes + durationMinutes;
                    const departureTime = minutesToTime(departureTimeMinutes);
                    
                    // é–‰åœ’æ™‚åˆ»ã‚’è¶…ãˆã‚‹å ´åˆã¯è­¦å‘Šã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ï¼ˆåˆ°ç€æ™‚åˆ»ã§åˆ¤å®šï¼‰
                    const isExceedingClosingTime = currentTimeMinutes > exitTimeMinutes;
                    const warningStyle = isExceedingClosingTime ? 'background-color: #ffebee; border-left-color: #f44336;' : '';
                    
                    // æ¬¡ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®ç§»å‹•æ™‚é–“ã‚’åŠ ç®—
                    currentTimeMinutes = departureTimeMinutes + travelMinutes;
                    
                    // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®é †ç•ªã‚’è¨ˆç®—ï¼ˆä¼‘æ†©ã‚’é™¤ãï¼‰
                    const attractionIndex = currentRouteData.slice(0, index).filter(item => !item.isBreak).length + 1;
                    
                    const lang = i18n[currentLanguage] || i18n['ja'];
                    li.innerHTML = `
                        <span class="route-index">${attractionIndex}</span>
                        <div style="flex: 1; ${warningStyle}">
                            <div><strong>${icon} ${point.translatedName || point.name}</strong> <small style="color: ${priorityColor};">[${lang['priority']}: ${getPriorityText(point.priority)}]</small>${isExceedingClosingTime ? ` <span style="color: #f44336; font-weight: bold;">${lang['closing-time-exceeded-warning']}</span>` : ''}</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">
                                ${travelMinutes > 0 ? `${lang['travel']}: ${travelMinutes}${lang['minutes']} â†’ ` : ''}${lang['arrival']}: ${arrivalTime} | ${lang['waiting']}: ${waitingMinutes}${lang['minutes']}${waitingTimestamp ? ` (${formatTimestamp(waitingTimestamp)} ${lang['at-time']})` : ''} | ${lang['duration']}: ${durationMinutes}${lang['minutes']} | ${lang['departure']}: ${departureTime}
                            </div>
                        </div>
                    `;
                    
                    // jQuery UIã®SortableãŒæœ‰åŠ¹ãªå ´åˆã¯ã€HTML5ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¯ç„¡åŠ¹åŒ–
                    // ï¼ˆjQuery UIã®SortableãŒè‡ªå‹•çš„ã«å‡¦ç†ã™ã‚‹ãŸã‚ï¼‰
                }
                
                resultList.appendChild(li);
            });

            // jQuery UIã®Sortableã‚’åˆæœŸåŒ–
            if (typeof jQuery !== 'undefined' && typeof jQuery.ui !== 'undefined') {
                // æ—¢å­˜ã®Sortableã‚’ç ´æ£„ï¼ˆå†åˆæœŸåŒ–ã®ãŸã‚ï¼‰
                if (jQuery('#resultList').hasClass('ui-sortable')) {
                    jQuery('#resultList').sortable('destroy');
                }
                
                jQuery('#resultList').sortable({
                    items: 'li',
                    cursor: 'move',
                    opacity: 0.8,
                    tolerance: 'pointer',
                    placeholder: 'sortable-placeholder',
                    start: function(e, ui) {
                        ui.placeholder.height(ui.item.height());
                        ui.placeholder.css('background', 'rgba(221, 160, 221, 0.3)');
                        ui.placeholder.css('border', '2px dashed #DDA0DD');
                        ui.placeholder.css('border-radius', '10px');
                    },
                    update: function(e, ui) {
                        // ä¸¦ã³æ›¿ãˆå¾Œã«ãƒ«ãƒ¼ãƒˆã‚’å†è¨ˆç®—
                        const newOrder = [];
                        jQuery('#resultList li').each(function() {
                            const itemIndex = parseInt(jQuery(this).data('index'));
                            if (itemIndex !== undefined && currentRouteData && currentRouteData[itemIndex] !== undefined) {
                                newOrder.push(itemIndex);
                            }
                        });
                        
                        // æ–°ã—ã„é †åºã§ãƒ«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å†æ§‹ç¯‰
                        if (newOrder.length === currentRouteData.length) {
                            const reorderedData = newOrder.map(idx => currentRouteData[idx]);
                            currentRouteData = reorderedData;
                            // ãƒ«ãƒ¼ãƒˆã‚’å†è¨ˆç®—ï¼ˆSortableã®å†åˆæœŸåŒ–ã‚’é¿ã‘ã‚‹ãŸã‚ã€ç›´æ¥renderRouteListã‚’å‘¼ã°ãšã«recalculateRouteã‚’å‘¼ã¶ï¼‰
                            recalculateRoute();
                        }
                    }
                });
            }

            document.getElementById('resultBox').classList.remove('hidden');
            updateResultTitleDisplay();
        }

        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
        let draggedElement = null;
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            
            // ã™ã¹ã¦ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã‚’è¡¨ç¤º
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.add('show');
            });
        }

        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
                zone.classList.remove('show');
            });
            draggedElement = null;
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            this.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã¸ã®ãƒ‰ãƒ­ãƒƒãƒ—
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (!draggedElement) return false;
            
            const dropIndex = parseInt(this.dataset.index);
            const dragIndex = parseInt(draggedElement.dataset.index);
            
            // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã¸ã®ãƒ‰ãƒ­ãƒƒãƒ—ã¯å¸¸ã«ä¼‘æ†©ã‚’è¿½åŠ 
            addBreak(dropIndex);
            
            this.classList.remove('drag-over');
            this.classList.remove('show');
            return false;
        }

        // ãƒ«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã¸ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
        function handleItemDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            if (draggedElement && draggedElement !== this) {
                this.style.borderTop = '3px solid #DDA0DD';
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        // ãƒ«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã¸ã®ãƒ‰ãƒ­ãƒƒãƒ—
        function handleItemDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (!draggedElement || draggedElement === this) return false;
            
            const dropIndex = parseInt(this.dataset.index);
            const dragIndex = parseInt(draggedElement.dataset.index);
            
            // ãƒ«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’ç§»å‹•
            moveRouteItem(dragIndex, dropIndex);
            
            this.style.borderTop = '';
            return false;
        }

        // ãƒ«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰ã®ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–
        function handleItemDragLeave(e) {
            this.style.borderTop = '';
        }

        // ä¼‘æ†©ã‚’è¿½åŠ 
        function addBreak(index) {
            if (!currentRouteData) return;
            
            const lang = i18n[currentLanguage] || i18n['ja'];
            const breakItem = {
                isBreak: true,
                breakDuration: 30,
                name: lang['break'] || 'ä¼‘æ†©',
                translatedName: lang['break'] || 'ä¼‘æ†©'
            };
            
            currentRouteData.splice(index, 0, breakItem);
            recalculateRoute();
        }

        // æœ€å¾Œã«ä¼‘æ†©ã‚’è¿½åŠ 
        function addBreakAtEnd() {
            if (!currentRouteData) return;
            addBreak(currentRouteData.length);
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
        window.addBreakAtEnd = addBreakAtEnd;

        // ä¼‘æ†©ã‚’å‰Šé™¤
        function removeBreak(index) {
            if (!currentRouteData || !currentRouteData[index] || !currentRouteData[index].isBreak) return;
            
            currentRouteData.splice(index, 1);
            recalculateRoute();
        }

        // ä¼‘æ†©æ™‚é–“ã‚’æ›´æ–°
        function updateBreakDuration(index, duration) {
            if (!currentRouteData || !currentRouteData[index] || !currentRouteData[index].isBreak) return;
            
            currentRouteData[index].breakDuration = parseInt(duration) || 30;
            recalculateRoute();
        }

        // ãƒ«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’ç§»å‹•
        function moveRouteItem(fromIndex, toIndex) {
            if (!currentRouteData || fromIndex === toIndex) return;
            
            const item = currentRouteData.splice(fromIndex, 1)[0];
            currentRouteData.splice(toIndex, 0, item);
            recalculateRoute();
        }

        // ãƒ«ãƒ¼ãƒˆã‚’å†è¨ˆç®—
        function recalculateRoute() {
            if (!currentRouteData || currentRouteData.length === 0) return;
            
            // ä¼‘æ†©ä»¥å¤–ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ã‚’æŠ½å‡º
            const attractionsOnly = currentRouteData.filter(item => !item.isBreak);
            
            renderRouteList(currentRouteData, currentRouteStartTime, currentRouteExitTime, currentWalkingSpeed);
            
            // åœ°å›³ã‚‚æ›´æ–°
            if (attractionsOnly.length > 0) {
                drawRoute(attractionsOnly);
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
        window.addBreak = addBreak;
        window.removeBreak = removeBreak;
        window.updateBreakDuration = updateBreakDuration;

        // è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‹ã
        function openSettings() {
            const panel = document.getElementById('settingsPanel');
            if (!panel) {
                console.error('è¨­å®šãƒ‘ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            panel.classList.remove('hidden');
            // ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
            const currentTitle = localStorage.getItem('routeResultTitle') || 'ã¾ã‚ã‚‹ã˜ã‚…ã‚“ã°ã‚“';
            const select = document.getElementById('resultTitleSelect');
            if (select) {
                select.value = currentTitle;
            }
            // èƒŒæ™¯ã‚¹ã‚¿ã‚¤ãƒ«ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
            const currentBackground = localStorage.getItem('backgroundStyle') || 'checkerboard';
            const backgroundSelect = document.getElementById('backgroundStyleSelect');
            if (backgroundSelect) {
                backgroundSelect.value = currentBackground;
            }
            // ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–æ–¹æ³•ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
            const currentOptimization = getRouteOptimizationMethod();
            const optimizationSelect = document.getElementById('routeOptimizationSelect');
            if (optimizationSelect) {
                optimizationSelect.value = currentOptimization;
            }
        }

        // è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        function closeSettings() {
            const panel = document.getElementById('settingsPanel');
            if (panel) {
                panel.classList.add('hidden');
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹ï¼ˆonclickå±æ€§ã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ï¼‰
        window.openSettings = openSettings;
        window.closeSettings = closeSettings;

        // èƒŒæ™¯ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
        function updateBackgroundStyle() {
            const select = document.getElementById('backgroundStyleSelect');
            const style = select.value;
            localStorage.setItem('backgroundStyle', style);
            
            // bodyã®ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°
            document.body.classList.remove('checkerboard', 'gradient');
            document.body.classList.add(style);
        }

        // çµæœã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
        function updateResultTitle() {
            const select = document.getElementById('resultTitleSelect');
            const title = select.value;
            localStorage.setItem('routeResultTitle', title);
            updateResultTitleDisplay();
        }

        // çµæœã‚¿ã‚¤ãƒˆãƒ«ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateResultTitleDisplay() {
            const titleElement = document.getElementById('resultTitle');
            if (titleElement) {
                const savedTitle = localStorage.getItem('routeResultTitle') || 'ã¾ã‚ã‚‹ã˜ã‚…ã‚“ã°ã‚“';
                titleElement.textContent = `ğŸ“Š ${savedTitle}`;
            }
        }

        // ã‚¢ã‚¤ã‚³ãƒ³æ³¨é‡ˆã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleIconAnnotations() {
            const list = document.getElementById('iconAnnotationList');
            const link = document.getElementById('iconAnnotationLink');
            
            if (list.classList.contains('show')) {
                list.classList.remove('show');
                link.textContent = i18n[currentLanguage]['view-annotations'];
            } else {
                // å…¨ã¦ã®ã‚¢ã‚¤ã‚³ãƒ³æ³¨é‡ˆã‚’ç”Ÿæˆ
                const genreMap = {
                    'theater': { icon: 'ğŸ›ï¸', description: 'åº§ã‚Œã‚‹ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå±‹å†…ã‚·ã‚¢ã‚¿ãƒ¼å‹ï¼‰' },
                    'ride': { icon: 'ğŸ ', description: 'ãƒ©ã‚¤ãƒ‰' },
                    'coaster': { icon: 'ğŸ¢', description: 'ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼' },
                    'walking': { icon: 'ğŸ°', description: 'æ­©ã„ã¦æ¢ç´¢ç³»' },
                    'greeting': { icon: 'ğŸ‘‹', description: 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚°ãƒªãƒ¼ãƒ†ã‚£ãƒ³ã‚°' },
                    'other': { icon: 'ğŸ¡', description: 'ãã®ä»–' }
                };
                
                list.innerHTML = '';
                Object.values(genreMap).forEach(genre => {
                    const item = document.createElement('div');
                    item.className = 'icon-annotation-item';
                    item.innerHTML = `<strong>${genre.icon}</strong> ${genre.description}`;
                    list.appendChild(item);
                });
                
                list.classList.add('show');
                link.textContent = 'æ³¨é‡ˆã‚’é–‰ã˜ã‚‹';
            }
        }

        // è¨­å®šãƒ‘ãƒãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('DOMContentLoaded', () => {
            const panel = document.getElementById('settingsPanel');
            if (panel) {
                // åˆæœŸçŠ¶æ…‹ã§ç¢ºå®Ÿã«éè¡¨ç¤ºã«ã™ã‚‹
                panel.classList.add('hidden');
                panel.addEventListener('click', (e) => {
                    if (e.target === panel) {
                        closeSettings();
                    }
                });
            }
            // åˆæœŸè¡¨ç¤ºæ™‚ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
            updateResultTitleDisplay();
            // åˆæœŸè¡¨ç¤ºæ™‚ã«èƒŒæ™¯ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
            const savedBackground = localStorage.getItem('backgroundStyle') || 'checkerboard';
            document.body.classList.add(savedBackground);
            
            // æ™‚é–“å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆæœŸå€¤ã‚’æ¤œè¨¼
            const startTimeInput = document.getElementById('startTime');
            const exitTimeInput = document.getElementById('exitTimeInput');
            if (startTimeInput) {
                if (startTimeInput.value < OPERATING_HOURS.min || startTimeInput.value > OPERATING_HOURS.max) {
                    startTimeInput.value = OPERATING_HOURS.min;
                }
            }
            if (exitTimeInput) {
                if (exitTimeInput.value < OPERATING_HOURS.min || exitTimeInput.value > OPERATING_HOURS.max) {
                    exitTimeInput.value = OPERATING_HOURS.max;
                }
            }
        });

        // ãƒ«ãƒ¼ãƒˆã‚¯ãƒªã‚¢
        function clearRoute() {
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            document.getElementById('resultBox').classList.add('hidden');
        }

        // åœ°å›³ã‚’ç”»åƒã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        async function downloadMapAsImage() {
            if (!map) {
                alert('åœ°å›³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            // html2canvasãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (typeof html2canvas === 'undefined') {
                alert('ç”»åƒä¿å­˜æ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                // html2canvasã‚’å‹•çš„ã«èª­ã¿è¾¼ã‚€
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = () => {
                    setTimeout(() => downloadMapAsImage(), 500);
                };
                script.onerror = () => {
                    alert('ç”»åƒä¿å­˜æ©Ÿèƒ½ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                };
                document.head.appendChild(script);
                return;
            }

            try {
                const mapContainer = document.querySelector('.park-map');
                if (!mapContainer || !mapContainer.classList.contains('visible')) {
                    alert('åœ°å›³ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
                    return;
                }

                // åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠã‚’ç”»åƒåŒ–
                const canvas = await html2canvas(mapContainer, {
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    scale: 2, // é«˜è§£åƒåº¦
                    logging: false,
                    allowTaint: true
                });

                // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                link.download = `route-map-${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                const message = i18n[currentLanguage] && i18n[currentLanguage]['map-downloaded'] || 'åœ°å›³ã‚’ç”»åƒã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ';
                alert(message);
            } catch (error) {
                console.error('åœ°å›³ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert('åœ°å›³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ«ãƒ¼ãƒˆé †åºã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        async function copyRouteToClipboard() {
            const resultList = document.getElementById('resultList');
            if (!resultList || resultList.children.length === 0) {
                alert('ãƒ«ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            try {
                let routeText = '';
                const listItems = resultList.querySelectorAll('li');
                
                listItems.forEach((item, index) => {
                    const nameElement = item.querySelector('strong');
                    const detailsElement = item.querySelector('div[style*="font-size"]');
                    
                    if (nameElement) {
                        const name = nameElement.textContent.trim();
                        routeText += `${index + 1}. ${name}\n`;
                    }
                    
                    if (detailsElement) {
                        const details = detailsElement.textContent.trim();
                        routeText += `   ${details}\n`;
                    }
                    
                    routeText += '\n';
                });

                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(routeText);
                    const message = i18n[currentLanguage] && i18n[currentLanguage]['route-copied'] || 'ãƒ«ãƒ¼ãƒˆé †åºã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
                    alert(message);
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ä½¿ç”¨
                    const textarea = document.createElement('textarea');
                    textarea.value = routeText;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    const message = i18n[currentLanguage] && i18n[currentLanguage]['route-copied'] || 'ãƒ«ãƒ¼ãƒˆé †åºã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
                    alert(message);
                }
            } catch (error) {
                console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
                const message = i18n[currentLanguage] && i18n[currentLanguage]['copy-failed'] || 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ';
                alert(message);
            }
        }

        // Firestoreã‹ã‚‰ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        async function loadAttractionsMetadata() {
            try {
                if (!window.db) {
                    console.warn('FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                const snapshot = await window.db.collection('attractions_metadata').get();
                attractionsMetadata = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    attractionsMetadata[data.official_id] = {
                        duration_minutes: data.duration_minutes || null,
                        genre: data.genre || ''
                    };
                });
                console.log(`${Object.keys(attractionsMetadata).length}ä»¶ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            } catch (error) {
                // æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è­¦å‘Šã®ã¿ï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãªã—ã§ã‚‚å‹•ä½œå¯èƒ½ï¼‰
                if (error.code === 'permission-denied' || error.message.includes('permissions')) {
                    console.warn('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
                } else {
                    console.error('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
        }

        // Firestoreã«ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆç®¡ç†ãƒšãƒ¼ã‚¸ç”¨ï¼‰
        async function saveAttractionMetadata(officialId, durationMinutes, genre) {
            try {
                if (!window.db) {
                    console.warn('FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return false;
                }
                const user = window.auth ? window.auth.currentUser : null;
                if (!user) {
                    alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚');
                    throw new Error('User not authenticated.');
                }
                await window.db.collection('attractions_metadata').doc(officialId).set({
                    official_id: officialId,
                    duration_minutes: durationMinutes ? parseInt(durationMinutes) : null,
                    genre: genre || '',
                    updated_at: firebase.firestore.FieldValue.serverTimestamp(),
                    updated_by: user.email || user.uid
                }, { merge: true });
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                attractionsMetadata[officialId] = {
                    duration_minutes: durationMinutes ? parseInt(durationMinutes) : null,
                    genre: genre || ''
                };
                
                return true;
            } catch (error) {
                console.error('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }


        // åˆæœŸåŒ–
        window.addEventListener('load', async () => {
            // è¨€èªã‚’é©ç”¨
            document.documentElement.lang = currentLanguage;
            applyLanguage();
            updateLanguageLinks();
            // Buy Me a Coffeeãƒœã‚¿ãƒ³ã®data-textå±æ€§ã‚’æ›´æ–°ï¼ˆæ—¥æœ¬èªä»¥å¤–ã®å ´åˆï¼‰
            if (currentLanguage !== 'ja') {
                updateSupportButton();
            }
            
            await loadWaitingTimes();
            await loadAttractionsMetadata();
            await loadAttractionsFromDB();
        });
    </script>
</body>
</html>
