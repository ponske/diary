# Route Optimizer ドキュメント

## 概要

Route Optimizerは、東京ディズニーランドのアトラクションを効率的に回るためのルート最適化Webアプリケーションです。ユーザーが選択したアトラクションから、距離や時間を考慮して最適な回る順序を計算し、地図上に表示します。

### 主な機能

1. **アトラクション選択機能**
   - グリッド表示でアトラクションを選択
   - 優先度設定（高・中・低）
   - リアルタイムの待ち時間データを考慮

2. **ルート最適化機能**
   - 距離最短最適化
   - 時間最短最適化（待ち時間・所要時間・移動時間を考慮）
   - 選択順での表示

3. **地図表示機能**
   - Leafletを使用したインタラクティブマップ
   - ルートの可視化
   - マーカー表示

4. **時間管理機能**
   - 開始時刻の設定
   - 退園時刻の設定（閉園まで / 時刻指定）
   - 各アトラクションの到着時刻・出発時刻の表示
   - 閉園時刻超過の警告

5. **多言語対応**
   - 日本語・英語対応
   - アトラクション名の翻訳

6. **カスタマイズ機能**
   - 背景テーマ（チェック柄・グラデーション）
   - 結果タイトルのカスタマイズ
   - ルート最適化方法の選択

7. **エクスポート機能**
   - 地図を画像として保存
   - ルート順序をテキストとしてクリップボードにコピー

8. **休憩機能**
   - ルート途中に休憩を追加
   - 休憩時間の調整

---

## 詳細仕様

### 1. 技術スタック

- **フロントエンド**: HTML5, CSS3, JavaScript (ES6+)
- **地図ライブラリ**: Leaflet 1.9.4
- **画像処理**: html2canvas
- **データソース**: 
  - `attractions.json` - アトラクション情報
  - `waiting_times.json` - 待ち時間データ
  - Firestore - アトラクションメタデータ（所要時間、ジャンル）

### 2. データ構造

#### 2.1 アトラクションデータ構造

```javascript
{
  id: number,                    // 内部ID
  name: string,                   // クリーンな名前
  translatedName: string,         // 翻訳された名前
  originalName: string,           // 元の名前
  official_id: string,            // 公式ID
  lat: number,                    // 緯度
  lng: number,                    // 経度
  exit_lat: number | null,        // 出口緯度
  exit_lng: number | null,        // 出口経度
  area_name: string,              // エリア名
  genre: string,                  // ジャンル（theater, ride, coaster, walking, greeting, other）
  icon: string,                   // アイコン（絵文字）
  iconDescription: string,        // アイコンの説明
  duration_minutes: number,       // 所要時間（分）
  is_seated: boolean,             // 座れるかどうか
  waiting_minutes: number,        // 待ち時間（分）
  priority: string                // 優先度（high, medium, low）
}
```

#### 2.2 待ち時間データ構造

```javascript
{
  attr_id: string,                // アトラクションID
  waiting_minutes: number,         // 現在の待ち時間
  updated_at: timestamp,          // 更新日時
  time_series: [                  // 時系列データ
    {
      timestamp: timestamp,       // 時刻
      waiting_minutes: number      // その時刻の待ち時間
    }
  ]
}
```

#### 2.3 ルートデータ構造

```javascript
[
  {
    ...attractionData,            // アトラクションデータ
    isBreak: boolean,             // 休憩かどうか
    breakDuration: number,        // 休憩時間（分、休憩の場合のみ）
    travelMinutes: number,        // 移動時間（分）
    arrivalTime: string,          // 到着時刻（HH:MM形式）
    departureTime: string,        // 出発時刻（HH:MM形式）
    waitingMinutes: number,       // 待ち時間（分）
    durationMinutes: number       // 所要時間（分）
  }
]
```

### 3. 主要機能の詳細

#### 3.1 アトラクション選択機能

**実装場所**: `renderAttractionCards()`, `toggleAttraction()`

- グリッド形式でアトラクションを表示
- クリックで選択/解除
- 選択されたアトラクションは優先度バッジと順番番号を表示
- ジャンルに応じたアイコン表示
- 選択状態は`selectedAttractions`配列で管理

**優先度設定**:
- 高優先度: ピンク色（#FF69B4）
- 中優先度: パープル色（#DDA0DD）
- 低優先度: グレー色（#D3D3D3）

#### 3.2 ルート最適化アルゴリズム

**3.2.1 距離最短最適化（Nearest Neighbor TSP）**

**実装場所**: `nearestNeighborTSP()`

- 最近傍法を使用した巡回セールスマン問題の近似解
- 優先度順（高→中→低）にソート後、各優先度グループ内で最適化
- 距離計算はHaversine公式を使用

**アルゴリズム**:
1. 最初の点を開始点とする
2. 未訪問の点の中で最も近い点を選択
3. すべての点を訪問するまで繰り返し

**3.2.2 時間最短最適化（Shortest Time TSP）**

**実装場所**: `shortestTimeTSP()`

- 移動時間 + 待ち時間 + 所要時間の合計が最小になるルートを計算
- 到着時刻に応じた待ち時間を考慮
- 歩行速度: 分速80m（デフォルト）

**アルゴリズム**:
1. 優先度順（高→中→低）にソート
2. 各ステップで、未訪問の点の中で総時間が最小の点を選択
3. 総時間 = 移動時間 + 待ち時間（到着時刻に応じた値） + 所要時間

**3.2.3 選択順表示**

- ユーザーが選択した順序をそのまま使用

#### 3.3 待ち時間データの取得

**実装場所**: `getWaitingTimeAtTime()`, `loadWaitingTimes()`

- `waiting_times.json`から待ち時間データを読み込み
- 到着時刻に最も近い時刻の待ち時間データを使用
- 24時間を超える場合は反対側を考慮（例: 23:00と01:00は2時間の差）

**データ取得ロジック**:
1. アトラクションの`official_id`で待ち時間データを検索
2. `time_series`配列から到着時刻に最も近いデータを選択
3. データがない場合は最新の`waiting_minutes`を使用

#### 3.4 時間管理機能

**実装場所**: `displayResult()`, `renderRouteList()`

**開始時刻**:
- デフォルト: 09:00
- 営業時間: 09:00 - 21:00
- 入力検証: `validateStartTime()`

**退園時刻**:
- オプション1: 閉園まで（21:00）
- オプション2: 時刻指定（10:00 - 21:00）
- 入力検証: `validateExitTime()`

**時刻計算**:
- 各アトラクションの到着時刻 = 前のアトラクションの出発時刻 + 移動時間
- 出発時刻 = 到着時刻 + 待ち時間 + 所要時間
- 移動時間 = 距離 / 歩行速度（分速80m）

**閉園時刻超過の警告**:
- 到着時刻が退園時刻を超えるアトラクションを検出
- 3択ダイアログで確認:
  1. そのまま表示
  2. 低優先度のものを削除し再作成
  3. キャンセル

#### 3.5 地図表示機能

**実装場所**: `initMap()`, `renderMarkers()`, `drawRoute()`

**地図ライブラリ**: Leaflet 1.9.4

**機能**:
- OpenStreetMapタイルレイヤーを使用
- ディズニーランド中心座標: [35.6329, 139.8804]
- 初期ズームレベル: 15
- 選択されたアトラクションにマーカーを表示
- ルートをポリラインで表示
- ルート全体が表示されるように自動調整

**マーカー**:
- 優先度に応じた色分け
- ポップアップでアトラクション名と優先度を表示
- 順番番号を表示

#### 3.6 多言語対応

**実装場所**: `i18n`オブジェクト, `applyLanguage()`, `translateAttractionName()`

**対応言語**:
- 日本語（ja）
- 英語（en）

**翻訳対象**:
- UI要素（ボタン、ラベルなど）
- アトラクション名（`attractionNames`オブジェクト）
- メッセージ

**言語切り替え**:
- `localStorage`に保存
- ページ読み込み時に適用
- 言語リンクで切り替え可能

#### 3.7 カスタマイズ機能

**3.7.1 背景テーマ**

**実装場所**: `updateBackgroundStyle()`

- チェック柄背景（デフォルト）
- グラデーション背景
- `localStorage`に保存

**3.7.2 結果タイトル**

**実装場所**: `updateResultTitle()`

- カスタムタイトルを設定可能
- デフォルト: "まわるじゅんばん"
- `localStorage`に保存

**3.7.3 ルート最適化方法**

**実装場所**: `getRouteOptimizationMethod()`, `updateRouteOptimization()`

- 距離最短（デフォルト）
- 時間最短
- 選択順
- `localStorage`に保存

#### 3.8 エクスポート機能

**3.8.1 地図を画像として保存**

**実装場所**: `downloadMapAsImage()`

- html2canvasを使用して地図コンテナを画像化
- PNG形式でダウンロード
- 高解像度（scale: 2）
- ファイル名: `route-map-{timestamp}.png`

**3.8.2 ルート順序をクリップボードにコピー**

**実装場所**: `copyRouteToClipboard()`

- ルートリストの内容をテキスト形式でクリップボードにコピー
- 各アトラクションの名前と詳細情報を含む

#### 3.9 休憩機能

**実装場所**: `addBreak()`, `removeBreak()`, `updateBreakDuration()`, `addBreakAtEnd()`

**機能**:
- ルート途中に休憩を追加
- 休憩時間を調整（デフォルト: 30分）
- 休憩の削除
- ルート末尾に休憩を追加

**休憩データ**:
```javascript
{
  isBreak: true,
  breakDuration: number,        // 休憩時間（分）
  arrivalTime: string,          // 到着時刻
  departureTime: string         // 出発時刻（到着時刻 + 休憩時間）
}
```

### 4. UIコンポーネント

#### 4.1 ヘッダー

- タイトル: "WonderPasNavi - ルートを決める"
- 背景テーマに応じたスタイル
- 今日の待ち時間へのリンク

#### 4.2 コントロールパネル

**セクション1: アトラクション選択**
- 優先度ボタン（高・中・低）
- アトラクショングリッド
- アイコン注釈リンク

**セクション2: 選択されたアトラクションリスト**
- 選択されたアトラクションの一覧
- 削除ボタン
- 待ち時間・所要時間の表示

**セクション3: 時間設定**
- 開始時刻入力
- 退園オプション（閉園まで / 時刻指定）
- 退園時刻入力（時刻指定の場合）

**セクション4: アクションボタン**
- ルートを決めるボタン
- クリアボタン
- 表示設定ボタン

#### 4.3 設定パネル

- 結果タイトルの選択
- 背景スタイルの選択
- ルート最適化方法の選択

#### 4.4 結果ボックス

- 総距離の表示
- アトラクション数の表示
- アクションボタン（地図保存、コピー、休憩追加）
- ルートリスト（各アトラクションの詳細情報）

#### 4.5 地図表示エリア

- Leafletマップ
- マーカー表示
- ルート表示

### 5. データフロー

#### 5.1 初期化フロー

1. ページ読み込み
2. 言語設定の適用
3. 待ち時間データの読み込み（`loadWaitingTimes()`）
4. アトラクションメタデータの読み込み（`loadAttractionsMetadata()`）
5. アトラクションデータの読み込み（`loadAttractionsFromDB()`）
6. グリーティング施設の追加（`addGreetingAttractions()`）
7. アトラクションカードの描画（`renderAttractionCards()`）

#### 5.2 ルート最適化フロー

1. ユーザーがアトラクションを選択
2. 優先度を設定
3. 開始時刻・退園時刻を設定
4. 「ルートを決める」ボタンをクリック
5. 最適化方法に応じてルートを計算
6. 地図にルートを描画（`drawRoute()`）
7. 結果を表示（`displayResult()`）
8. 閉園時刻超過チェック
9. ルートリストを描画（`renderRouteList()`）

#### 5.3 待ち時間データの使用フロー

1. `waiting_times.json`を読み込み
2. 各アトラクションの`official_id`で待ち時間データを検索
3. ルート計算時に、各アトラクションの到着時刻を計算
4. `getWaitingTimeAtTime()`で到着時刻に最も近い待ち時間を取得
5. 待ち時間を考慮してルートを最適化

### 6. ジャンル分類

アトラクションは以下のジャンルに分類されます:

- **theater** (🏛️): 座れるアトラクション（屋内シアター型）
- **ride** (🎠): ライド
- **coaster** (🎢): コースター
- **walking** (🏰): 歩いて探索系
- **greeting** (👋): キャラクターグリーティング
- **other** (🎡): その他

ジャンルは以下の方法で判定:
1. Firestoreのメタデータ（優先）
2. アトラクション名のキーワード判定（フォールバック）

### 7. 設定の永続化

以下の設定は`localStorage`に保存されます:

- `language`: 言語設定
- `backgroundStyle`: 背景スタイル
- `routeResultTitle`: 結果タイトル
- `routeOptimizationMethod`: ルート最適化方法

### 8. エラーハンドリング

- 待ち時間データの読み込みエラー: コンソールに警告、デフォルト値（0分）を使用
- アトラクションデータの読み込みエラー: フォールバックデータを使用
- メタデータの読み込みエラー: デフォルト判定を使用
- 地図の初期化エラー: 地図を表示しない
- 画像保存エラー: エラーメッセージを表示

### 9. パフォーマンス考慮事項

- 待ち時間データのキャッシュ無効化（最新データを取得）
- 地図の遅延初期化（ルート最適化時に初めて表示）
- マーカーの効率的な管理（既存マーカーの削除後に再描画）

### 10. 外部依存関係

- **Leaflet 1.9.4**: 地図表示
- **html2canvas**: 画像保存（動的読み込み）
- **OpenStreetMap**: 地図タイル
- **Firebase/Firestore**: メタデータ保存（オプション）

---

## iPhoneアプリ化への変換ポイント

### 1. 技術スタックの変更

- **Web → Native**: HTML/CSS/JS → Swift/SwiftUI
- **Leaflet → MapKit**: 地図ライブラリの変更
- **localStorage → UserDefaults**: データ永続化
- **JSONファイル → Core Data / CloudKit**: データ管理

### 2. UI/UXの変更

- **レスポンシブデザイン → ネイティブUI**: SwiftUIコンポーネントを使用
- **Webフォーム → ネイティブ入力**: DatePicker, Picker等を使用
- **モーダルダイアログ → Sheet/Alert**: SwiftUIの標準コンポーネント

### 3. 機能の実装方法

- **地図表示**: MapKitを使用
- **位置情報**: Core Locationを使用
- **ネットワーク**: URLSessionを使用
- **画像保存**: Photos Frameworkを使用
- **クリップボード**: UIPasteboardを使用

### 4. データ管理

- **アトラクションデータ**: Core DataまたはJSONファイル
- **待ち時間データ**: APIまたはローカルキャッシュ
- **ユーザー設定**: UserDefaults
- **メタデータ**: CloudKit（オプション）

### 5. オフライン対応

- アトラクションデータのローカル保存
- 待ち時間データのキャッシュ
- オフライン時の動作確認

### 6. パフォーマンス最適化

- バックグラウンドでのデータ取得
- 画像のキャッシュ
- 地図の効率的な描画

---

## ファイル構成

```
route-optimizer.html (3348行)
├── HTML構造
│   ├── ヘッダー
│   ├── コントロールパネル
│   ├── 設定パネル
│   ├── 結果ボックス
│   └── 地図表示エリア
├── CSSスタイル
│   ├── 基本スタイル
│   ├── 背景テーマ
│   ├── コンポーネントスタイル
│   └── レスポンシブデザイン
└── JavaScript機能
    ├── データ読み込み
    ├── UI操作
    ├── ルート最適化アルゴリズム
    ├── 地図表示
    ├── 時間管理
    └── エクスポート機能
```

---

## まとめ

Route Optimizerは、ディズニーランドのアトラクションを効率的に回るための包括的なルート最適化ツールです。距離や時間を考慮した最適化、リアルタイムの待ち時間データの活用、直感的なUI、多言語対応など、多くの機能を提供しています。

iPhoneアプリ化にあたっては、Web技術からネイティブ技術への変換、UI/UXの最適化、オフライン対応、パフォーマンス最適化などが重要なポイントとなります。

