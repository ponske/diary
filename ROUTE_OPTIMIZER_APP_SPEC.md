## WonderPasNavi ルート最適化 iPhoneアプリ仕様書

### 1. 概要

- **アプリ名（仮）**: WonderPasNavi – ルートを決める
- **対象プラットフォーム**: iOS（iPhone）
- **想定ユーザー**: 東京ディズニーランドを効率よく回りたいゲスト
- **目的**: ユーザーが行きたいアトラクションを選ぶと、移動距離や待ち時間・所要時間を考慮した「最適な回る順番」と、各アトラクションの到着／出発時刻を提示する。
- **ネットワーク前提**: アプリからFirebaseなどの外部データソースには接続しない。必要なデータはアプリ内に同梱したJSONファイルを読み取り専用で利用する。

---

### 2. 前提・非機能要件

- **オフライン前提**
  - ネットワーク接続がなくても全機能が動作する。
  - 待ち時間データ・アトラクション情報はアプリバンドル内のJSONとして同梱。
- **パフォーマンス**
  - 初回起動時のJSON読込は1秒以内を目標。
  - ルート最適化（20スポット程度まで）は1秒以内で完了することを目安。
- **データ更新**
  - 待ち時間データ／アトラクションデータの更新は「アプリのアップデート」により行う（アプリ自身はJSONを更新しない）。
- **永続化**
  - ユーザー設定は端末ローカル（例: UserDefaults 相当）に保存。
  - 個人情報やログイン機能は持たない。

---

### 3. 用語定義

- **アトラクション**: パーク内の個別施設（ライド、ショー、グリーティングなど）。
- **ルート**: ユーザーが回るアトラクションの順序と、その間の移動を含めた計画。
- **優先度**: 各アトラクションに対してユーザーが設定する重要度（高・中・低）。
- **待ち時間データ**: 各アトラクションの時刻ごとの想定待ち時間。
- **所要時間**: アトラクション体験にかかる時間（乗車中・鑑賞中など）。

---

### 4. 機能要件

#### 4.1 アプリ起動・初期化

- アプリ起動時に以下を実行する:
  - `attractions.json` を読み込み、アトラクション一覧を構築。
  - `waiting_times.json` を読み込み、待ち時間データを構築。
  - ユーザー設定（言語、ルート最適化方法、表示設定など）をローカルから読み出し適用。

#### 4.2 アトラクション一覧表示・選択

- ユーザーは「アトラクション一覧画面」でアトラクションをカード形式で閲覧・選択できる。
- 機能:
  - 検索／フィルタ（任意: エリア、ジャンル、アイコンなど）。
  - アトラクションカードをタップして「選択／解除」。
  - 選択済みアトラクションには
    - 選択順の番号
    - 優先度バッジ（高／中／低）
  を表示。
- 優先度:
  - 「高」「中」「低」ボタンのいずれかを選んだ状態でアトラクションを選択すると、その優先度が紐づく。
  - 優先度はルート最適化時の並び順に影響する（高 → 中 → 低の順で優先）。

#### 4.3 時間設定

- **開始時刻**
  - デフォルト: **09:00**
  - 入力可能範囲: **09:00 – 21:00**
  - 不正値（範囲外）の場合は自動的に許容範囲内に補正。

- **退園時刻**
  - オプション1: 「閉園まで」（固定で 21:00）
  - オプション2: 「時刻指定」
    - 入力可能範囲: **10:00 – 21:00**
  - 不正値は補正し、開始時刻よりも早い退園時刻が入力された場合はエラー表示。

#### 4.4 ルート最適化

- ユーザーが2つ以上のアトラクションを選択し、「ルートを決める」を実行するとルート最適化を行う。
- 最適化方法は3種類:
  1. **距離最短**  
     - 優先度「高 → 中 → 低」の順にソートしたうえで、各グループ内を「最近傍法」によるTSP近似で距離最短となる順に並べる。
  2. **時間最短**  
     - 優先度「高 → 中 → 低」にソート。
     - 各ステップで、「移動時間 + 待ち時間 + 所要時間」の合計が最小になる次のアトラクションを選択。
     - 待ち時間は「到着予定時刻」に最も近い時点のデータを利用。
  3. **選択順**  
     - ユーザーが選んだ順番をそのまま利用する。

- 歩行速度:
  - 分速 80m をデフォルトとする。
  - 距離から移動時間（分）を算出し、小数点は切り上げ。

#### 4.5 ルート結果表示

- 結果画面では以下を表示する:
  - 総移動距離（m単位、整数四捨五入）
  - アトラクション数
  - 各アトラクションについて:
    - 順番番号
    - 名称（現在の言語に応じた表示）
    - 到着時刻
    - 出発時刻
    - 待ち時間（分）
    - 体験時間（分）
    - 優先度
- 移動時間と時刻計算:
  - 初期 `currentTime = 開始時刻(分単位)`。
  - 各アトラクション:
    - 前の地点から距離を計算し、`travelMinutes = ceil(distance / 80)`。
    - 到着時刻 = `currentTime + travelMinutes`。
    - `arrivalTime` に最も近い待ち時間を取得。
    - 出発時刻 = `arrivalTime + waiting + duration`。
    - 次の `currentTime` = 出発時刻。

#### 4.6 閉園時刻超過チェック

- 退園時刻（閉園 or 時刻指定）を超えて到着するアトラクションを検出する。
- 超過したアトラクションがある場合、ユーザーに以下の3択ダイアログを表示:
  1. **そのまま表示**: ルートを変更せず結果を一覧表示。
  2. **低優先度のものを削除し再作成**:
     - 閉園時刻を超えるアトラクションのうち、優先度「低」のものを削除。
     - 再度距離最短アルゴリズムでルートを作り直し表示。
  3. **キャンセル**: ルート結果を表示しない。

#### 4.7 地図表示

- ルート結果に対応する地図表示を行う。
- 機能:
  - アトラクション位置にピンを表示。
  - ルート順に線を描画。
  - 表示範囲はルート全体が見えるよう自動調整。
- マーカーの見た目:
  - 優先度別に色分け。
  - ピンタップ時に
    - 順番番号
    - 名称
    - 優先度
  をポップアップで表示。

#### 4.8 休憩機能

- ルート途中に「休憩ポイント」を挿入できる。
- 機能:
  - 任意の位置に休憩を追加（もしくはルート末尾にまとめて追加）。
  - デフォルト休憩時間を指定（例: 30分）。
  - 各休憩の時間（分）を編集可能。
  - 休憩を削除可能。
- 時刻計算:
  - 休憩も1つの「ルートアイテム」として扱い、
    - 到着時刻 = 直前アイテムの出発時刻
    - 出発時刻 = 到着時刻 + 休憩時間
  - 休憩は距離・待ち時間を持たない。

#### 4.9 設定機能

- ユーザー設定項目（例）:
  - 表示言語（`ja`, `en`）
  - ルート最適化方法のデフォルト（距離最短／時間最短／選択順）
  - 結果タイトル文言（例: 「まわるじゅんばん」）
- 設定はローカルストレージ（UserDefaults 相当）へ保存し、起動時に適用。

#### 4.10 エクスポート機能

- **ルート順序をテキストとしてクリップボードにコピー**
  - 形式（例）:
    - `1. 美女と野獣“魔法のものがたり”`
    - `   09:15 到着 / 09:55 出発（待ち 20分 + 体験 20分）`
    - 空行
  - iOSのクリップボード（UIPasteboard 相当）へテキストを書き込む。
- （任意）地図イメージの共有:
  - 端末内でスクリーンショットを撮影し、共有シートから利用してもらう運用でもよい。

---

### 5. 非機能仕様（データ・ストレージ）

#### 5.1 JSONファイル配置

- アプリバンドル内に以下のJSONを同梱:
  - `attractions.json`
  - `waiting_times.json`
- JSONは読み取り専用とし、アプリからは書き換えない。

#### 5.2 アトラクションデータ `attractions.json`

- 構造（例）:

```json
[
  {
    "id": 1,                    // 内部ID（整数）
    "name": "美女と野獣“魔法のものがたり”",   // 公式名称
    "official_id": "123",       // 公式ID（文字列）
    "entrance_lat": 35.6329,    // 入り口 緯度
    "entrance_lng": 139.8804,   // 入り口 経度
    "exit_lat": 35.6330,        // 出口 緯度（任意）
    "exit_lng": 139.8805,       // 出口 経度（任意）
    "area_name": "ファンタジーランド",
    "is_active": true,          // 使用中かどうか
    "is_invalid": false         // 無効フラグ
  }
]
```

#### 5.3 待ち時間データ `waiting_times.json`

- 構造（例）:

```json
[
  {
    "attr_id": "123",              // アトラクションの official_id
    "waiting_minutes": 30,         // 最新の代表待ち時間
    "updated_at": "2025-12-03T10:00:00+09:00",
    "time_series": [
      {
        "timestamp": "2025-12-03T09:00:00+09:00",
        "waiting_minutes": 10
      },
      {
        "timestamp": "2025-12-03T10:00:00+09:00",
        "waiting_minutes": 30
      }
    ]
  }
]
```

- 利用ロジック:
  - ルート計算時に、到着予定時刻（分単位、日内0–1439）を算出。
  - `time_series` 内から「時刻が最も近い要素」を1つ選択し、その `waiting_minutes` を利用。
  - `time_series` が空の場合は `waiting_minutes` を利用。

#### 5.4 アプリ内部のデータモデル（概念）

- **Attraction**
  - `id: Int`
  - `name: String`
  - `translatedName: String?`  // 言語別表示名
  - `officialId: String?`
  - `latitude: Double`
  - `longitude: Double`
  - `areaName: String`
  - `genre: Genre`              // theater / ride / coaster / walking / greeting / other
  - `icon: String`              // 絵文字など
  - `durationMinutes: Int`      // 所要時間（分）
  - `isSeated: Bool`            // 座れる施設か
  - `waitingMinutes: Int`       // 代表待ち時間（フォールバック用）

- **RouteItem**
  - アトラクション or 休憩を表す。
  - `type: .attraction | .break`
  - `attraction: Attraction?`
  - `priority: .high | .medium | .low` (アトラクション時)
  - `breakDuration: Int?`      // 休憩時間（分）
  - `travelMinutes: Int`       // 直前地点からの移動時間（分）
  - `arrivalTimeMinutes: Int`  // 一日の分数（例: 9:30 -> 570）
  - `departureTimeMinutes: Int`
  - `waitingMinutes: Int`      // アトラクション時
  - `durationMinutes: Int`     // 体験時間 or 休憩時間

---

### 6. アルゴリズム仕様（詳細）

#### 6.1 距離計算（Haversine）

- 緯度経度から地球上の距離（メートル）を求める。
- 仕様:
  - 地球半径: `R = 6,371,000 (m)`
  - 弧の長さ `d` を Haversine 公式で算出。

#### 6.2 距離最短ルート（最近傍法）

1. `selectedAttractions` を「優先度: 高→中→低」でソート。
2. 先頭のアトラクションを出発点とする。
3. 未訪問のアトラクションの中から、現在地との距離が最も短いものを選択。
4. すべて訪問するまで3を繰り返す。

#### 6.3 時間最短ルート

1. `selectedAttractions` を「優先度: 高→中→低」でソート。
2. 初期 `currentTime = 開始時刻（分）`、`current = 最初のアトラクション`。
3. 未訪問アトラクションに対し、それぞれ:
   - 距離から `travelMinutes` を算出。
   - `arrivalTime = currentTime + travelMinutes`。
   - `arrivalTime` に最も近い `waitingMinutes` を取得。
   - `durationMinutes` を加えて「総時間 = travel + waiting + duration」を計算。
4. 総時間が最小のアトラクションを次の訪問先とし、`currentTime` と `current` を更新。
5. すべて訪問するまで3–4を繰り返す。

---

### 7. 画面仕様（概要）

#### 7.1 アトラクション選択画面

- コンポーネント:
  - ヘッダー（アプリタイトル、今日の待ち時間画面への導線があればベスト）
  - 優先度セレクタ（高／中／低）
  - アトラクションカード一覧
  - 選択済みアトラクションの簡易リスト（オプション）
  - 下部に「ルートを決める」ボタン

#### 7.2 時間設定・結果画面

- コンポーネント:
  - 開始時刻入力（時刻ピッカー）
  - 退園オプション（セグメント: 閉園まで／時刻指定）
  - 退園時刻入力（退園オプションが「時刻指定」の場合のみ有効）
  - ルート最適化方法の選択（距離／時間／選択順）
  - 「ルートを決める」ボタン
  - 結果セクション
    - 総距離・スポット数
    - ルート一覧（各行に時刻・名称・待ち時間・優先度）
    - 休憩の追加／編集UI
    - ルートコピー用ボタン

#### 7.3 地図画面

- 地図上に:
  - アトラクションのピン
  - ルートの線
  - 現在地の表示（任意・実装可能なら）

---

### 8. 設定・永続化仕様

- 保存対象:
  - 言語設定
  - ルート最適化方法
  - デフォルト開始時刻（任意）
  - 結果タイトル文言
- 永続化方法:
  - キー値ストア（UserDefaults 相当）に保存し、起動時／画面表示時に読み出す。

---

### 9. 今後の拡張余地（メモ）

- 日付別に複数の `waiting_times_YYYYMMDD.json` を同梱し、当日のファイルを自動選択する。
- 待ち時間の傾向から「おすすめ時間帯」をハイライトする。
- アトラクションの「連続で座れる／立ちっぱなし」などを考慮した快適度最適化。
- パーク切り替え（ディズニーシー対応）に備えて、パークIDを追加する。

---

この仕様書は、Web版の実装に依存しない形で、iPhoneアプリとして再実装するための機能要件・データ仕様・アルゴリズム仕様をまとめたものです。  
実装時は、ここで定義したデータモデル・アルゴリズムをベースに、UIはSwiftUIなどプラットフォーム標準コンポーネントで構成してください。


