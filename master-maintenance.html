<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ç·¨é›† - WonderPasNavi</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="diary.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FFB6C1 0%, #B0E0E6 50%, #DDA0DD 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #DDA0DD;
        }

        header h1 {
            color: #5a5a5a;
            margin-bottom: 10px;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #DDA0DD;
            text-decoration: none;
            font-weight: bold;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .master-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .master-item {
            padding: 20px;
            background: linear-gradient(135deg, #FFFACD 0%, #F0E68C 100%);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .master-item-header {
            font-weight: bold;
            margin-bottom: 15px;
            color: #5a5a5a;
            font-size: 1.1rem;
        }

        .master-item-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .master-item-field {
            display: flex;
            flex-direction: column;
        }

        .master-item-field label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .master-item-field input,
        .master-item-field select {
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
        }

        .master-item-actions {
            display: flex;
            gap: 10px;
        }

        .master-save-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #DDA0DD 0%, #EE82EE 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .master-save-btn:hover {
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="route-optimizer.html" class="back-link">â† ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
        <header>
            <h1>ğŸ“ ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±ç·¨é›†</h1>
            <p>å„ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®æ‰€è¦æ™‚é–“ã¨ã‚¸ãƒ£ãƒ³ãƒ«ã‚’è¨­å®šã§ãã¾ã™</p>
        </header>
        <div style="background: linear-gradient(135deg, #FFFACD 0%, #F0E68C 100%); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 2px solid rgba(255, 255, 255, 0.8);">
            <h2 style="color: #5a5a5a; margin-bottom: 10px; font-size: 1.2rem;">ğŸ’ ã”å”åŠ›ã®ãŠé¡˜ã„</h2>
            <p style="color: #666; line-height: 1.8; margin: 0 0 15px 0;">
                ã“ã®ã‚¢ãƒ—ãƒªã‚’ã‚ˆã‚Šä¾¿åˆ©ã«ã™ã‚‹ãŸã‚ã€<strong>ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã®æ‰€è¦æ™‚é–“</strong>ã‚’ã”å­˜çŸ¥ã®æ–¹ã¯ã€ãœã²æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼<br>
                ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã§ã”å”åŠ›ã„ãŸã ã‘ã‚‹ã¨ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚ã‚ˆã‚Šæ­£ç¢ºãªãƒ«ãƒ¼ãƒˆè¨ˆç”»ã‚’ç«‹ã¦ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<br>
                ã”å”åŠ›ã„ãŸã ã„ãŸçš†æ§˜ã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ™<br>
                <strong style="color: #DDA0DD;">â€» ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆã§ã™ã€‚ã„ãŸãšã‚‰é˜²æ­¢ã®ãŸã‚ã€ã”å”åŠ›ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</strong>
            </p>
            <div id="loginPrompt" style="text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.8); border-radius: 8px; display: none;">
                <p style="margin-bottom: 10px; color: #666;">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <a href="index.html" style="display: inline-block; padding: 8px 16px; background: linear-gradient(135deg, #DDA0DD 0%, #EE82EE 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: bold;">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</a>
                    <a href="signup.html" style="display: inline-block; padding: 8px 16px; background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: bold;">âœ¨ æ–°è¦ç™»éŒ²</a>
                </div>
            </div>
        </div>
        <div id="masterAttractionList" class="master-list">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        let attractionsMetadata = {};
        let availableAttractions = [];

        // Firestoreã‹ã‚‰ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        async function loadAttractionsMetadata() {
            try {
                const snapshot = await db.collection('attractions_metadata').get();
                attractionsMetadata = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    attractionsMetadata[data.official_id] = {
                        duration_minutes: data.duration_minutes || null,
                        genre: data.genre || ''
                    };
                });
                console.log(`${Object.keys(attractionsMetadata).length}ä»¶ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            } catch (error) {
                console.error('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        async function loadAttractions() {
            try {
                const response = await fetch('attractions.json');
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    availableAttractions = data
                        .filter(attr => attr.is_active && !attr.is_invalid && attr.entrance_lat && attr.entrance_lng)
                        .map(attr => {
                            const officialId = parseInt(attr.official_id) || null;
                            return {
                                id: attr.id,
                                name: attr.name.replace(/\s*\(ID:\s*\d+\)/g, '').trim(),
                                official_id: attr.official_id || '',
                                icon: getIcon(attr.name)
                            };
                        });
                    console.log(`${availableAttractions.length}ä»¶ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã¾ã—ãŸ`);
                }
            } catch (error) {
                console.error('ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function getIcon(name) {
            if (name.includes('ã‚·ã‚¢ã‚¿ãƒ¼') || name.includes('ã‚·ãƒ§ãƒ¼') || name.includes('ãƒ•ã‚£ãƒ«ãƒãƒ¼ãƒã‚¸ãƒƒã‚¯') || name.includes('ãƒ›ãƒ¼ãƒ«') || name.includes('ã‚¨ãƒ³ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼')) {
                return 'ğŸ­';
            } else if (name.includes('ã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼') || name.includes('ãƒã‚¦ãƒ³ãƒ†ãƒ³')) {
                return 'ğŸ¢';
            } else if (name.includes('ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥') || name.includes('æ€¥æµ')) {
                return 'ğŸ’¦';
            } else if (name.includes('ã‚¯ãƒ«ãƒ¼ã‚º') || name.includes('é‰„é“') || name.includes('ã„ã‹ã ') || name.includes('ã‚«ãƒŒãƒ¼') || name.includes('ãƒœãƒ¼ãƒˆ') || name.includes('ã‚ªãƒ ãƒ‹ãƒã‚¹') || name.includes('è’¸æ°—èˆ¹')) {
                return 'ğŸš‚';
            } else {
                return 'ğŸ¡';
            }
        }

        // Firestoreã«ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        async function saveAttractionMetadata(officialId, durationMinutes, genre) {
            // èªè¨¼çŠ¶æ…‹ã‚’å†ç¢ºèª
            const user = auth.currentUser;
            if (!user) {
                throw new Error('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
            }

            try {
                await db.collection('attractions_metadata').doc(officialId).set({
                    official_id: officialId,
                    duration_minutes: durationMinutes ? parseInt(durationMinutes) : null,
                    genre: genre || '',
                    updated_at: firebase.firestore.FieldValue.serverTimestamp(),
                    updated_by: user.email || user.uid // æ›´æ–°è€…ã®æƒ…å ±ã‚’è¨˜éŒ²ï¼ˆã„ãŸãšã‚‰é˜²æ­¢ï¼‰
                }, { merge: true });
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                attractionsMetadata[officialId] = {
                    duration_minutes: durationMinutes ? parseInt(durationMinutes) : null,
                    genre: genre || ''
                };
                
                return true;
            } catch (error) {
                console.error('ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        // ãƒã‚¹ã‚¿ãƒ¡ãƒ³ãƒ†ãƒªã‚¹ãƒˆã‚’æç”»
        async function renderMasterMaintenanceList() {
            const container = document.getElementById('masterAttractionList');
            
            if (availableAttractions.length === 0) {
                container.innerHTML = '<div class="empty-state">ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>';
                return;
            }

            // official_idã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ï¼‰
            const uniqueAttractions = {};
            availableAttractions.forEach(attr => {
                if (attr.official_id && !uniqueAttractions[attr.official_id]) {
                    uniqueAttractions[attr.official_id] = attr;
                }
            });

            if (Object.keys(uniqueAttractions).length === 0) {
                container.innerHTML = '<div class="empty-state">ç·¨é›†å¯èƒ½ãªã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            container.innerHTML = '';
            Object.values(uniqueAttractions).forEach(attr => {
                const item = document.createElement('div');
                item.className = 'master-item';
                
                const metadata = attractionsMetadata[attr.official_id] || {};
                const durationValue = metadata.duration_minutes || '';
                const genreValue = metadata.genre || '';
                
                item.innerHTML = `
                    <div class="master-item-header">${attr.icon || 'ğŸ¡'} ${attr.name}</div>
                    <div class="master-item-fields">
                        <div class="master-item-field">
                            <label>æ‰€è¦æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                            <input type="number" id="duration_${attr.official_id}" value="${durationValue}" min="0" placeholder="ä¾‹: 5">
                        </div>
                        <div class="master-item-field">
                            <label>ã‚¸ãƒ£ãƒ³ãƒ«</label>
                            <select id="genre_${attr.official_id}">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„...</option>
                                <option value="theater" ${genreValue === 'theater' ? 'selected' : ''}>åº§ã‚Œã‚‹ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå±‹å†…ã‚·ã‚¢ã‚¿ãƒ¼å‹ï¼‰</option>
                                <option value="indoor_ride" ${genreValue === 'indoor_ride' ? 'selected' : ''}>å®¤å†…ãƒ©ã‚¤ãƒ‰</option>
                                <option value="outdoor_ride" ${genreValue === 'outdoor_ride' ? 'selected' : ''}>èˆ¹ãƒ»é›»è»Šãªã©å±‹å¤–ãƒ©ã‚¤ãƒ‰</option>
                                <option value="coaster" ${genreValue === 'coaster' ? 'selected' : ''}>ã‚¸ã‚§ãƒƒãƒˆã‚³ãƒ¼ã‚¹ã‚¿ãƒ¼</option>
                                <option value="water_ride" ${genreValue === 'water_ride' ? 'selected' : ''}>æ€¥æµã™ã¹ã‚Š</option>
                                <option value="other" ${genreValue === 'other' ? 'selected' : ''}>ãã®ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div class="master-item-actions">
                        <button class="master-save-btn" onclick="saveAttractionMetadataItem('${attr.official_id}')">ğŸ’¾ ä¿å­˜</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // å€‹åˆ¥ã®ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        async function saveAttractionMetadataItem(officialId) {
            const durationInput = document.getElementById(`duration_${officialId}`);
            const genreSelect = document.getElementById(`genre_${officialId}`);
            
            const durationMinutes = durationInput.value.trim();
            const genre = genreSelect.value;
            
            try {
                await saveAttractionMetadata(officialId, durationMinutes, genre);
                // ä¿å­˜æˆåŠŸæ™‚ã®æ„Ÿè¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                const attrName = availableAttractions.find(a => a.official_id === officialId)?.name || 'ã‚¢ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³';
                alert(`ğŸ’ ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\nã€Œ${attrName}ã€ã®æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\nä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ«ãƒ¼ãƒˆè¨ˆç”»ã«å½¹ç«‹ã¡ã¾ã™ï¼`);
            } catch (error) {
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // èªè¨¼ãƒã‚§ãƒƒã‚¯ã¨åˆæœŸåŒ–
        async function initializePage() {
            // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
            let initialized = false;
            auth.onAuthStateChanged(async (user) => {
                if (initialized) return; // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                
                if (!user) {
                    // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    const loginPrompt = document.getElementById('loginPrompt');
                    if (loginPrompt) {
                        loginPrompt.style.display = 'block';
                    }
                    // æˆ»ã‚Šå…ˆã‚’è¨˜éŒ²
                    sessionStorage.setItem('redirectAfterLogin', 'master-maintenance.html');
                    return;
                }

                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯åˆæœŸåŒ–
                initialized = true;
                console.log('èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.email);
                const loginPrompt = document.getElementById('loginPrompt');
                if (loginPrompt) {
                    loginPrompt.style.display = 'none';
                }
                await loadData();
            });
        }

        async function loadData() {
            try {
                await loadAttractionsMetadata();
                await loadAttractions();
                await renderMasterMaintenanceList();
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('masterAttractionList').innerHTML = 
                    '<div class="empty-state">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div>';
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        initializePage();
    </script>
</body>
</html>

