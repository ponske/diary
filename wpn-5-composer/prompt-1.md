
react native（expo）を使用してディズニーランドの1日の過ごし方のシミュレーションアプリを作成してください。

##WonderPasNavi スマホアプリ for ios 仕様書

アプリの制作前にweb版でデモサイトを作りました。
基本的にこのウェブアプリをスマホアプリにconvertする方針です。

デモ版をwebアプリとして下記にて公開中
https://pastel-dairy-notebook.web.app/route-optimizer.html
ソースコードは下記にて公開中
https://github.com/ponske/diary/blob/main/route-optimizer.html

### 1.概要
I
- **アプリ名**：WonderPasNavi
- **対象プラットフォーム**：ios（iPhone）
- **想定ユーザー＊＊：東京ディズニーランドを効率よく回りたいゲスト/遠方から訪れるなどで1回の訪問価値を最大化したいゲスト/実際に訪れることなく妄想して楽しみたいユーザー
- **目的**：ユーザーが行きたいアトラクション・グリーティング・レストラン・ショーを選ぶと、考慮した「最適化手法」（最短距離ルート/遺伝アルゴリズムを使った時間効率最大ルート/（可変訪問希望地点数が10以下の場合のみ）全探索の3つから選択可能）を複数の手段から選ぶと、移動距離や待ち時間・所要時間を考慮した「最適な回る順番」と各アトラクションの到着/出発時間を提示し、ユーザーはどのタイミングで待ち時間が長く発生し一息付けるかの予測が立ち一日中そわそわせずに訪問価値を高められる
- **ネットワーク前提**：アプリから外部データソースには接続しない。必要なデータはアプリ内に同梱したjsonファイルを読み取り専用で利用する。
---
### 2.前提・非機能要件
-- **オフライン前提**
 - ネットワーク接続がなくても全機能が動作する
 - 待ち時間データ・地点情報はアプリバンドル内のjsonとして同梱
-- **パフォーマンス**
 - あえて制限を設けない（ユーザーがスマホを触る時、あまりに機械のレスポンスが速いと考えるスピードに合わずリズムが狂うため）


-- **データ更新**
 - 待ち時間データ/地点データの更新は「アプリのアップデート」により行う
-- **永続化**
 - ユーザー設定は端末ローカルに保存
 - 個人情報やログイン情報は持たない（次回大幅アップデートでログイン機能を追加必須でしたい）
---
### 3.用語集
- **優先度**：各アトラクションに対してユーザーが設定する重要度
---
### 4.機能要件
#### 4.1 アプリ起動・初期化

- アプリ起動時に以下を実行する:
  - `attractions.json` を読み込み、アトラクション一覧を構築。
  - `waiting_times.json` を読み込み、待ち時間データを構築。
  - ユーザー設定（言語、ルート最適化方法、表示設定など）をローカルから読み出し適用。

#### 4.2 アトラクション一覧表示・選択

- ユーザーは「アトラクション一覧画面」でアトラクションをカード形式で閲覧・選択できる。
- 機能:
  - 検索／フィルタ（任意: エリア、ジャンル、アイコンなど）。
  - アトラクションカードをタップして「選択／解除」。
  - 選択済みアトラクションには
    - 選択順の番号（解除した場合は、番号が下がり、常に選択済みのカードに振られた番号で抜けがない。）
    - 優先度（高／中／低）によってカードの色が変化する。
  を表示。
  - プライオリティシーティングで予約済みのレストランの時刻を含め、入力できる。
  - PS対象レストランはプルダウンリストから表示できる。
  - 休憩時間を入力
- 優先度:
  - 「高」「中」「低」ボタンのいずれかを選んだ状態でアトラクションを選択すると、その優先度が紐づく。
  - 優先度はルート最適化時の並び順に影響する（高 → 中 → 低の順で優先）。

#### 4.3 時間設定

- **開始時刻**
  - デフォルト: **09:00**
  - 入力可能範囲: **09:00 – 21:00**
  - 不正値（範囲外）の場合は自動的に許容範囲内に補正。

- **退園時刻**
  - オプション1: 「閉園まで」（固定で 21:00）
  - オプション2: 「時刻指定」
    - 入力可能範囲: **10:00 – 21:00**
  - 不正値は補正し、開始時刻よりも早い退園時刻が入力された場合はエラー表示。

#### 4.4 ルート最適化

- ユーザーが2つ以上のアトラクションを選択し、「ルートを決める」を実行するとルート最適化を行う。
- 最適化方法は3種類:
 - 最短距離ルート
 - 遺伝アルゴリズムを使った時間効率最大ルート/（「可変訪問希望地点」数が10以下の場合のみ）全探索の3つから選択可能
- 全探索を行う場合は、真の最短時間ルートと真の移動距離最小ルートが算出可能

- 可変訪問希望地点の定義
 - 下記2つに当てはまらない訪問対象施設のこと
 - プライオリティシーティングで予約済みのレストラン
 - DPAを使用して鑑賞予定のショーorショーレストラン

- 歩行速度:
  - 分速 80m をデフォルトとする。（デフォルトの他、ユーザー設定にて車椅子移動速度と早歩きに変更可能）
  - 距離から移動時間（分）を算出し、小数点は切り上げ。

#### 4.5 ルート結果表示

- 結果画面では以下を表示する:
  - 各アトラクションについて:
    - 順番番号
    - 名称（現在の言語に応じた表示）
    - 到着時刻
    - 出発時刻
    - 待ち時間（分）（参考としたデータの日時（waiting-times.jsonのtimestampの日時時分まで）を必ず表示する）
    - 体験時間（分）
    - 優先度
- 移動時間と時刻計算:
  - 初期 `currentTime = 開始時刻(分単位)`。
  - 各アトラクション:
    - 前の地点から距離を計算し、`travelMinutes = ceil(distance / 80)`。
    - 到着時刻 = `currentTime + travelMinutes`。
    - `arrivalTime` に最も近い待ち時間を取得。
    - 出発時刻 = `arrivalTime + waiting + duration`。
    - 次の `currentTime` = 出発時刻。
- 疲労度グラフ
 - HPの増減が可視化できるグラフが表示される(競合との差分機能になるので強化)
 - MPが上がるアトラクションやショーを地点によって登録し（将来的にはユーザーごとに学習し）、MPのグラフも表現する

#### 4.6 閉園時刻超過チェック

- 退園時刻（閉園 or 時刻指定）を超えて到着するアトラクションを検出する。
- 超過したアトラクションがある場合、ユーザーに以下の3択ダイアログを表示:
  1. **そのまま表示**: ルートを変更せず結果を一覧表示。
  2. **低優先度のものを削除し再作成**:
     - 閉園時刻を超えるアトラクションのうち、優先度「低」のものを削除。
     - どれを削除するのかをユーザーに選択させるのか、ルートの早い時間から低い優先度の地点を1つ削除しルート再計算し最終地点への到着時刻が閉園（or退園）時刻をすぎなくなるまで繰り返し、退園時刻を超えないルートが存在した時点で再作成を終了する
     - 再度、他のアルゴリズムの選択肢をユーザーに確認し、ユーザーが選択したルートを作り直し表示する。
  3. **キャンセル**: ルート結果を表示しない。ユーザーがカスタムで訪問地点の見直しを行いたい場合これを選ぶことになるだろう。

#### 4.7 地図表示

- ルート結果に対応する地図表示を行う。
- 機能:
  - アトラクション位置にピンを表示。（ピンは赤色以外でフロントデザインに則った色もしくは星型のアイコンやコーヒーカップなど適切なものを使用）
  - ルート順に線を描画。
  - 表示範囲はルート全体が見えるよう自動調整。
  - スタート地点を目立たせる
  - 初回読み込み時は、ユーザーがたどる順に、ルートを表す線の長さが0から漸近的に伸びていく様を動的に表示させる（シミュレータとして楽しむ場合、この機能が一番ユーザー体験満足度が上がるので重要）
  - 地図のスクリーンショットをボタン1タップで保存する。
- マーカーの見た目:
  - 優先度別に色分け。
  - ピンタップ時に
    - 順番番号（重要）
    - 名称
    - 優先度
  をポップアップで表示。ポップアップはタップで表示/非表示が切り替えられるように

#### 4.8 休憩機能

- ルート途中に「休憩ポイント」を挿入できる。
- 機能:
  - 任意の位置に休憩を追加。
  - デフォルト休憩時間を指定（例: 30分）。
  - 各休憩の時間（分）を編集可能。
  - 休憩を削除可能。
  - ドラッグで休憩位置を移動可能。自動再計算が実行される。
- 時刻計算:
  - 休憩も1つの「ルートアイテム」として扱い、
    - 到着時刻 = 直前アイテムの出発時刻
    - 出発時刻 = 到着時刻 + 休憩時間
  - 休憩は距離・待ち時間を持たない。

#### 4.9 設定機能

- ユーザー設定項目（例）:
  - 表示言語（`ja`, `en`）
  - ルート最適化方法のデフォルト（距離最短／時間最短／選択順/全探索の中で優先順位をつけられる）
  - 結果タイトル文言（例: 「まわるじゅんばん」）
- 設定はローカルストレージ（UserDefaults 相当）へ保存し、起動時に適用。

#### 4.10 エクスポート機能

- **ルート順序をテキストとしてクリップボードにコピー**
  - 形式（例）:
    - `1. 美女と野獣“魔法のものがたり”`
    - `   09:15 到着 / 09:55 出発（待ち 20分 + 体験 20分）`
    - 空行
  - iOSのクリップボード（UIPasteboard 相当）へテキストを書き込む。
  - 形式は詳細版と簡易版（周る順序のみ）とSNS版の3パターンで作成できる

- **（必須）地図イメージの共有**
  - 端末内でスクリーンショットを撮影し、共有シートから利用してもらう運用でもよい。

- LINEなどのSNSでグループで共有できるようにする
- Instagramなどでこのルートで回ったという投稿ができるようにする


---
### 5. 非機能仕様（データ・ストレージ）

#### 5.1 JSONファイル配置

- アプリバンドル内に以下のJSONを同梱:
  - `attractions.json`
  - `waiting_times.json`
- JSONは読み取り専用とし、アプリからは書き換えない。

#### 5.2 訪問地点データ `attractions.json`

- 構造（例）:

```json
[
  {
    "id": 1,                    // 内部ID（整数）
    "name": "美女と野獣“魔法のものがたり”",   // 公式名称
    "official_id": "123",       // 公式ID（文字列）
    "entrance_lat": 35.6329,    // 入り口 緯度
    "entrance_lng": 139.8804,   // 入り口 経度
    "exit_lat": 35.6330,        // 出口 緯度（任意）
    "exit_lng": 139.8805,       // 出口 経度（任意）
    "area_name": "ファンタジーランド",
    "is_active": true,          // 使用中かどうか
    "is_invalid": false         // 無効フラグ
  }
]
```

#### 5.3 待ち時間データ `waiting_times.json`

- 構造（例）:

```json
[
  {
    "attr_id": "123",              // アトラクションの official_id
    "waiting_minutes": 30,         // 最新の代表待ち時間
    "updated_at": "2025-12-03T10:00:00+09:00",
    "time_series": [
      {
        "timestamp": "2025-12-03T09:00:00+09:00",
        "waiting_minutes": 10
      },
      {
        "timestamp": "2025-12-03T10:00:00+09:00",
        "waiting_minutes": 30
      }
    ]
  }
]
```

- 利用ロジック:
  - ルート計算時に、到着予定時刻（分単位、日内0–1439）を算出。
  - `time_series` 内から「時刻が最も近い要素」を1つ選択し、その `waiting_minutes` を利用。
  - `time_series` が空の場合は `waiting_minutes` を利用。

#### 5.4 アプリ内部のデータモデル（概念）

- **Attraction**
  - `id: Int`
  - `name: String`
  - `translatedName: String?`  // 言語別表示名
  - `officialId: String?`
  - `latitude: Double`
  - `longitude: Double`
  - `areaName: String`
  - `genre: Genre`              // theater / ride / coaster / walking / greeting / other
  - `icon: String`              // 絵文字など
  - `durationMinutes: Int`      // 所要時間（分）
  - `isSeated: Bool`            // 座れる施設か
  - `waitingMinutes: Int`       // 代表待ち時間（フォールバック用）

- **RouteItem**
  - アトラクション or 休憩を表す。
  - `type: .attraction | .break`
  - `attraction: Attraction?`
  - `priority: .high | .medium | .low` (アトラクション時)
  - `breakDuration: Int?`      // 休憩時間（分）
  - `travelMinutes: Int`       // 直前地点からの移動時間（分）
  - `arrivalTimeMinutes: Int`  // 一日の分数（例: 9:30 -> 570）
  - `departureTimeMinutes: Int`
  - `waitingMinutes: Int`      // アトラクション時
  - `durationMinutes: Int`     // 体験時間 or 休憩時間

---

### 6. アルゴリズム仕様（詳細）

#### 6.1 距離計算（Haversine）

- 緯度経度から地球上の距離（メートル）を求める。
- 仕様:
  - 地球半径: `R = 6,371,000 (m)`
  - 弧の長さ `d` を Haversine 公式で算出。

#### 6.2 距離最短ルート（最近傍法）

1. `selectedAttractions` を「優先度: 高→中→低」でソート。
2. パークの入り口に最も近い訪問地点を出発点とする。
3. 未訪問のアトラクションの中から、現在地との距離が最も短いものを選択。
4. すべて訪問するまで3を繰り返す。

#### 6.3 時間最短ルート

1. `selectedAttractions` を「優先度: 高→中→低」でソート。
2. 初期 `currentTime = 開始時刻（分）`、`current = 最初のアトラクション`。
3. 未訪問アトラクションに対し、それぞれ:
   - 距離から `travelMinutes` を算出。
   - `arrivalTime = currentTime + travelMinutes`。
   - `arrivalTime` に最も近い `waitingMinutes` を取得。
   - `durationMinutes` を加えて「総時間 = travel + waiting + duration」を計算。
4. 総時間が最小のアトラクションを次の訪問先とし、`currentTime` と `current` を更新。
5. すべて訪問するまで3–4を繰り返す。
6. 総地点数が10以下の場合、全探索で10!通りのルートを計算し、最小となる総所要時間をlen関数で見つけ、ユーザーに返す。プログレスバーに進行状況を表示する。処理を中断するボタンを表示する。

#### 6.4 ユーザー入力順ルート
1. 文字通り、ユーザーが選択した順序で移動する。待ち時間と移動時間を計算しユーザーに返す。

---

### 7. 画面仕様（概要）

#### 7.1 アトラクション（つまり訪問地点としてはレストランやグリーティング施設、シアターやパレード鑑賞地点を含む）選択画面

- コンポーネント:
  - ヘッダー（アプリタイトル、今日の待ち時間画面への導線があればベスト）
  - 優先度セレクタ（高／中／低）
  - アトラクションカード一覧
  - 選択済みアトラクションの簡易リスト（オプション）
  - 下部に「ルートを決める」ボタン
  - 将来的に、参考にする待ち時間データの日にちを直近1週間で選択できるようにする

#### 7.2 時間設定・結果画面

- コンポーネント:
  - 開始時刻入力（時刻ピッカー）
  - 退園オプション（セグメント: 閉園まで／時刻指定）
  - 退園時刻入力（退園オプションが「時刻指定」の場合のみ有効）
  - ルート最適化方法の選択（距離／時間／選択順）
  - 「ルートを決める」ボタン
  - 結果セクション
    - 総距離・スポット数
    - ルート一覧（各行に時刻・名称・待ち時間・優先度）
    - 休憩の追加／編集UI
    - ルートコピー用ボタン
  - 結果画面で休憩を追加できる
    - 休憩を追加した場合、待ち時間の取得を再度自動で計算する

#### 7.3 地図画面

- 地図上に:
  - アトラクションのピン
  - ルートの線（初回表示時は漸近的に伸びる）
  - 現在地の表示（任意・実装可能なら）

#### 7.4 ルート探索中
- スピナーが表示される。魔法をイメージしたキラキラのスピナーである。
- 10地点以下を選択して全探索（総当たり）アルゴリズムを実行する際に、計算中であることを視覚的に分かりやすく伝えるため、ユーザーに分かりやすく楽しい待機体験を提供するため、キラキラするアニメーション付きスピナーを実装
- 全探索の場合、処理の進行をプログレスバーで表示する

---

### 8. 設定・永続化仕様

- 保存対象:
  - 言語設定
  - ルート最適化方法
  - デフォルト開始時刻（任意）
  - 結果タイトル文言
- 永続化方法:
  - キー値ストア（UserDefaults 相当）に保存し、起動時／画面表示時に読み出す。

---

### 9. 今後の拡張余地（メモ）

- 日付別に複数の `waiting_times_YYYYMMDD.json` を同梱し、当日のファイルを自動選択する。
- 待ち時間の傾向から「おすすめ時間帯」をハイライトする。
- アトラクションの「連続で座れる／立ちっぱなし」などを考慮した快適度最適化。
- パーク切り替え（ディズニーシー対応）に備えて、パークIDを追加する。

---

この仕様書は、Web版の実装に依存しない形で、iPhoneアプリとして再実装するための機能要件・データ仕様・アルゴリズム仕様をまとめたものです。  
実装時は、ここで定義したデータモデル・アルゴリズムをベースに、UIはSwiftUIなどプラットフォーム標準コンポーネントで構成してください。

---

